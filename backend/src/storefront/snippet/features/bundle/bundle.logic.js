module.exports = [
  "function log() {if (!debug) return;try {console.log.apply(console, arguments);} catch (e) {} } function warn() {if (!debug) return;try {console.warn.apply(console, arguments);} catch (e) {} } function getBackendOrigin() {try {return new URL(scriptSrc).origin;} catch (e) {return \"\";} } async function fetchJson(url, opts) {var r = await fetch(url, opts);var t = await r.text();var j = null;try {j = t ? JSON.parse(t) : null;} catch (e) {throw new Error(\"Invalid JSON response\");} if (!r.ok) {var msg ",
  "= (j && j.message) || (\"HTTP \" + r.status);var err = new Error(msg);err.status = r.status;err.details = j;throw err;} return j;} function buildUrl(path, params) {var origin = getBackendOrigin();if (!origin) return null;var u = new URL(origin + path);for (var k in (params || {})) {if (!Object.prototype.hasOwnProperty.call(params, k)) continue;var v = params[k];if (v == null || v === \"\") continue;u.searchParams.set(k, String(v));} u.searchParams.set(\"merchantId\", merchantId);u.searchParams.set(\"to",
  "ken\", token);return u.toString();} async function getProductBundlesByVariantId(variantId) {var v = String(variantId || \"\").trim();if (!v) return null;var u = buildUrl(\"/api/proxy/bundles/product\", {variantId: v });if (!u) return null;return fetchJson(u);} async function getProductBundlesByProductId(productId) {var p = String(productId || \"\").trim();if (!p) return null;var u = buildUrl(\"/api/proxy/bundles/for-product\", {productId: p });if (!u) return null;return fetchJson(u);} async function requ",
  "estApplyBundle(bundleId, items) {var payload = {bundleId: String(bundleId || \"\"), items: Array.isArray(items) ? items : [] };var u = buildUrl(\"/api/proxy/bundles/apply\", {});if (!u) return null;return fetchJson(u, {method: \"POST\", headers: {\"Content-Type\": \"application/json\" }, body: JSON.stringify(payload) });} async function getProductVariantsByProductId(productId) {var p = String(productId || \"\").trim();if (!p) return null;var u = buildUrl(\"/api/proxy/products/variants\", {productId: p });if (",
  "!u) return null;return fetchJson(u);} function isProductRef(variantId) {return String(variantId || \"\").trim().indexOf(\"product:\") === 0;} var variantsCacheByProductId = {};var variantsPendingByProductId = {};async function getCachedVariants(productId) {var pid = String(productId || \"\").trim();if (!pid) return [];if (Object.prototype.hasOwnProperty.call(variantsCacheByProductId, pid)) return variantsCacheByProductId[pid] || [];var pend = variantsPendingByProductId[pid];if (pend && pend.then) retu",
  "rn pend;var p = (async function () {try {var res = await getProductVariantsByProductId(pid);var vars = (res && res.variants) || [];variantsCacheByProductId[pid] = Array.isArray(vars) ? vars : [];return variantsCacheByProductId[pid];} finally {try {delete variantsPendingByProductId[pid];} catch (e) {variantsPendingByProductId[pid] = null;} } })();variantsPendingByProductId[pid] = p;return p;} function stringifyAttrs(attrs) {try {if (!attrs || typeof attrs !== \"object\") return \"\";var parts = [];fo",
  "r (var k in attrs) {if (!Object.prototype.hasOwnProperty.call(attrs, k)) continue;var key = String(k || \"\").trim();var v = attrs[k];if (v == null) continue;var vs = String(v || \"\").trim();if (!vs) continue;parts.push((key ? key + \": \" : \"\") + vs);} return parts.join(\" • \");} catch (e) {return \"\";} } function variantLabel(v) {var id = String(v && v.variantId || \"\").trim();var name = String(v && v.name || \"\").trim();var attrs = stringifyAttrs(v && v.attributes);var price = v && v.price != null ? N",
  "umber(v.price) : null;var priceText = Number.isFinite(price) && price >= 0 ? fmtMoney(price) : \"\";var base = \"\";if (attrs && name) base = name + \" • \" + attrs;else if (attrs) base = attrs;else if (name) base = name;else if (id) base = id;else base = \"\";if (base && priceText) return base + \" • \" + priceText;if (base) return base;if (priceText) return priceText;return \"—\";} function normHex(s) {try {var x = String(s || \"\").trim();if (!x) return \"\";var m = x.match(/^#?([0-9a-fA-F]{3}|[0-9a-fA-F]{6}",
  ")$/);if (!m) return \"\";return x.charAt(0) === \"#\" ? x : \"#\" + x;} catch (e) {return \"\";} } function escCssUrl(u) {try {var s = String(u || \"\").trim();if (!s) return \"\";s = s.replace(/[\\n\\r\\t\\f\\\\\"'()<>]/g, \"\");return s;} catch (e) {return \"\";} } function pickVariantSwatch(v) {try {var img = String(v && v.imageUrl || \"\").trim();if (img) return {t: \"img\", v: img };var attrs = v && v.attributes && typeof v.attributes === \"object\" ? v.attributes : null;if (attrs) {for (var k in attrs) {if (!Object.pr",
  "ototype.hasOwnProperty.call(attrs, k)) continue;var hex = normHex(attrs[k]);if (hex) return {t: \"hex\", v: hex };} } var hex2 = normHex(v && v.name);if (hex2) return {t: \"hex\", v: hex2 };return null;} catch (e) {return null;} } function variantOptionInnerHtml(v) {var sw = pickVariantSwatch(v);var out = \"\";if (sw && sw.t === \"img\") {var u = escCssUrl(sw.v);if (u) {out += '<span class=\"bundle-app-variant-swatch is-image\" style=\"background-image:url(\\'' + escHtml(u) + '\\')\"></span>';} } else if (sw ",
  "&& sw.t === \"hex\" && sw.v) {out += '<span class=\"bundle-app-variant-swatch\" style=\"background:' + escHtml(sw.v) + '\"></span>';} out += '<span class=\"bundle-app-variant-text\">' + escHtml(variantLabel(v)) + '</span>';return out;} var selectedBundleId = null;var lastTriggerProductId = null;var messageByBundleId = {};var selectedTierByBundleId = {};var applying = false;var variantSelectionsByBundleId = {};var postAddShownByBundleId = {};var variantPickerCacheByBundleId = {};var variantPickerPendingB",
  "yBundleId = {};function getBundleVariantSelectionMap(bundleId) {var bid = String(bundleId || \"\").trim();if (!bid) return null;var m = variantSelectionsByBundleId[bid];if (!m || typeof m !== \"object\") m = {};variantSelectionsByBundleId[bid] = m;return m;} function bundleVariantSig(bundle) {try {var items = normalizeItems(bundle);var parts = [];for (var i = 0;i < items.length;i++) {var it = items[i] || {};var v = String(it.variantId || \"\").trim();if (!isProductRef(v)) continue;var pid = String(it.",
  "productId || \"\").trim();if (!pid) continue;var qty = Math.max(1, Math.floor(Number(it.quantity || 1)));parts.push(pid + \"x\" + qty);} parts.sort();return parts.join(\"|\");} catch (e) {return \"\";} } function bundleVariantUnits(bundle) {var items = normalizeItems(bundle);var units = [];for (var i = 0;i < items.length;i++) {var it = items[i] || {};var v = String(it.variantId || \"\").trim();if (!isProductRef(v)) continue;var pid = String(it.productId || \"\").trim();if (!pid) continue;var qty = Math.max(",
  "1, Math.floor(Number(it.quantity || 1)));for (var u = 0;u < qty;u++) {units.push({productId: pid, key: pid + \":\" + u });} } return units;} function pruneBundleSelections(sel, units) {try {if (!sel || typeof sel !== \"object\") return;var keep = {};for (var i = 0;i < units.length;i++) {keep[String(units[i] && units[i].key || \"\")] = true;} for (var k in sel) {if (!Object.prototype.hasOwnProperty.call(sel, k)) continue;if (!keep[k]) {try {delete sel[k];} catch (e) {sel[k] = null;} } } } catch (e) {} ",
  "} function escHtml(input) {var s = String(input == null ? \"\" : input);return s.replace(/[&<>\"']/g, function (ch) {return ch === \"&\" ? \"&amp;\" : ch === \"<\" ? \"&lt;\" : ch === \">\" ? \"&gt;\" : ch === '\"' ? \"&quot;\" : \"&#39;\";});} function fmtNum(n) {var x = Number(n);if (!Number.isFinite(x)) return \"—\";try {return x.toLocaleString(\"ar-SA\");} catch (e) {return String(x);} } function fmtMoney(n) {var x = Number(n);if (!Number.isFinite(x)) return \"—\";var v = Math.round(x * 100) / 100;var s;try {s = v.to",
  "LocaleString(\"ar-SA\", {minimumFractionDigits: v % 1 ? 2 : 0, maximumFractionDigits: 2 });} catch (e) {s = String(v);} return s + \" ر.س\";} function normalizeTitle(raw) {var title = String(raw || \"\");if (!title || title === \"Bundle\") title = \"باقة\";try {title = title.replace(/^Bundle\\s*-\\s*/i, \"باقة - \");} catch (e) {} return title;} function minRequiredBaseQty(bundle) {return 1;} function normalizeItems(bundle) {var comps = (bundle && bundle.components) || [];if (!Array.isArray(comps) || !comps.l",
  "ength) {comps = (bundle && bundle.bundleItems) || [];} var out = [];var baseMin = minRequiredBaseQty(bundle);for (var i = 0;i < comps.length;i++) {var c = comps[i] || {};var v = String(c.variantId || \"\").trim();var pid = String(c.productId || \"\").trim();var isBase = Boolean(c.isBase);var q = isBase ? Math.max(getPageQty(), baseMin) : Math.max(1, Math.floor(Number(c.quantity || 1)));if (!v) continue;out.push({variantId: v, productId: pid || null, quantity: q, isBase: isBase });} out.sort(function",
  " (a, b) {return String(a.variantId).localeCompare(String(b.variantId));});return out;} function buildItemsText(items) {var products = 0;var totalQty = 0;for (var i = 0;i < items.length;i++) {var it = items[i] || {};if (!it.variantId) continue;products++;totalQty += Math.max(1, Math.floor(Number(it.quantity || 1)));} return \"عدد المنتجات: \" + fmtNum(products) + \" • إجمالي القطع: \" + fmtNum(totalQty);} function buildPriceText(bundle) {var p = bundle && bundle.pricing && bundle.pricing.base;if (!p)",
  " return \"\";var o = Number(p.originalTotal), f = Number(p.finalTotal), d = Number(p.discountAmount);if (!Number.isFinite(o) || !Number.isFinite(f)) return \"\";var s = \"قبل \" + fmtMoney(o) + \" • بعد \" + fmtMoney(f);if (Number.isFinite(d) && d > 0) s += \" • وفّرت \" + fmtMoney(d);return s;} function selectionKey(triggerProductId) {return \"bundle_app_selected_bundle:\" + String(merchantId || \"\") + \":\" + String(triggerProductId || \"\");} function pendingKey(triggerProductId) {return \"bundle_app_pending_c",
  "oupon:\" + String(merchantId || \"\") + \":\" + String(triggerProductId || \"\");} function loadSelection(triggerProductId) {try {var raw = localStorage.getItem(selectionKey(triggerProductId));if (!raw) return null;var j = JSON.parse(raw);return j && typeof j === \"object\" ? j : null;} catch (e) {return null;} } function saveSelection(triggerProductId, data) {try {localStorage.setItem(selectionKey(triggerProductId), JSON.stringify(data || {}));} catch (e) {} } function clearSelection(triggerProductId) {",
  "try {localStorage.removeItem(selectionKey(triggerProductId));} catch (e) {} } function savePendingCoupon(triggerProductId, data) {try {localStorage.setItem(pendingKey(triggerProductId), JSON.stringify(data || {}));} catch (e) {} } function loadPendingCoupon(triggerProductId) {try {var raw = localStorage.getItem(pendingKey(triggerProductId));if (!raw) return null;var j = JSON.parse(raw);return j && typeof j === \"object\" ? j : null;} catch (e) {return null;} } function clearPendingCoupon(triggerPr",
  "oductId) {try {localStorage.removeItem(pendingKey(triggerProductId));} catch (e) {} } function isCartLikePage() {try {var p = String(window.location.pathname || \"\").toLowerCase();return p.indexOf(\"cart\") !== -1 || p.indexOf(\"checkout\") !== -1;} catch (e) {return false;} } async function tryApplyCoupon(code) {var c = String(code || \"\").trim();if (!c) return false;if (storeClosedNow()) return false;function sleep(ms) {return new Promise(function (r) {setTimeout(function () {r();}, ms);});} for (va",
  "r attempt = 0;attempt < 3;attempt++) {try {var cart = window.salla && window.salla.cart;var applied = false;if (cart && typeof cart.applyCoupon === \"function\") {await cart.applyCoupon(c);applied = true;} else if (cart && cart.coupon && typeof cart.coupon.apply === \"function\") {await cart.coupon.apply(c);applied = true;} else if (cart && cart.coupon && typeof cart.coupon.set === \"function\") {await cart.coupon.set(c);applied = true;} else if (cart && typeof cart.setCoupon === \"function\") {await ca",
  "rt.setCoupon(c);applied = true;} else if (cart && typeof cart.addCoupon === \"function\") {await cart.addCoupon(c);applied = true;} else if (window.salla && typeof window.salla.applyCoupon === \"function\") {await window.salla.applyCoupon(c);applied = true;} else if (window.salla && window.salla.coupon && typeof window.salla.coupon.apply === \"function\") {await window.salla.coupon.apply(c);applied = true;} if (applied) {try {g.BundleApp._lastCouponApplyStatus = null;g.BundleApp._lastCouponApplyMessag",
  "e = \"\";} catch (x0) {} return true;} } catch (e) {var st = extractHttpStatus(e);var msg = extractHttpMessage(e);try {g.BundleApp._lastCouponApplyStatus = st;g.BundleApp._lastCouponApplyMessage = String(msg || \"\");} catch (x1) {} markStoreClosed({status: st, message: msg });if (storeClosedNow()) return false;warn(\"bundle-app: coupon apply failed\", e && (e.details || e.message || e));} await sleep(250 + attempt * 250);} return false;} function extractHttpStatus(e) {try {var s = (e && ((e.statusCod",
  "e != null && e.statusCode) || (e.status != null && e.status) || (e.response && e.response.status) || (e.request && e.request.status))) || null;var n = Number(s);return Number.isFinite(n) ? n : null;} catch (x) {return null;} } function extractHttpMessage(e) {try {var m = \"\";if (e && e.details && typeof e.details === \"object\") {m = String(e.details.message || e.details.error || e.details.title || \"\").trim();if (!m && e.details.data && typeof e.details.data === \"object\") m = String(e.details.data.",
  "message || e.details.data.error || e.details.data.title || \"\").trim();} if (!m && e && e.response && e.response.data != null) {var d = e.response.data;if (typeof d === \"string\") {m = String(d || \"\").trim();} else if (typeof d === \"object\") {m = String(d.message || d.error || d.title || \"\").trim();if (!m && d.data && typeof d.data === \"object\") m = String(d.data.message || d.data.error || d.data.title || \"\").trim();} } if (!m && e) {m = String(e.message || \"\").trim();} return m;} catch (x) {retur",
  "n \"\";} } function storeClosedNow() {try {var until = Number(g.BundleApp && g.BundleApp._storeClosedUntil || 0);return Number.isFinite(until) && until > Date.now();} catch (e) {return false;} } function markStoreClosed(e) {try {var st = extractHttpStatus(e);var msg = extractHttpMessage(e);var m = String(msg || \"\");var ml = m.toLowerCase();var isClosed = Boolean(m.indexOf(\"المتجر مغلق\") !== -1 || m.indexOf(\"المتجر مغلق حالياً\") !== -1 || m.indexOf(\"المتجر مغلق حاليا\") !== -1 || ml.indexOf(\"store i",
  "s closed\") !== -1 || (ml.indexOf(\"closed\") !== -1 && ml.indexOf(\"store\") !== -1));if (!isClosed && Number(st) === 410) {isClosed = Boolean(m.indexOf(\"مغلق\") !== -1 || ml.indexOf(\"closed\") !== -1);} if (isClosed) {g.BundleApp._storeClosedUntil = Date.now() + 60000;} } catch (x) {} } function humanizeCartError(e) {try {var st = extractHttpStatus(e);var msg = extractHttpMessage(e);if (Number(st) === 410) {var m = String(msg || \"\").toLowerCase();if (m.indexOf(\"مغلق\") !== -1) return \"المتجر مغلق\";if ",
  "(m.indexOf(\"closed\") !== -1) return \"المتجر مغلق\";} if (Number(st) === 429) return \"تم حظرك مؤقتاً\";if (Number(st) === 404) return \"المنتج غير موجود\";if (Number(st) === 401) return \"غير مصرح\";if (Number(st) === 403) return \"غير مصرح\";if (Number(st) === 422) return \"بيانات غير صالحة\";if (Number(st) === 500) return \"خطأ في الخادم\";if (Number(st) === 503) return \"الخدمة غير متاحة\";if (Number(st) === 504) return \"انتهت مهلة الخادم\";if (msg && msg.indexOf(\"timeout\") !== -1) return \"انتهت المهلة\";retu",
"rn null;} catch (e) {return null;} } async function addItemsToCart(items) {if (storeClosedNow()) {var e0 = new Error(\"store_closed\");e0.status = 410;throw e0;} var cart = window.salla && window.salla.cart;if (!cart || typeof cart.addItem !== \"function\") throw new Error(\"Salla cart API not available\");function withTimeout(p, ms) {return Promise.race([ p, new Promise(function (_, rej) {setTimeout(function () {rej(new Error(\"timeout\"));}, Math.max(1, Number(ms || 1)));}) ]);} for (var i = 0;i < items.length;i++) {var it = items[i] || {};var qty = Math.max(1, Math.floor(Number(it.qu",
  "antity || 1)));var vid = String(it.variantId || \"\").trim();if (!vid) throw new Error(\"Missing variant selection\");var isProductRef = vid && vid.indexOf(\"product:\") === 0;var pidStr = String(it.cartProductId || it.productId || \"\").trim();if ((!pidStr || pidStr === \"\") && isProductRef) {pidStr = String(vid).slice(\"product:\".length).trim();} if (pidStr && pidStr.indexOf(\"product:\") === 0) {pidStr = String(pidStr).slice(\"product:\".length).trim();} var pidNum = Number(pidStr);var opts = it && it.cart",
  "Options && typeof it.cartOptions === \"object\" ? it.cartOptions : null;if ((!opts || !Object.keys(opts).length) && typeof getCachedVariants === \"function\" && pidStr) {try {var c = await getCachedVariants(pidStr);for (var ci = 0;ci < c.length;ci++) {var cv = c[ci] || {};if (String(cv.variantId || \"\").trim() === vid) {opts = cv.cartOptions || null;break;} } } catch (e0) {} } var done = false;if (!isProductRef) {var skuNum = Number(vid);var skuId = Number.isFinite(skuNum) && skuNum > 0 ? skuNum : vi",
"d;try {await withTimeout(cart.addItem({id: skuId, quantity: qty }), 4500);done = true;} catch (e) {markStoreClosed(e);if (storeClosedNow()) throw e;done = false;} } if (done) continue;if (!Number.isFinite(pidNum) || pidNum <= 0) throw new Error(\"Missing product id\");try {if (opts && Object.keys(opts).length) {await withTimeout(cart.addItem({id: pidNum, quantity: qty, options: opts }), 4500);continue;} await withTimeout(cart.addItem({id: pidNum, quantity: qty }), 4500);continue;} catch (e2) {markStoreClosed(e2);if (storeClosedNow()) throw e2;if (typeof cart.quickAdd === \"function\" && Number.isFinite(pidNum) && pidNum > 0) {try {aw",
  "ait withTimeout(cart.quickAdd(pidNum), 4500);continue;} catch (e3) {} } throw e2;} } } async function removeItemsFromCart(items) {if (storeClosedNow()) return;var cart = window.salla && window.salla.cart;if (!cart) throw new Error(\"Salla cart API not available\");for (var i = 0;i < items.length;i++) {var it = items[i] || {};var v = String(it.variantId || \"\").trim();var pid = String(it.productId || \"\").trim();if (v && v.indexOf(\"product:\") === 0) {if (!pid) pid = String(v).slice(\"product:\".length)",
  ".trim();v = \"\";} var pidNum = Number(pid);try {if (cart && typeof cart.removeItem === \"function\") {if (v) {await cart.removeItem(v);} else if (pid && Number.isFinite(pidNum) && pidNum > 0) {await cart.removeItem(pidNum);} continue;} if (cart && typeof cart.deleteItem === \"function\") {if (v) {await cart.deleteItem(v);} else if (pid && Number.isFinite(pidNum) && pidNum > 0) {await cart.deleteItem(pidNum);} continue;} if (cart && typeof cart.updateItem === \"function\") {if (v) {await cart.updateItem",
  "({id: v, quantity: 0 });} else if (pid && Number.isFinite(pidNum) && pidNum > 0) {await cart.updateItem({id: pidNum, quantity: 0 });} continue;} if (cart && typeof cart.setItemQuantity === \"function\") {if (v) {await cart.setItemQuantity(v, 0);} else if (pid && Number.isFinite(pidNum) && pidNum > 0) {await cart.setItemQuantity(pidNum, 0);} continue;} } catch (e) {var st = extractHttpStatus(e);var msg = extractHttpMessage(e);markStoreClosed({status: st, message: msg });if (storeClosedNow()) return",
  ";if (st === 410) continue;warn(\"bundle-app: remove item failed\", e && (e.details || e.message || e));} } } async function applyPendingCouponForCart() {if (!isCartLikePage()) return;if (storeClosedNow()) return;try {var trigger = String(lastTriggerProductId || \"\");if (!trigger) return;var pending = loadPendingCoupon(trigger);if (!pending || !pending.code) return;var ts = Number(pending.ts || 0);if (!Number.isFinite(ts) || ts <= 0 || Date.now() - ts > 10 * 60 * 1000) {clearPendingCoupon(trigger);r",
  "eturn;} var ok = await tryApplyCoupon(pending.code);if (ok) {clearPendingCoupon(trigger);} } catch (e) {markStoreClosed(e);} } function getDefaultMinQty() {return 1;} function getPageQty() {try {var qty = Number(window.salla && window.salla.config && window.salla.config.product && window.salla.config.product.quantity);if (Number.isFinite(qty) && qty >= 1) return Math.floor(qty);return 1;} catch (e) {return 1;} } function pickMinQty(bundle) {try {var bid = String(bundle && bundle.id || \"\").trim()",
  ";var v = Number(selectedTierByBundleId[bid]);if (Number.isFinite(v) && v >= 1) return Math.floor(v);return 1;} catch (e) {return 1;} } function pickPricingForQty(bundle, qty) {try {var base = (bundle && bundle.pricing && bundle.pricing.base) || null;var tiers = (bundle && bundle.pricing && bundle.pricing.tiers) || [];var q = Math.max(1, Math.floor(Number(qty || 1)));if (Array.isArray(tiers) && tiers.length) {var best = null;for (var i = 0;i < tiers.length;i++) {var t = tiers[i] || {};var mq = Ma",
  "th.max(1, Math.floor(Number(t.minQty || 1)));if (mq === q) return t;if (mq <= q && (best == null || mq > best.minQty)) best = t;} if (best) return best;} return base;} catch (e) {return (bundle && bundle.pricing && bundle.pricing.base) || null;} } function pctFrom(original, final) {try {var o = Number(original);var f = Number(final);if (!Number.isFinite(o) || !Number.isFinite(f) || o <= 0) return null;var diff = o - f;if (diff <= 0) return null;var pct = Math.round((diff / o) * 100);return Numbe",
  "r.isFinite(pct) && pct > 0 ? pct : null;} catch (e) {return null;} } function computeQtyItems(bundle, opts) {try {var comps = (bundle && bundle.components) || [];var qSel = pickMinQty(bundle);var baseQty = Math.max(1, Math.floor(Number(getPageQty() || 1)));if (Number.isFinite(qSel) && qSel > baseQty) baseQty = qSel;var items = [];for (var i = 0;i < comps.length;i++) {var c = comps[i] || {};var v = String(c.variantId || \"\").trim();var pid = String(c.productId || \"\").trim();var isBase = Boolean(c.",
  "isBase);var qty = isBase ? baseQty : Math.max(1, Math.floor(Number(c.quantity || 1)));if (!v) continue;items.push({variantId: v, productId: pid || null, quantity: qty, isBase: isBase });} items.sort(function (a, b) {return String(a.variantId).localeCompare(String(b.variantId));});var mode = String((opts && opts.mode) || \"apply\");if (mode === \"preview\") {var bid = String(bundle && bundle.id || \"\").trim();var sel = getBundleVariantSelectionMap(bid) || {};var out = [];for (var j = 0;j < items.lengt",
  "h;j++) {var it = items[j] || {};var vid = String(it.variantId || \"\").trim();if (vid.indexOf(\"product:\") === 0) {var ref = String(it.productId || \"\").trim();var pickedCount = 0;var qty2 = Math.max(1, Math.floor(Number(it.quantity || 1)));for (var u = 0;u < qty2;u++) {var key = ref + \":\" + u;var pv = String(sel[key] || \"\").trim();if (pv) pickedCount++;} for (var p = 0;p < pickedCount;p++) {var key2 = ref + \":\" + p;var pv2 = String(sel[key2] || \"\").trim();var useVid = pv2 || vid;out.push({variantId",
  ": useVid, productId: ref || null, quantity: 1, isBase: it.isBase });} } else {out.push(it);} } return out;} return items;} catch (e) {return [];} } function computeProductsItems(bundle, opts) {try {var comps = (bundle && bundle.components) || [];var settings = bundle && bundle.settings || {};var req = Boolean(settings && settings.selectionRequired === true);var defIds = Array.isArray(settings && settings.defaultSelectedProductIds) ? settings.defaultSelectedProductIds : [];var include = new Set(d",
  "efIds.map(function (x) {return String(x || \"\").trim();}).filter(Boolean));var bid = String(bundle && bundle.id || \"\").trim();var sel = getBundleVariantSelectionMap(bid) || {};var items = [];for (var i = 0;i < comps.length;i++) {var c = comps[i] || {};var v = String(c.variantId || \"\").trim();var pid = String(c.productId || \"\").trim();var qty = Math.max(1, Math.floor(Number(c.quantity || 1)));if (!v) continue;var should = include.size ? include.has(pid) : !req;if (!should) continue;if (v.indexOf(\"",
  "product:\") === 0) {var mode = String((opts && opts.mode) || \"apply\");if (mode === \"preview\") {var pickedCount = 0;for (var u = 0;u < qty;u++) {var key = pid + \":\" + u;var pv = String(sel[key] || \"\").trim();if (pv) pickedCount++;} for (var p = 0;p < pickedCount;p++) {var key2 = pid + \":\" + p;var pv2 = String(sel[key2] || \"\").trim();if (!pv2 && settings && settings.variantRequired !== false) continue;items.push({variantId: pv2 || v, productId: pid || null, quantity: 1, isBase: false });} } else {v",
  "ar pickedAll = true;var parts = [];for (var u2 = 0;u2 < qty;u2++) {var key3 = pid + \":\" + u2;var pv3 = String(sel[key3] || \"\").trim();if (!pv3) pickedAll = false;parts.push(pv3 || v);} if (req && settings && settings.variantRequired !== false && !pickedAll) continue;for (var m = 0;m < parts.length;m++) {items.push({variantId: parts[m], productId: pid || null, quantity: 1, isBase: false });} } } else {items.push({variantId: v, productId: pid || null, quantity: qty, isBase: false });} } items.sort",
  "(function (a, b) {return String(a.variantId).localeCompare(String(b.variantId));});return items;} catch (e) {return [];} } function computeNoDiscountItems(bundle, opts) {try {var comps = (bundle && bundle.components) || [];var settings = bundle && bundle.settings || {};var req = Boolean(settings && settings.selectionRequired === true);var defIds = Array.isArray(settings && settings.defaultSelectedProductIds) ? settings.defaultSelectedProductIds : [];var include = new Set(defIds.map(function (x) ",
  "{return String(x || \"\").trim();}).filter(Boolean));var bid = String(bundle && bundle.id || \"\").trim();var sel = getBundleVariantSelectionMap(bid) || {};var items = [];for (var i = 0;i < comps.length;i++) {var c = comps[i] || {};var v = String(c.variantId || \"\").trim();var pid = String(c.productId || \"\").trim();var qty = Math.max(1, Math.floor(Number(c.quantity || 1)));if (!v) continue;var should = include.size ? include.has(pid) : !req;if (!should) continue;if (v.indexOf(\"product:\") === 0) {var ",
  "mode = String((opts && opts.mode) || \"apply\");if (mode === \"preview\") {var pickedCount = 0;for (var u = 0;u < qty;u++) {var key = pid + \":\" + u;var pv = String(sel[key] || \"\").trim();if (pv) pickedCount++;} for (var p = 0;p < pickedCount;p++) {var key2 = pid + \":\" + p;var pv2 = String(sel[key2] || \"\").trim();items.push({variantId: pv2 || v, productId: pid || null, quantity: 1, isBase: false });} } else {for (var m = 0;m < qty;m++) {var key3 = pid + \":\" + m;var pv3 = String(sel[key3] || \"\").trim(",
  ");items.push({variantId: pv3 || v, productId: pid || null, quantity: 1, isBase: false });} } } else {items.push({variantId: v, productId: pid || null, quantity: qty, isBase: false });} } items.sort(function (a, b) {return String(a.variantId).localeCompare(String(b.variantId));});return items;} catch (e) {return [];} } function computePostAddItems(bundle, opts) {try {var comps = (bundle && bundle.components) || [];var bid = String(bundle && bundle.id || \"\").trim();var sel = getBundleVariantSelect",
  "ionMap(bid) || {};var items = [];for (var i = 0;i < comps.length;i++) {var c = comps[i] || {};var v = String(c.variantId || \"\").trim();var pid = String(c.productId || \"\").trim();var qty = Math.max(1, Math.floor(Number(c.quantity || 1)));if (!v) continue;if (v.indexOf(\"product:\") === 0) {var mode = String((opts && opts.mode) || \"apply\");if (mode === \"preview\") {var pickedCount = 0;for (var u = 0;u < qty;u++) {var key = pid + \":\" + u;var pv = String(sel[key] || \"\").trim();if (pv) pickedCount++;} f",
  "or (var p = 0;p < pickedCount;p++) {var key2 = pid + \":\" + p;var pv2 = String(sel[key2] || \"\").trim();items.push({variantId: pv2 || v, productId: pid || null, quantity: 1, isBase: false });} } else {for (var m = 0;m < qty;m++) {var key3 = pid + \":\" + m;var pv3 = String(sel[key3] || \"\").trim();items.push({variantId: pv3 || v, productId: pid || null, quantity: 1, isBase: false });} } } else {items.push({variantId: v, productId: pid || null, quantity: qty, isBase: false });} } items.sort(function (",
  "a, b) {return String(a.variantId).localeCompare(String(b.variantId));});return items;} catch (e) {return [];} } function computeBundleApplyItems(bundle, opts) {try {var mode = String((opts && opts.mode) || \"apply\");var kind = String(bundle && bundle.kind || \"\").trim();if (kind === \"quantity_discount\") return computeQtyItems(bundle, {mode: mode });if (kind === \"products_discount\") return computeProductsItems(bundle, {mode: mode });if (kind === \"products_no_discount\") return computeNoDiscountItems",
  "(bundle, {mode: mode });if (kind === \"post_add_upsell\") return computePostAddItems(bundle, {mode: mode });return computeQtyItems(bundle, {mode: mode });} catch (e) {return normalizeItems(bundle);} } function buildTierRows(bundle, bundleId, selectedMinQty, isBundleSelected) {try {var tiers = (bundle && bundle.offer && bundle.offer.tiers) || [];var pricingTiers = (bundle && bundle.pricing && bundle.pricing.tiers) || [];var rows = [];if (Array.isArray(tiers) && tiers.length) {for (var i = 0;i < tie",
  "rs.length;i++) {var mq = Math.max(1, Math.floor(Number(tiers[i] && tiers[i].minQty || 1)));var pr = null;for (var j = 0;j < pricingTiers.length;j++) {var pt = pricingTiers[j] || {};if (Math.floor(Number(pt.minQty || 0)) === mq) {pr = pt;break;} } rows.push({minQty: mq, pricing: pr });} } else {rows.push({minQty: 1, pricing: pickPricingForQty(bundle, 1) });} rows.sort(function (a, b) {return a.minQty - b.minQty;});var out = \"\";for (var k = 0;k < rows.length;k++) {var r = rows[k];var prc = r.prici",
  "ng || {};var o = Number(prc.originalTotal), f = Number(prc.finalTotal), d = Number(prc.discountAmount);var left = \"عند \" + fmtNum(r.minQty) + \" قطع\";var right = \"\";if (Number.isFinite(o) && Number.isFinite(f)) {right = \"قبل \" + fmtMoney(o) + \" • بعد \" + fmtMoney(f);if (Number.isFinite(d) && d > 0) {right += \" • وفّرت \" + fmtMoney(d);var pct = pctFrom(o, f);if (pct != null) right += \" (\" + fmtNum(pct) + \"%)\";} } var active = Boolean(isBundleSelected && Number(selectedMinQty) === Number(r.minQty))",
  ";var cls = \"bundle-app-tier\" + (active ? \" bundle-app-tier--selected\" : \"\");out += '<label class=\"' + cls + '\" data-bundle-id=\"' + escHtml(bundleId) + '\" data-tier-minqty=\"' + escHtml(r.minQty) + '\"><div class=\"bundle-app-tier-main\"><div><strong>' + escHtml(left) + '</strong></div>' + (right ? '<div class=\"bundle-app-muted\">' + escHtml(right) + '</div>' : \"\") + '</div><span class=\"bundle-app-checkwrap bundle-app-tier-checkwrap\"><input class=\"bundle-app-tier-check\" type=\"checkbox\" data-bundle-id=",
  "\"' + escHtml(bundleId) + '\" data-tier-minqty=\"' + escHtml(r.minQty) + '\" ' + (active ? \"checked\" : \"\") + ' /><span class=\"bundle-app-checkmark\"></span></span></label>' + (active ? '<div class=\"bundle-app-pickers bundle-app-pickers--inline\" data-bundle-id=\"' + escHtml(bundleId) + '\"></div>' : \"\");} return out;} catch (e) {return \"\";} } function buildPriceText(bundle) {try {var selected = pickMinQty(bundle);var baseQty = Math.max(1, Math.floor(Number(getPageQty() || 1)));if (Number.isFinite(select",
  "ed) && selected > baseQty) baseQty = selected;var p = pickPricingForQty(bundle, baseQty);if (!p) return \"\";var o = Number(p.originalTotal), f = Number(p.finalTotal), d = Number(p.discountAmount);if (!Number.isFinite(o) || !Number.isFinite(f)) return \"\";var s = \"قبل \" + fmtMoney(o) + \" • بعد \" + fmtMoney(f);if (Number.isFinite(d) && d > 0) s += \" • وفّرت \" + fmtMoney(d);return s;} catch (e) {return \"\";} } async function applyBundleSelection(bundle) {var bid = String(bundle && bundle.id || \"\");var",
  " trigger = String(bundle && bundle.triggerProductId || \"\");var kind = String(bundle && bundle.kind || \"\").trim();if (!bid) return;if (!trigger && kind !== \"products_no_discount\" && kind !== \"post_add_upsell\") return;if (storeClosedNow()) {messageByBundleId[bid] = \"لم يتم إضافة الباقة (المتجر مغلق حالياً)\";applying = false;try {renderProductBanners(lastBundles || []);} catch (e0) {} return;} if (kind === \"post_add_upsell\" && postAddShownByBundleId[bid]) {messageByBundleId[bid] = \"تم عرض الإضافة ب",
  "الفعل\";try {renderProductBanners(lastBundles || []);} catch (e00) {} return;} selectedBundleId = bid;applying = true;try {messageByBundleId[bid] = \"جاري إضافة الباقة...\";renderProductBanners(lastBundles || []);} catch (e) {} try {var rawItems = typeof computeBundleApplyItems === \"function\" ? computeBundleApplyItems(bundle) : normalizeItems(bundle);var items = await resolveProductRefItems(rawItems, bid);if (!items || !items.length) {messageByBundleId[bid] = kind === \"products_discount\" || kind ==",
  "= \"products_no_discount\" || kind === \"post_add_upsell\" ? \"اختار المنتجات قبل الإضافة\" : \"لازم تختار الفاريانت قبل إضافة الباقة\";applying = false;try {renderProductBanners(lastBundles || []);} catch (e000) {} return;} if (kind === \"products_no_discount\" || kind === \"post_add_upsell\") {try {await addItemsToCart(items);messageByBundleId[bid] = \"تمت إضافة المنتجات للسلة\";if (kind === \"post_add_upsell\") {postAddShownByBundleId[bid] = true;} } catch (addErr) {markStoreClosed(addErr);var hm = humanizeC",
  "artError(addErr);messageByBundleId[bid] = hm ? \"لم يتم الإضافة (\" + hm + \")\" : \"لم يتم الإضافة\";} applying = false;try {renderProductBanners(lastBundles || []);} catch (e01) {} return;} var prev = loadSelection(trigger);await tryClearCoupon();if (storeClosedNow()) {messageByBundleId[bid] = \"لم يتم إضافة الباقة (المتجر مغلق حالياً)\";applying = false;try {renderProductBanners(lastBundles || []);} catch (e02) {} return;} if (prev && prev.bundleId && String(prev.bundleId) !== bid && Array.isArray(pr",
"ev.items) && prev.items.length) {await removeItemsFromCart(prev.items);} if (storeClosedNow()) {messageByBundleId[bid] = \"لم يتم إضافة الباقة (المتجر مغلق حالياً)\";applying = false;try {renderProductBanners(lastBundles || []);} catch (e03) {} return;} var res = await requestApplyBundle(bid, items);if (res && res.ok) {try {await addItemsToCart(items);} catch (addErr2) {markStoreClosed(addErr2);var hm3 = humanizeCartError(addErr2);messageByBundleId[bid] = hm3 ? \"لم يتم الإضافة (\" + hm3 + \")\" : \"لم يتم الإضافة\";applying = false;try {renderProductBanners(lastBundles || []);} catch (e030) {} return;} saveSelection(trigger, {bundleId: bid, items: items });var cc = (res && (res.couponCode || (res.coupon && res.coupon.code))) || \"\";if (cc) {savePendingCoupon(trigger, {code: String(cc), ts: Date.now() });} if (res.couponIssueFailed) {messageByBundleId[bid] = \"تمت إضافة الباقة للسلة لكن فشل كوبون الخصم\";} else if (res.hasDiscount === false) {messageByBundleId[bid] = \"تمت إضافة الباقة للسلة (بدون خصم)\";} else {messageByBundleId[bid] = \"تمت إضافة الباقة للسلة\";}",
  "} else {var errMsg = (res && res.message) || \"فشلت العملية\";messageByBundleId[bid] = errMsg;} } catch (applyErr) {markStoreClosed(applyErr);var hm2 = humanizeCartError(applyErr);messageByBundleId[bid] = hm2 ? \"لم يتم الإضافة (\" + hm2 + \")\" : \"لم يتم الإضافة\";} applying = false;try {renderProductBanners(lastBundles || []);} catch (e04) {} } async function tryClearCoupon() {try {var cart = window.salla && window.salla.cart;var cleared = false;if (cart && typeof cart.",
  "clearCoupon === \"function\") {await cart.clearCoupon();cleared = true;} else if (cart && cart.coupon && typeof cart.coupon.clear === \"function\") {await cart.coupon.clear();cleared = true;} else if (cart && cart.coupon && typeof cart.coupon.remove === \"function\") {await cart.coupon.remove();cleared = true;} else if (cart && typeof cart.removeCoupon === \"function\") {await cart.removeCoupon();cleared = true;} else if (window.salla && typeof window.salla.clearCoupon === \"function\") {await window.sall",
  "a.clearCoupon();cleared = true;} if (cleared) {try {g.BundleApp._lastCouponClearStatus = null;g.BundleApp._lastCouponClearMessage = \"\";} catch (x0) {} } } catch (e) {var st = extractHttpStatus(e);var msg = extractHttpMessage(e);try {g.BundleApp._lastCouponClearStatus = st;g.BundleApp._lastCouponClearMessage = String(msg || \"\");} catch (x1) {} markStoreClosed({status: st, message: msg });} } async function resolveProductRefItems(items, bundleId) {var resolved = [];var units = bundleVariantUnits({",
  "components: items });var sel = getBundleVariantSelectionMap(bundleId) || {};for (var i = 0;i < items.length;i++) {var it = items[i] || {};var vid = String(it.variantId || \"\").trim();var pid = String(it.productId || \"\").trim();var qty = Math.max(1, Math.floor(Number(it.quantity || 1)));if (!vid) continue;if (vid.indexOf(\"product:\") === 0) {if (!pid) pid = vid.slice(\"product:\".length).trim();var pickedCount = 0;for (var u = 0;u < qty;u++) {var key = pid + \":\" + u;var pv = String(sel[key] || \"\").tr",
  "im();if (pv) {resolved.push({variantId: pv, productId: pid, quantity: 1, isBase: it.isBase });pickedCount++;} } if (pickedCount === 0) {var cache = variantPickerCacheByProductId[pid];var variants = cache && Array.isArray(cache.variants) ? cache.variants : [];if (variants.length === 1) {resolved.push({variantId: variants[0].variantId, productId: pid, quantity: qty, isBase: it.isBase });} } } else {resolved.push(it);} } return resolved;} function clearProductBanner() {try {var container = document",
  ".querySelector(\".bundle-app-container[data-feature-location='product']\");if (container) {container.innerHTML = \"\";container.style.display = \"none\";} } catch (e) {} } function renderProductBanners(bundles) {try {var container = document.querySelector(\".bundle-app-container[data-feature-location='product']\");if (!container) return;if (!bundles || !bundles.length) {clearProductBanner();return;} var html = \"\";for (var i = 0;i < bundles.length;i++) {var bundle = bundles[i] || {};var bundleId = String",
  "(bundle.id || \"\").trim();if (!bundleId) continue;var title = normalizeTitle(bundle.title || \"\");var itemsText = buildItemsText(normalizeItems(bundle));var priceText = buildPriceText(bundle);var message = messageByBundleId[bundleId] || \"\";var isApplying = applying && selectedBundleId === bundleId;var tierRows = \"\";if (bundle.offer && bundle.offer.tiers && bundle.offer.tiers.length) {var selectedMinQty = pickMinQty(bundle);tierRows = buildTierRows(bundle, bundleId, selectedMinQty, true);} var cls ",
  "= \"bundle-app bundle-app--product\";if (isApplying) cls += \" bundle-app--applying\";if (message) cls += \" bundle-app--has-message\";html += '<div class=\"' + cls + '\" data-bundle-id=\"' + escHtml(bundleId) + '\">';html += '<div class=\"bundle-app-header\"><div class=\"bundle-app-title\">' + escHtml(title) + '</div>' + (message ? '<div class=\"bundle-app-message\">' + escHtml(message) + '</div>' : \"\") + \"</div>\";if (tierRows) {html += '<div class=\"bundle-app-tiers\">' + tierRows + \"</div>\";} else {html += '<d",
  "iv class=\"bundle-app-body\">';html += '<div class=\"bundle-app-items\">' + escHtml(itemsText) + \"</div>\";if (priceText) html += '<div class=\"bundle-app-price\">' + escHtml(priceText) + \"</div>\";html += \"</div>\";} html += '<div class=\"bundle-app-actions\">';html += '<button class=\"bundle-app-btn bundle-app-btn--primary\" data-action=\"add-bundle\" data-bundle-id=\"' + escHtml(bundleId) + '\">' + (isApplying ? \"جاري...\" : \"أضف الباقة\") + \"</button>\";html += \"</div>\";html += \"</div>\";} container.innerHTML = ",
  "html;container.style.display = \"block\";} catch (e) {warn(\"bundle-app: render failed\", e && (e.details || e.message || e));} } function findVariantId() {try {return window.salla && window.salla.config && window.salla.config.product && window.salla.config.product.variantId;} catch (e) {return null;} } function findProductId() {try {return window.salla && window.salla.config && window.salla.config.product && window.salla.config.product.id;} catch (e) {return null;} } function openPickerModal(bundle",
  "Id, productId) {try {var bundle = null;var bundles = lastBundles || [];for (var i = 0;i < bundles.length;i++) {if (String(bundles[i] && bundles[i].id || \"\") === String(bundleId)) {bundle = bundles[i];break;} } if (!bundle) return;var units = bundleVariantUnits(bundle);var cache = variantPickerCacheByProductId[productId];var variants = cache && Array.isArray(cache.variants) ? cache.variants : [];if (!variants.length) return;var sel = getBundleVariantSelectionMap(bundleId) || {};var html = '<div c",
  "lass=\"bundle-app-modal-overlay\" data-modal-for=\"' + escHtml(productId) + '\">';html += '<div class=\"bundle-app-modal\">';html += '<div class=\"bundle-app-modal-header\">';html += '<div class=\"bundle-app-modal-title\">اختر المتغيرات</div>';html += '<button class=\"bundle-app-modal-close\" data-action=\"close-modal\">&times;</button>';html += \"</div>\";html += '<div class=\"bundle-app-modal-body\">';for (var u = 0;u < units.length;u++) {var unit = units[u] || {};var key = String(unit.key || \"\");var current = ",
  "String(sel[key] || \"\");html += '<div class=\"bundle-app-picker-unit\">';html += '<div class=\"bundle-app-picker-label\">المنتج ' + fmtNum(u + 1) + \"</div>\";html += '<select class=\"bundle-app-picker-select\" data-unit-key=\"' + escHtml(key) + '\">';for (var vi = 0;vi < variants.length;vi++) {var variant = variants[vi] || {};var vId = String(variant.variantId || \"\");html += '<option value=\"' + escHtml(vId) + '\"' + (vId === current ? \" selected\" : \"\") + \">\";html += variantOptionInnerHtml(variant);html += ",
  "\"</option>\";} html += \"</select>\";html += \"</div>\";} html += \"</div>\";html += '<div class=\"bundle-app-modal-footer\">';html += '<button class=\"bundle-app-btn bundle-app-btn--primary\" data-action=\"save-picks\" data-bundle-id=\"' + escHtml(bundleId) + '\">حفظ</button>';html += \"</div>\";html += \"</div>\";html += \"</div>\";document.body.insertAdjacentHTML(\"beforeend\", html);} catch (e) {warn(\"bundle-app: open picker failed\", e && (e.details || e.message || e));} } var lastBundles = null;async function ref",
  "reshProduct() {var state = null;try {state = g.BundleApp && g.BundleApp.__refreshState ? g.BundleApp.__refreshState : (g.BundleApp.__refreshState = {busy: false, queued: false, lastKey: \"\", lastSig: \"\" });if (state.busy) {state.queued = true;return;} state.busy = true;var variantId = findVariantId();var productId = findProductId();var key = variantId ? \"v:\" + String(variantId) : productId ? \"p:\" + String(productId) : \"\";log(\"bundle-app: ids\", {variantId: variantId, productId: productId });var re",
  "s = null;if (variantId) {res = await getProductBundlesByVariantId(variantId);} else if (productId) {res = await getProductBundlesByProductId(productId);} else {clearProductBanner();state.lastKey = \"\";state.lastSig = \"\";return;} var bundles = (res && res.bundles) || [];if (!bundles.length) {clearProductBanner();state.lastKey = key;state.lastSig = \"\";return;} var sig = \"\";for (var i = 0;i < bundles.length;i++) {var b = bundles[i] || {};sig += String(b.id || i) + \"|\" + bundleVariantSig(b) + \"|\" + S",
  "tring((b.pricing && b.pricing.base && b.pricing.base.finalTotal) != null ? b.pricing.base.finalTotal : \"\") + \";\";} if (!applying && key === state.lastKey && sig === state.lastSig) return;state.lastKey = key;state.lastSig = sig;lastBundles = bundles;renderProductBanners(bundles);} catch (e) {warn(\"bundle-app: refresh failed\", e && (e.details || e.message || e));clearProductBanner();} finally {if (state) {state.busy = false;if (state.queued) {state.queued = false;setTimeout(function () {refreshPro",
  "duct();}, 0);} } } }"
];
