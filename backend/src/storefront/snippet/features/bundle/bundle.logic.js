module.exports = [
  "(function(){",
  "var g=null;try{g=globalThis}catch(e){g=window}if(!g)g=window;",
  "g.BundleApp=g.BundleApp||{};",
  "var debug=false;try{debug=new URL(scriptSrc).searchParams.get(\"debug\")===\"1\"}catch(e){}",
  "function log(){if(!debug)return;try{console.log.apply(console,arguments)}catch(e){}}",
  "function warn(){if(!debug)return;try{console.warn.apply(console,arguments)}catch(e){}}",
  "function getBackendOrigin(){try{return new URL(scriptSrc).origin}catch(e){return\"\"}}",
  "async function fetchJson(url,opts){var r=await fetch(url,opts);var t=await r.text();var j=null;try{j=t?JSON.parse(t):null}catch(e){throw new Error(\"Invalid JSON response\")}if(!r.ok){var msg=(j&&j.message)||(\"HTTP \"+r.status);var err=new Error(msg);err.status=r.status;err.details=j;throw err}return j}",
  "function buildUrl(path,params){var origin=getBackendOrigin();if(!origin)return null;var u=new URL(origin+path);for(var k in (params||{})){if(!Object.prototype.hasOwnProperty.call(params,k))continue;var v=params[k];if(v==null||v===\"\")continue;u.searchParams.set(k,String(v))}u.searchParams.set(\"merchantId\",merchantId);u.searchParams.set(\"token\",token);return u.toString()}",
  "async function getProductBundlesByVariantId(variantId){var v=String(variantId||\"\").trim();if(!v)return null;var u=buildUrl(\"/api/proxy/bundles/product\",{variantId:v});if(!u)return null;return fetchJson(u)}",
  "async function getProductBundlesByProductId(productId){var p=String(productId||\"\").trim();if(!p)return null;var u=buildUrl(\"/api/proxy/bundles/for-product\",{productId:p});if(!u)return null;return fetchJson(u)}",
  "async function requestApplyBundle(bundleId,items){var payload={bundleId:String(bundleId||\"\"),items:Array.isArray(items)?items:[]};var u=buildUrl(\"/api/proxy/bundles/apply\",{});if(!u)return null;return fetchJson(u,{method:\"POST\",headers:{\"Content-Type\":\"application/json\"},body:JSON.stringify(payload)})}",
  "async function getProductVariantsByProductId(productId){var p=String(productId||\"\").trim();if(!p)return null;var u=buildUrl(\"/api/proxy/products/variants\",{productId:p});if(!u)return null;return fetchJson(u)}",
  "function isProductRef(variantId){return String(variantId||\"\").trim().indexOf(\"product:\")===0}",
  "var variantsCacheByProductId={};var variantsPendingByProductId={};",
  "async function getCachedVariants(productId){var pid=String(productId||\"\").trim();if(!pid)return[];if(Object.prototype.hasOwnProperty.call(variantsCacheByProductId,pid))return variantsCacheByProductId[pid]||[];var pend=variantsPendingByProductId[pid];if(pend&&pend.then)return pend;var p=(async function(){try{var res=await getProductVariantsByProductId(pid);var vars=(res&&res.variants)||[];variantsCacheByProductId[pid]=Array.isArray(vars)?vars:[];return variantsCacheByProductId[pid]}finally{try{delete variantsPendingByProductId[pid]}catch(e){variantsPendingByProductId[pid]=null}}})();variantsPendingByProductId[pid]=p;return p}",
  "function stringifyAttrs(attrs){try{if(!attrs||typeof attrs!==\"object\")return\"\";var parts=[];for(var k in attrs){if(!Object.prototype.hasOwnProperty.call(attrs,k))continue;var key=String(k||\"\").trim();var v=attrs[k];if(v==null)continue;var vs=String(v||\"\").trim();if(!vs)continue;parts.push((key?(key+\": \"):\"\")+vs)}return parts.join(\" • \")}catch(e){return\"\"}}",
  "function variantLabel(v){var id=String(v&&v.variantId||\"\").trim();var name=String(v&&v.name||\"\").trim();var attrs=stringifyAttrs(v&&v.attributes);var price=v&&v.price!=null?Number(v.price):null;var priceText=(Number.isFinite(price)&&price>=0)?fmtMoney(price):\"\";var base='';if(attrs&&name)base=name+\" • \"+attrs;else if(attrs)base=attrs;else if(name)base=name;else if(id)base=id;else base=\"\";if(base&&priceText)return base+\" • \"+priceText;if(base)return base;if(priceText)return priceText;return \"—\"}",
  "function normHex(s){try{var x=String(s||\"\").trim();if(!x)return\"\";var m=x.match(/^#?([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/);if(!m)return\"\";return x.charAt(0)==='#'?x:('#'+x)}catch(e){return\"\"}}",
  "function escCssUrl(u){try{var s=String(u||\"\").trim();if(!s)return\"\";s=s.replace(/[\\n\\r\\t\\f\\\\\"'()<>]/g,\"\");return s}catch(e){return\"\"}}",
  "function pickVariantSwatch(v){try{var img=String(v&&v.imageUrl||\"\").trim();if(img)return{t:\"img\",v:img};var attrs=v&&v.attributes&&typeof v.attributes===\"object\"?v.attributes:null;if(attrs){for(var k in attrs){if(!Object.prototype.hasOwnProperty.call(attrs,k))continue;var hex=normHex(attrs[k]);if(hex)return{t:\"hex\",v:hex}}}var hex2=normHex(v&&v.name);if(hex2)return{t:\"hex\",v:hex2};return null}catch(e){return null}}",
  "function variantOptionInnerHtml(v){var sw=pickVariantSwatch(v);var out='';if(sw&&sw.t==='img'){var u=escCssUrl(sw.v);if(u){out+='<span class=\"bundle-app-variant-swatch is-image\" style=\"background-image:url(\\''+escHtml(u)+'\\')\"></span>'}}else if(sw&&sw.t==='hex'&&sw.v){out+='<span class=\"bundle-app-variant-swatch\" style=\"background:'+escHtml(sw.v)+'\"></span>'}out+='<span class=\"bundle-app-variant-text\">'+escHtml(variantLabel(v))+'</span>';return out}",
  "var selectedBundleId=null;",
  "var lastTriggerProductId=null;",
  "var messageByBundleId={};",
  "var selectedTierByBundleId={};",
  "var applying=false;",
  "var variantSelectionsByBundleId={};",
  "var variantPickerCacheByBundleId={};",
  "var variantPickerPendingByBundleId={};",
  "function getBundleVariantSelectionMap(bundleId){var bid=String(bundleId||\"\").trim();if(!bid)return null;var m=variantSelectionsByBundleId[bid];if(!m||typeof m!==\"object\")m={};variantSelectionsByBundleId[bid]=m;return m}",
  "function bundleVariantSig(bundle){try{var items=normalizeItems(bundle);var parts=[];for(var i=0;i<items.length;i++){var it=items[i]||{};var v=String(it.variantId||\"\").trim();if(!isProductRef(v))continue;var pid=String(it.productId||\"\").trim();if(!pid)continue;var qty=Math.max(1,Math.floor(Number(it.quantity||1)));parts.push(pid+\"x\"+qty)}parts.sort();return parts.join(\"|\")}catch(e){return\"\"}}",
  "function bundleVariantUnits(bundle){var items=normalizeItems(bundle);var units=[];for(var i=0;i<items.length;i++){var it=items[i]||{};var v=String(it.variantId||\"\").trim();if(!isProductRef(v))continue;var pid=String(it.productId||\"\").trim();if(!pid)continue;var qty=Math.max(1,Math.floor(Number(it.quantity||1)));for(var u=0;u<qty;u++){units.push({productId:pid,key:pid+\":\"+u})}}return units}",
  "function pruneBundleSelections(sel,units){try{if(!sel||typeof sel!==\"object\")return;var keep={};for(var i=0;i<units.length;i++){keep[String(units[i]&&units[i].key||\"\")]=true}for(var k in sel){if(!Object.prototype.hasOwnProperty.call(sel,k))continue;if(!keep[k]){try{delete sel[k]}catch(e){sel[k]=null}}}}catch(e){}}",
  "function escHtml(input){var s=String(input==null?\"\":input);return s.replace(/[&<>\"']/g,function(ch){return ch===\"&\"?\"&amp;\":ch===\"<\"?\"&lt;\":ch===\">\"?\"&gt;\":ch==='\"'?\"&quot;\":\"&#39;\"})}",
  "function fmtNum(n){var x=Number(n);if(!Number.isFinite(x))return\"—\";try{return x.toLocaleString(\"ar-SA\")}catch(e){return String(x)}}",
  "function fmtMoney(n){var x=Number(n);if(!Number.isFinite(x))return\"—\";var v=Math.round(x*100)/100;var s;try{s=v.toLocaleString(\"ar-SA\",{minimumFractionDigits:v%1?2:0,maximumFractionDigits:2})}catch(e){s=String(v)}return s+\" ر.س\"}",
  "function normalizeTitle(raw){var title=String(raw||\"\");if(!title||title===\"Bundle\")title=\"باقة\";try{title=title.replace(/^Bundle\\s*-\\s*/i,\"باقة - \")}catch(e){}return title}",
  "function minRequiredBaseQty(bundle){return 1}",
  "function normalizeItems(bundle){var comps=(bundle&&bundle.components)||[];if(!Array.isArray(comps)||!comps.length){comps=(bundle&&bundle.bundleItems)||[]}var out=[];var baseMin=minRequiredBaseQty(bundle);for(var i=0;i<comps.length;i++){var c=comps[i]||{};var v=String(c.variantId||\"\").trim();var pid=String(c.productId||\"\").trim();var isBase=Boolean(c.isBase);var q=isBase?Math.max(getPageQty(),baseMin):Math.max(1,Math.floor(Number(c.quantity||1)));if(!v)continue;out.push({variantId:v,productId:pid||null,quantity:q,isBase:isBase})}out.sort(function(a,b){return String(a.variantId).localeCompare(String(b.variantId))});return out}",
  "function buildItemsText(items){var products=0;var totalQty=0;for(var i=0;i<items.length;i++){var it=items[i]||{};if(!it.variantId)continue;products++;totalQty+=Math.max(1,Math.floor(Number(it.quantity||1)))}return \"عدد المنتجات: \"+fmtNum(products)+\" • إجمالي القطع: \"+fmtNum(totalQty)}",
  "function buildPriceText(bundle){var p=bundle&&bundle.pricing&&bundle.pricing.base;if(!p)return\"\";var o=Number(p.originalTotal),f=Number(p.finalTotal),d=Number(p.discountAmount);if(!Number.isFinite(o)||!Number.isFinite(f))return\"\";var s='قبل '+fmtMoney(o)+' • بعد '+fmtMoney(f);if(Number.isFinite(d)&&d>0)s+=' • وفّرت '+fmtMoney(d);return s}",
  "function selectionKey(triggerProductId){return \"bundle_app_selected_bundle:\"+String(merchantId||\"\")+\":\"+String(triggerProductId||\"\")}",
  "function pendingKey(triggerProductId){return \"bundle_app_pending_coupon:\"+String(merchantId||\"\")+\":\"+String(triggerProductId||\"\")}",
  "function loadSelection(triggerProductId){try{var raw=localStorage.getItem(selectionKey(triggerProductId));if(!raw)return null;var j=JSON.parse(raw);return j&&typeof j==='object'?j:null}catch(e){return null}}",
  "function saveSelection(triggerProductId,data){try{localStorage.setItem(selectionKey(triggerProductId),JSON.stringify(data||{}))}catch(e){}}",
  "function clearSelection(triggerProductId){try{localStorage.removeItem(selectionKey(triggerProductId))}catch(e){}}",
  "function savePendingCoupon(triggerProductId,data){try{localStorage.setItem(pendingKey(triggerProductId),JSON.stringify(data||{}))}catch(e){}}",
  "function loadPendingCoupon(triggerProductId){try{var raw=localStorage.getItem(pendingKey(triggerProductId));if(!raw)return null;var j=JSON.parse(raw);return j&&typeof j==='object'?j:null}catch(e){return null}}",
  "function clearPendingCoupon(triggerProductId){try{localStorage.removeItem(pendingKey(triggerProductId))}catch(e){}}",
  "function isCartLikePage(){try{var p=String(window.location.pathname||\"\").toLowerCase();return p.indexOf('cart')!==-1||p.indexOf('checkout')!==-1}catch(e){return false}}",
  "async function tryApplyCoupon(code){var c=String(code||\"\").trim();if(!c)return false;if(storeClosedNow())return false;function sleep(ms){return new Promise(function(r){setTimeout(function(){r()},ms)})}for(var attempt=0;attempt<3;attempt++){try{var cart=window.salla&&window.salla.cart;var applied=false;if(cart&&typeof cart.applyCoupon===\"function\"){await cart.applyCoupon(c);applied=true}else if(cart&&cart.coupon&&typeof cart.coupon.apply===\"function\"){await cart.coupon.apply(c);applied=true}else if(cart&&cart.coupon&&typeof cart.coupon.set===\"function\"){await cart.coupon.set(c);applied=true}else if(cart&&typeof cart.setCoupon===\"function\"){await cart.setCoupon(c);applied=true}else if(cart&&typeof cart.addCoupon===\"function\"){await cart.addCoupon(c);applied=true}else if(window.salla&&typeof window.salla.applyCoupon===\"function\"){await window.salla.applyCoupon(c);applied=true}else if(window.salla&&window.salla.coupon&&typeof window.salla.coupon.apply===\"function\"){await window.salla.coupon.apply(c);applied=true}if(applied){try{g.BundleApp._lastCouponApplyStatus=null;g.BundleApp._lastCouponApplyMessage=\"\"}catch(x0){}return true}}catch(e){var st=extractHttpStatus(e);var msg=extractHttpMessage(e);try{g.BundleApp._lastCouponApplyStatus=st;g.BundleApp._lastCouponApplyMessage=String(msg||\"\")}catch(x1){}markStoreClosed({status:st,message:msg});if(storeClosedNow())return false;warn(\"bundle-app: coupon apply failed\",e&&((e.details)||e.message||e))}await sleep(250+attempt*250)}return false}",
  "function extractHttpStatus(e){try{var s=(e&&((e.statusCode!=null&&e.statusCode)||(e.status!=null&&e.status)||(e.response&&e.response.status)||(e.request&&e.request.status)))||null;var n=Number(s);return Number.isFinite(n)?n:null}catch(x){return null}}",
  "function extractHttpMessage(e){try{var m='';if(e&&e.details&&typeof e.details==='object'){m=String(e.details.message||e.details.error||e.details.title||'').trim();if(!m&&e.details.data&&typeof e.details.data==='object')m=String(e.details.data.message||e.details.data.error||e.details.data.title||'').trim()}if(!m&&e&&e.response&&e.response.data!=null){var d=e.response.data;if(typeof d==='string'){m=String(d||'').trim()}else if(typeof d==='object'){m=String(d.message||d.error||d.title||'').trim();if(!m&&d.data&&typeof d.data==='object')m=String(d.data.message||d.data.error||d.data.title||'').trim()}}if(!m&&e){m=String(e.message||'').trim()}return m}catch(x){return''}}",
  "function storeClosedNow(){try{var until=Number(g.BundleApp&&g.BundleApp._storeClosedUntil||0);return Number.isFinite(until)&&until>Date.now()}catch(e){return false}}",
  "function markStoreClosed(e){try{var st=extractHttpStatus(e);var msg=extractHttpMessage(e);var m=String(msg||\"\");var ml=m.toLowerCase();var isClosed=Boolean(m.indexOf('المتجر مغلق')!==-1||m.indexOf('المتجر مغلق حالياً')!==-1||m.indexOf('المتجر مغلق حاليا')!==-1||ml.indexOf('store is closed')!==-1||ml.indexOf('closed')!==-1&&ml.indexOf('store')!==-1);if(!isClosed&&Number(st)===410){isClosed=Boolean(m.indexOf('مغلق')!==-1||ml.indexOf('closed')!==-1)}if(isClosed){g.BundleApp._storeClosedUntil=Date.now()+60000}}catch(x){}}",
  "function humanizeCartError(e){var st=extractHttpStatus(e);var msg=extractHttpMessage(e);var m=String(msg||\"\");var ml=m.toLowerCase();if(m==='timeout')return 'تعذر الاتصال بسلة المتجر (مهلة)';if(m&&m.indexOf('ERR_NAME_NOT_RESOLVED')!==-1)return 'تعذر الاتصال بسلة المتجر (DNS)';if(st===410){if(m.indexOf('المتجر مغلق')!==-1||ml.indexOf('store is closed')!==-1)return 'المتجر مغلق حالياً';return 'تعذر تحديث السلة (العنصر لم يعد متاحًا)'}if(st===401||st===403)return 'لا يمكن إضافة للسلّة (صلاحيات/جلسة غير صالحة)';if(st===404)return 'لا يمكن إضافة للسلّة (المنتج غير موجود)';if(m)return m;if(st!=null)return 'HTTP '+fmtNum(st);return 'حصل خطأ أثناء الإضافة للسلّة'}",
  "async function addItemsToCart(items){var cart=window.salla&&window.salla.cart;if(!cart||typeof cart.addItem!==\"function\")throw new Error(\"Salla cart API not available\");function withTimeout(p,ms){return Promise.race([p,new Promise(function(_,rej){setTimeout(function(){rej(new Error('timeout'))},Math.max(1,Number(ms||1)))})])}for(var i=0;i<items.length;i++){var it=items[i]||{};var qty=Math.max(1,Math.floor(Number(it.quantity||1)));var vid=String(it.variantId||\"\").trim();if(!vid)throw new Error(\"Missing variant selection\");var isProductRef=vid&&vid.indexOf('product:')===0;var pidStr=String(it.cartProductId||it.productId||\"\").trim();if((!pidStr||pidStr===\"\")&&isProductRef){pidStr=String(vid).slice('product:'.length).trim()}if(pidStr&&pidStr.indexOf('product:')===0){pidStr=String(pidStr).slice('product:'.length).trim()}var pidNum=Number(pidStr);var opts=it&&it.cartOptions&&typeof it.cartOptions===\"object\"?it.cartOptions:null;if((!opts||!Object.keys(opts).length)&&typeof getCachedVariants===\"function\"&&pidStr){try{var c=await getCachedVariants(pidStr);for(var ci=0;ci<c.length;ci++){var cv=c[ci]||{};if(String(cv.variantId||\"\").trim()===vid){opts=cv.cartOptions||null;break}}}catch(e0){}}var done=false;if(!isProductRef){var skuNum=Number(vid);var skuId=(Number.isFinite(skuNum)&&skuNum>0)?skuNum:vid;try{await withTimeout(cart.addItem({id:skuId,quantity:qty}),4500);done=true}catch(e){done=false}}if(done)continue;try{if(Number.isFinite(pidNum)&&pidNum>0){if(opts&&Object.keys(opts).length){await withTimeout(cart.addItem({id:pidNum,quantity:qty,options:opts}),4500);continue}await withTimeout(cart.addItem({id:pidNum,quantity:qty}),4500);continue}}catch(e2){if(typeof cart.quickAdd===\"function\"&&Number.isFinite(pidNum)&&pidNum>0){try{await withTimeout(cart.quickAdd(pidNum),4500);continue}catch(e3){}}throw e2}}}",
  "async function removeItemsFromCart(items){if(storeClosedNow())return;var cart=window.salla&&window.salla.cart;if(!cart)throw new Error(\"Salla cart API not available\");for(var i=0;i<items.length;i++){var it=items[i]||{};var v=String(it.variantId||\"\").trim();var pid=String(it.productId||\"\").trim();if(v&&v.indexOf('product:')===0){if(!pid)pid=String(v).slice('product:'.length).trim();v='' }var pidNum=Number(pid);try{if(cart&&typeof cart.removeItem===\"function\"){if(v){await cart.removeItem(v)}else if(pid&&Number.isFinite(pidNum)&&pidNum>0){await cart.removeItem(pidNum)}continue}if(cart&&typeof cart.deleteItem===\"function\"){if(v){await cart.deleteItem(v)}else if(pid&&Number.isFinite(pidNum)&&pidNum>0){await cart.deleteItem(pidNum)}continue}if(cart&&typeof cart.updateItem===\"function\"){if(v){await cart.updateItem({id:v,quantity:0})}else if(pid&&Number.isFinite(pidNum)&&pidNum>0){await cart.updateItem({id:pidNum,quantity:0})}continue}if(cart&&typeof cart.setItemQuantity===\"function\"){if(v){await cart.setItemQuantity(v,0)}else if(pid&&Number.isFinite(pidNum)&&pidNum>0){await cart.setItemQuantity(pidNum,0)}continue}}catch(e){var st=extractHttpStatus(e);var msg=extractHttpMessage(e);markStoreClosed({status:st,message:msg});if(storeClosedNow())return;if(st===410)continue;warn(\"bundle-app: remove item failed\",e&&((e.details)||e.message||e))}}}",
  "async function applyPendingCouponForCart(){if(!isCartLikePage())return;if(storeClosedNow())return;try{var trigger=String(lastTriggerProductId||\"\");if(!trigger)return;var pending=loadPendingCoupon(trigger);if(!pending||!pending.code)return;var ts=Number(pending.ts||0);if(!Number.isFinite(ts)||ts<=0||Date.now()-ts>10*60*1000){clearPendingCoupon(trigger);return}var ok=await tryApplyCoupon(pending.code);if(ok){clearPendingCoupon(trigger)}}catch(e){markStoreClosed(e)}}",
  "function pctFrom(orig,final){var o=Number(orig),f=Number(final);if(!Number.isFinite(o)||!Number.isFinite(f)||o<=0)return null;var p=(1-(f/o))*100;return Math.max(0,Math.round(p))}",
  "function getDefaultMinQty(bundle){return 1}",
  "function pickMinQty(bundle){try{var bid=String(bundle&&bundle.id||\"\").trim();var v=Number(selectedTierByBundleId[bid]);if(Number.isFinite(v)&&v>=1)return Math.floor(v);return 1}catch(e){return 1}}",
  "function pickPricingForQty(bundle,qty){try{var base=(bundle&&bundle.pricing&&bundle.pricing.base)||null;var tiers=(bundle&&bundle.pricing&&bundle.pricing.tiers)||[];var q=Math.max(1,Math.floor(Number(qty||1)));if(Array.isArray(tiers)&&tiers.length){var best=null;for(var i=0;i<tiers.length;i++){var t=tiers[i]||{};var mq=Math.max(1,Math.floor(Number(t.minQty||1)));if(mq===q)return t;if(mq<=q&&(best==null||mq>best.minQty))best=t}if(best)return best}return base}catch(e){return (bundle&&bundle.pricing&&bundle.pricing.base)||null}}",
  "function buildTierRows(bundle,bundleId,selectedMinQty,isBundleSelected){try{var tiers=(bundle&&bundle.offer&&bundle.offer.tiers)||[];var pricingTiers=(bundle&&bundle.pricing&&bundle.pricing.tiers)||[];var rows=[];if(Array.isArray(tiers)&&tiers.length){for(var i=0;i<tiers.length;i++){var mq=Math.max(1,Math.floor(Number(tiers[i]&&tiers[i].minQty||1)));var pr=null;for(var j=0;j<pricingTiers.length;j++){var pt=pricingTiers[j]||{};if(Math.floor(Number(pt.minQty||0))===mq){pr=pt;break}}rows.push({minQty:mq,pricing:pr})}}else{rows.push({minQty:1,pricing:pickPricingForQty(bundle,1)})}rows.sort(function(a,b){return a.minQty-b.minQty});var out='';for(var k=0;k<rows.length;k++){var r=rows[k];var prc=r.pricing||{};var o=Number(prc.originalTotal),f=Number(prc.finalTotal),d=Number(prc.discountAmount);var left='عند '+fmtNum(r.minQty)+' قطع';var right='';if(Number.isFinite(o)&&Number.isFinite(f)){right='قبل '+fmtMoney(o)+' • بعد '+fmtMoney(f);if(Number.isFinite(d)&&d>0){right+=' • وفّرت '+fmtMoney(d);var pct=pctFrom(o,f);if(pct!=null)right+=' ('+fmtNum(pct)+'%)'}}var active=Boolean(isBundleSelected&&Number(selectedMinQty)===Number(r.minQty));var cls='bundle-app-tier'+(active?' bundle-app-tier--selected':'');out+='<label class=\"'+cls+'\" data-bundle-id=\"'+escHtml(bundleId)+'\" data-tier-minqty=\"'+escHtml(r.minQty)+'\"><div class=\"bundle-app-tier-main\"><div><strong>'+escHtml(left)+'</strong></div>'+(right?('<div class=\"bundle-app-muted\">'+escHtml(right)+'</div>'):'')+'</div><span class=\"bundle-app-checkwrap bundle-app-tier-checkwrap\"><input class=\"bundle-app-tier-check\" type=\"checkbox\" data-bundle-id=\"'+escHtml(bundleId)+'\" data-tier-minqty=\"'+escHtml(r.minQty)+'\" '+(active?'checked':'')+' /><span class=\"bundle-app-checkmark\"></span></span></label>'+(active?('<div class=\"bundle-app-pickers bundle-app-pickers--inline\" data-bundle-id=\"'+escHtml(bundleId)+'\"></div>'):'')}return out}catch(e){return\"\"}}",
  "function normalizeItems(bundle){var comps=(bundle&&bundle.components)||[];if(!Array.isArray(comps)||!comps.length){comps=(bundle&&bundle.bundleItems)||[]}var out=[];var selected=pickMinQty(bundle);var baseQty=Math.max(1,Math.floor(Number(getPageQty()||1)));if(Number.isFinite(selected)&&selected>baseQty)baseQty=selected;for(var i=0;i<comps.length;i++){var c=comps[i]||{};var v=String(c.variantId||\"\").trim();var pid=String(c.productId||\"\").trim();var isBase=Boolean(c.isBase);var q=isBase?baseQty:Math.max(1,Math.floor(Number(c.quantity||1)));if(!v)continue;out.push({variantId:v,productId:pid||null,quantity:q,isBase:isBase})}out.sort(function(a,b){return String(a.variantId).localeCompare(String(b.variantId))});return out}",
  "function buildPriceText(bundle){try{var selected=pickMinQty(bundle);var baseQty=Math.max(1,Math.floor(Number(getPageQty()||1)));if(Number.isFinite(selected)&&selected>baseQty)baseQty=selected;var p=pickPricingForQty(bundle,baseQty);if(!p)return\"\";var o=Number(p.originalTotal),f=Number(p.finalTotal),d=Number(p.discountAmount);if(!Number.isFinite(o)||!Number.isFinite(f))return\"\";var s='قبل '+fmtMoney(o)+' • بعد '+fmtMoney(f);if(Number.isFinite(d)&&d>0)s+=' • وفّرت '+fmtMoney(d);return s}catch(e){return\"\"}}",
  "async function applyBundleSelection(bundle){var bid=String(bundle&&bundle.id||\"\");var trigger=String(bundle&&bundle.triggerProductId||\"\");if(!bid||!trigger)return;if(storeClosedNow()){messageByBundleId[bid]='لم يتم إضافة الباقة (المتجر مغلق حالياً)';applying=false;try{renderProductBanners(lastBundles||[])}catch(e0){}return}selectedBundleId=bid;applying=true;try{messageByBundleId[bid]='جاري إضافة الباقة...';renderProductBanners(lastBundles||[])}catch(e){}try{var rawItems=normalizeItems(bundle);var items=await resolveProductRefItems(rawItems,bid);if(!items||!items.length){messageByBundleId[bid]='لازم تختار الفاريانت قبل إضافة الباقة';applying=false;try{renderProductBanners(lastBundles||[])}catch(e0){}return}var prev=loadSelection(trigger);await tryClearCoupon();if(storeClosedNow()){messageByBundleId[bid]='لم يتم إضافة الباقة (المتجر مغلق حالياً)';applying=false;try{renderProductBanners(lastBundles||[])}catch(e0){}return}if(prev&&prev.bundleId&&String(prev.bundleId)!==bid&&Array.isArray(prev.items)&&prev.items.length){await removeItemsFromCart(prev.items)}if(storeClosedNow()){messageByBundleId[bid]='لم يتم إضافة الباقة (المتجر مغلق حالياً)';applying=false;try{renderProductBanners(lastBundles||[])}catch(e0){}return}try{await addItemsToCart(items)}catch(addErr){markStoreClosed(addErr);var hm=humanizeCartError(addErr);messageByBundleId[bid]=hm?('لم يتم إضافة الباقة ('+hm+')'):'لم يتم إضافة الباقة';applying=false;try{renderProductBanners(lastBundles||[])}catch(e9){}return}saveSelection(trigger,{bundleId:bid,triggerProductId:trigger,items:items,ts:Date.now()});var kind=String(bundle&&bundle.kind||\"\");if(kind==='often_bought_together'){clearPendingCoupon(trigger);messageByBundleId[bid]='تمت إضافة المنتجات معًا.';selectedBundleId=bid;applying=false;try{renderProductBanners(lastBundles||[])}catch(e10){}return}messageByBundleId[bid]='جاري تجهيز الخصم...';try{renderProductBanners(lastBundles||[])}catch(e2){}var res=await requestApplyBundle(bid,items.map(function(it){return{variantId:it.variantId,quantity:it.quantity}}));var hasDiscount=Boolean(res&&res.hasDiscount&&res.couponCode);var issueFailed=Boolean(res&&res.couponIssueFailed);if(hasDiscount){savePendingCoupon(trigger,{code:String(res.couponCode),ts:Date.now()});var ok=await tryApplyCoupon(String(res.couponCode));if(ok){clearPendingCoupon(trigger);messageByBundleId[bid]='تم تطبيق الخصم على السلة'}else{var st=null;var msg=\"\";try{st=g.BundleApp&&g.BundleApp._lastCouponApplyStatus}catch(x0){}try{msg=g.BundleApp&&g.BundleApp._lastCouponApplyMessage}catch(x1){}var stN=Number(st);var showErr=Number.isFinite(stN)&&(stN===410||stN===401||stN===403||stN===404);if(!showErr){var m0=String(msg||\"\");showErr=(m0==='timeout'||m0.indexOf('ERR_NAME_NOT_RESOLVED')!==-1||m0.indexOf('لم يعد متاحا')!==-1||m0.toLowerCase().indexOf('no longer available')!==-1)}var hm2=humanizeCartError({status:st,message:msg});if(showErr&&hm2){messageByBundleId[bid]='تمت إضافة الباقة لكن تعذر تطبيق الخصم ('+hm2+')'}else{messageByBundleId[bid]='تم تجهيز الكوبون، افتح السلة وسيتم تطبيقه تلقائيًا'}}}else if(issueFailed){messageByBundleId[bid]='تمت إضافة الباقة لكن تعذر إنشاء كوبون الخصم. حاول مرة أخرى.';clearPendingCoupon(trigger)}else{messageByBundleId[bid]='تمت إضافة الباقة.';clearPendingCoupon(trigger)}selectedBundleId=bid}catch(e){warn(\"bundle-app: apply bundle failed\",e&&((e.details)||e.message||e));var em=String((e&&e.message)||\"\").trim();if(em&&em.length>160)em=em.slice(0,160);messageByBundleId[bid]='حصل خطأ أثناء إضافة الباقة أو تطبيق الخصم'+(em?(' ('+em+')'):'')}applying=false;try{renderProductBanners(lastBundles||[])}catch(e){} }",
  "var lastBundles=null;",
  "async function refreshProduct(){var state=null;try{state=(g.BundleApp&&g.BundleApp.__refreshState)?g.BundleApp.__refreshState:(g.BundleApp.__refreshState={busy:false,queued:false,lastKey:\"\",lastSig:\"\"});if(state.busy){state.queued=true;return}state.busy=true;var variantId=findVariantId();var productId=findProductId();var key=variantId?('v:'+String(variantId)):productId?('p:'+String(productId)):\"\";log(\"bundle-app: ids\",{variantId:variantId,productId:productId});var res=null;if(variantId){res=await getProductBundlesByVariantId(variantId)}else if(productId){res=await getProductBundlesByProductId(productId)}else{clearProductBanner();state.lastKey=\"\";state.lastSig=\"\";return}var bundles=(res&&res.bundles)||[];if(!bundles.length){clearProductBanner();state.lastKey=key;state.lastSig=\"\";return}var sig='';for(var i=0;i<bundles.length;i++){var b=bundles[i]||{};sig+=String(b.id||i)+'|'+bundleVariantSig(b)+'|'+String(((b.pricing&&b.pricing.base&&b.pricing.base.finalTotal)!=null)?(b.pricing.base.finalTotal):'')+';'}if(!applying&&key===state.lastKey&&sig===state.lastSig)return;state.lastKey=key;state.lastSig=sig;lastBundles=bundles;renderProductBanners(bundles)}catch(e){warn(\"bundle-app: refresh failed\",e&&((e.details)||e.message||e));clearProductBanner()}finally{if(state){state.busy=false;if(state.queued){state.queued=false;setTimeout(function(){refreshProduct()},0)}}}}",
  "g.BundleApp.getProductBundlesByVariantId=getProductBundlesByVariantId;",
  "g.BundleApp.getProductBundlesByProductId=getProductBundlesByProductId;",
  "g.BundleApp.refreshProduct=refreshProduct;",
  "g.BundleApp.applyBundleSelection=applyBundleSelection;",
  "function renderProductBanners(bundles){ensureStyles();var id=\"bundle-app-banner\";var root=document.getElementById(id);if(!root){root=document.createElement(\"div\");root.id=id}mountBanner(root);var arr=Array.isArray(bundles)?bundles:[];if(!arr.length){clearProductBanner();return}var trigger=String(arr[0]&&arr[0].triggerProductId||\"\");lastTriggerProductId=trigger||lastTriggerProductId;if(selectedBundleId){var ok=false;for(var z0=0;z0<arr.length;z0++){if(String(arr[z0]&&arr[z0].id||\"\")===String(selectedBundleId||\"\")){ok=true;break}}if(!ok)selectedBundleId=null}var html='';for(var i=0;i<arr.length;i++){var b=arr[i]||{};var bid=String(b.id||\"\");var color=String(b.bannerColor||\"#0ea5e9\");var textColor=String(b.textColor||\"#ffffff\");var title=normalizeTitle(b.title);var subtitle=String(b.subtitle||\"\");var label=String(b.label||\"\");var labelSub=String(b.labelSub||\"\");var labelBg=String(b.labelBgColor||b.badgeColor||\"\");var labelText=String(b.labelTextColor||textColor||\"\");var ctaBg=String(b.ctaBgColor||\"\");var ctaText=String(b.ctaTextColor||\"\");var showItems=(b&&b.showItems===false)?false:true;var showPrice=(b&&b.showPrice===false)?false:true;var showTiers=(b&&b.showTiers===false)?false:true;var checked=bid===String(selectedBundleId||\"\");var selectedMinQty=pickMinQty(b);var items=normalizeItems(b);var itemsText=(showItems&&items.length)?buildItemsText(items):'';var priceText=showPrice?buildPriceText(b):'';var tiersHtml=showTiers?buildTierRows(b,bid,selectedMinQty,checked):'';var msg=String(messageByBundleId[bid]||\"\");var cls='bundle-app-card'+(checked?' bundle-app-card--selected':'');var btnLabel=String(b.cta||\"أضف الباقة\");if(tiersHtml){btnLabel=btnLabel+' ('+fmtNum(Math.max(getPageQty(),Math.max(minRequiredBaseQty(b),selectedMinQty)))+' قطع)'}var cardStyle='background:'+escHtml(color)+';color:'+escHtml(textColor)+';';var btnStyle='';if(ctaBg)btnStyle+='background:'+escHtml(ctaBg)+';';if(ctaText)btnStyle+='color:'+escHtml(ctaText)+';';var labelStyle='';if(labelBg)labelStyle+='background:'+escHtml(labelBg)+';';else labelStyle+='background:rgba(255,255,255,.18);';if(labelText)labelStyle+='color:'+escHtml(labelText)+';';html+='<div class=\"'+cls+'\" style=\"'+cardStyle+'\" data-bundle-id=\"'+escHtml(bid)+'\"><div class=\"bundle-app-row\"><div class=\"bundle-app-content\"><div class=\"bundle-app-head\"><div style=\"min-width:0\"><div class=\"bundle-app-title\">'+escHtml(title)+'</div>'+(subtitle?('<div class=\"bundle-app-subtitle\">'+escHtml(subtitle)+'</div>'):'')+(labelSub?('<div class=\"bundle-app-label-sub\">'+escHtml(labelSub)+'</div>'):'')+'</div>'+(label?('<div class=\"bundle-app-label\" style=\"'+labelStyle+'\">'+escHtml(label)+'</div>'):'')+'</div>'+(itemsText?('<div class=\"bundle-app-items\">'+escHtml(itemsText)+'</div>'):'')+(priceText?('<div class=\"bundle-app-price\">'+escHtml(priceText)+'</div>'):'')+(msg?('<div class=\"bundle-app-msg\">'+escHtml(msg)+'</div>'):'')+'</div><button class=\"bundle-app-btn\" type=\"button\" data-action=\"apply-one\" data-bundle-id=\"'+escHtml(bid)+'\" '+(applying?'disabled':'')+(btnStyle?(' style=\"'+btnStyle+'\"'):'')+'>'+escHtml(btnLabel)+'</button></div>'+(tiersHtml?('<div class=\"bundle-app-tiers\">'+tiersHtml+'</div>'):'')+'</div>'}root.innerHTML=html;var tierChecks=root.querySelectorAll('input.bundle-app-tier-check[data-bundle-id][data-tier-minqty]');for(var tc=0;tc<tierChecks.length;tc++){(function(el){el.onchange=function(){var bid=String(el.getAttribute('data-bundle-id')||\"\");var mq=Number(el.getAttribute('data-tier-minqty'));if(!bid||!Number.isFinite(mq)||mq<1)return;var next=Math.floor(mq);if(el.checked){selectedBundleId=bid;selectedTierByBundleId[bid]=next;messageByBundleId[bid]=''}else{var cur=Number(selectedTierByBundleId[bid]);if(String(selectedBundleId||\"\")===bid&&Number.isFinite(cur)&&Math.floor(cur)===next){selectedBundleId=null}}renderProductBanners(arr)}})(tierChecks[tc])}var btns=root.querySelectorAll('button.bundle-app-btn[data-action=\"apply-one\"][data-bundle-id]');for(var k=0;k<btns.length;k++){(function(btn){btn.onclick=function(){var bid=String(btn.getAttribute('data-bundle-id')||\"\");if(!bid||applying)return;selectedBundleId=bid;var bundle=null;for(var i=0;i<arr.length;i++){if(String(arr[i]&&arr[i].id||\"\")===bid){bundle=arr[i];break}}if(!bundle)return;applyBundleSelection(bundle)}})(btns[k])}if(selectedBundleId){var selCard=null;var cards=root.querySelectorAll('.bundle-app-card[data-bundle-id]');for(var ci=0;ci<cards.length;ci++){var c0=cards[ci];if(String(c0.getAttribute('data-bundle-id')||\"\")===String(selectedBundleId||\"\")){selCard=c0;break}}var selBundle=null;for(var s0=0;s0<arr.length;s0++){if(String(arr[s0]&&arr[s0].id||\"\")===String(selectedBundleId||\"\")){selBundle=arr[s0];break}}if(selCard&&selBundle){ensureVariantPickersForCard(selCard,selBundle)}}}initOnce();",
  "})();",
];
