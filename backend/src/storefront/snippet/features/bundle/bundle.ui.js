module.exports = [
  'var scriptSrc=(document.currentScript&&document.currentScript.src)||"";',
  "if(!scriptSrc){try{var ss=document.getElementsByTagName(\"script\");for(var i=0;i<ss.length;i++){var s=ss[i];var src=(s&&s.src)||\"\";if(!src)continue;if(src.indexOf(\"/api/storefront/snippet.js\")!==-1&&src.indexOf(\"merchantId=\"+encodeURIComponent(merchantId))!==-1){scriptSrc=src;break}}}catch(e){}}",
  "function findVariantId(){try{var url=new URL(window.location.href);var fromUrl=url.searchParams.get(\"variant_id\")||url.searchParams.get(\"variantId\")||url.searchParams.get(\"variant\")||\"\";if(fromUrl)return String(fromUrl).trim();var el=document.querySelector('[name=\"variant_id\"],[name=\"variantId\"],[data-variant-id],input[name=\"variant_id\"],select[name=\"variant_id\"]');if(el){var v=el.getAttribute(\"data-variant-id\")||el.value||\"\";v=String(v).trim();if(v)return v}var any=document.querySelector(\"[data-variant-id]\");if(any){var a=String(any.getAttribute(\"data-variant-id\")||\"\").trim();if(a)return a}return\"\"}catch(e){return\"\"}}",
  "function findProductId(){try{var path=String(window.location.pathname||\"\");var m=path.match(/\\/p(\\d+)(?:[/?#]|$)/);if(m&&m[1])return String(m[1]);var el=document.querySelector(\"[data-product-id],input[name=\\\"product_id\\\"],input[name=\\\"productId\\\"]\");if(el){var v=el.getAttribute(\"data-product-id\")||el.value||\"\";v=String(v).trim();if(v)return v}return\"\"}catch(e){return\"\"}}",
  "function openPickerModal(titleHtml,bodyHtml){var resolver=null;var wait=new Promise(function(r){resolver=r});var overlay=document.createElement(\"div\");overlay.id=\"bundle-app-modal\";overlay.style.position=\"fixed\";overlay.style.inset=\"0\";overlay.style.background=\"rgba(0,0,0,.45)\";overlay.style.zIndex=\"100000\";overlay.style.display=\"flex\";overlay.style.alignItems=\"center\";overlay.style.justifyContent=\"center\";overlay.style.padding=\"16px\";var card=document.createElement(\"div\");card.style.width=\"min(520px,100%)\";card.style.maxHeight=\"80vh\";card.style.overflow=\"auto\";card.style.background=\"#fff\";card.style.borderRadius=\"14px\";card.style.boxShadow=\"0 12px 40px rgba(0,0,0,.25)\";card.style.padding=\"12px\";card.innerHTML='<div style=\"display:flex;align-items:center;justify-content:space-between;gap:10px\"><div style=\"font-weight:900;font-size:14px\">'+titleHtml+'</div><button type=\"button\" data-action=\"close\" style=\"border:0;background:transparent;font-size:18px;line-height:1;cursor:pointer\">×</button></div><div style=\"margin-top:10px\">'+bodyHtml+'</div>';overlay.appendChild(card);function close(val){try{overlay.remove()}catch(e){}if(resolver){var r=resolver;resolver=null;r(val)}}overlay.addEventListener(\"click\",function(e){if(e.target===overlay)close(null)});var closeBtn=card.querySelector('button[data-action=\"close\"]');if(closeBtn)closeBtn.onclick=function(){close(null)};document.body.appendChild(overlay);return {overlay:overlay,card:card,close:close,wait:wait}}",
  "async function resolveProductRefItems(items,bundleId){var bid=String(bundleId||\"\").trim();var pre=(bid&&variantSelectionsByBundleId[bid]&&typeof variantSelectionsByBundleId[bid]===\"object\")?variantSelectionsByBundleId[bid]:null;var arr=Array.isArray(items)?items:[];var needs=[];var fixed=[];for(var i=0;i<arr.length;i++){var it=arr[i]||{};var v=String(it.variantId||\"\").trim();var qty=Math.max(1,Math.floor(Number(it.quantity||1)));var pid=String(it.productId||\"\").trim();if(isProductRef(v)){if(!pid)return null;needs.push({productId:pid,quantity:qty})}else{if(!v)continue;fixed.push({variantId:v,productId:pid||null,quantity:qty})}}if(!needs.length)return fixed;var units=[];var uniqPid={};for(var j=0;j<needs.length;j++){var n=needs[j];var pid2=String(n.productId);uniqPid[pid2]=true;for(var u=0;u<Number(n.quantity||0);u++){units.push({productId:pid2,key:pid2+\":\"+u})}}var pidList=Object.keys(uniqPid);var varsByPid={};for(var p=0;p<pidList.length;p++){var pid3=pidList[p];var vars=await getCachedVariants(pid3);varsByPid[pid3]=Array.isArray(vars)?vars:[];if(!varsByPid[pid3].length){varsByPid[pid3]=[{variantId:('product:'+pid3),productId:pid3,cartProductId:pid3,cartOptions:null,isActive:true,name:null,attributes:{},imageUrl:null,price:null}]}}var selectedByKey={};var pending=[];for(var k=0;k<units.length;k++){var unit=units[k];var vlist=(varsByPid[unit.productId]||[]).filter(function(x){return x&&x.isActive===true&&String(x.variantId||\"\").trim()});var preVal=pre?String(pre[unit.key]||\"\").trim():\"\";if(preVal){var ok=false;for(var z=0;z<vlist.length;z++){if(String(vlist[z]&&vlist[z].variantId||\"\").trim()===preVal){ok=true;break}}if(ok){selectedByKey[unit.key]=preVal;continue}}if(vlist.length===1){selectedByKey[unit.key]=String(vlist[0].variantId||\"\").trim()}else{pending.push(unit)}}if(pending.length){var body='';for(var x=0;x<pending.length;x++){var un=pending[x];var opts=(varsByPid[un.productId]||[]).filter(function(y){return y&&y.isActive===true&&String(y.variantId||\"\").trim()});var preVal2=pre?String(pre[un.key]||\"\").trim():\"\";if(preVal2)selectedByKey[un.key]=preVal2;body+='<div style=\"margin-bottom:10px;padding:10px;border:1px solid #e5e7eb;border-radius:12px\"><div style=\"font-weight:800;font-size:12px;margin-bottom:6px\">اختر الفاريانت (قطعة '+fmtNum(x+1)+')</div><select data-key=\"'+escHtml(un.key)+'\" style=\"width:100%;padding:10px;border-radius:10px;border:1px solid #d1d5db\">';body+='<option value=\"\">— اختر —</option>';for(var o=0;o<opts.length;o++){var vv=opts[o]||{};var vid=String(vv.variantId||\"\").trim();if(!vid)continue;body+='<option value=\"'+escHtml(vid)+'\"'+(preVal2&&preVal2===vid?' selected':'')+'>'+escHtml(variantLabel(vv))+'</option>'}body+='</select></div>'}body+='<div style=\"display:flex;gap:10px;justify-content:flex-end\"><button type=\"button\" data-action=\"cancel\" style=\"padding:10px 12px;border-radius:12px;border:1px solid #d1d5db;background:#fff;cursor:pointer\">إلغاء</button><button type=\"button\" data-action=\"confirm\" disabled style=\"padding:10px 12px;border-radius:12px;border:0;background:#111827;color:#fff;cursor:pointer;opacity:.6\">تأكيد</button></div>';var modal=openPickerModal('اختيار الفاريانت',body);if(!modal)return null;var card=modal.card;var confirm=card.querySelector('button[data-action=\"confirm\"]');var cancel=card.querySelector('button[data-action=\"cancel\"]');function recompute(){var selects=card.querySelectorAll('select[data-key]');var ok=true;for(var i2=0;i2<selects.length;i2++){var s=selects[i2];var val=String(s.value||\"\").trim();if(!val){ok=false;break}}if(confirm){confirm.disabled=!ok;confirm.style.opacity=ok?'1':'.6'}}card.addEventListener('change',function(e){var t=e&&e.target;if(!t||t.tagName!=='SELECT')return;var key=String(t.getAttribute('data-key')||\"\");if(!key)return;selectedByKey[key]=String(t.value||\"\").trim();recompute()});recompute();if(cancel)cancel.onclick=function(){modal.close(null)};if(confirm)confirm.onclick=function(){modal.close(true)};var done=await modal.wait;if(!done)return null}if(bid){var store=getBundleVariantSelectionMap(bid);if(store){for(var sk in selectedByKey){if(!Object.prototype.hasOwnProperty.call(selectedByKey,sk))continue;var sv=String(selectedByKey[sk]||\"\").trim();if(!sv)continue;store[sk]=sv}}}var metaByVid={};for(var m0=0;m0<pidList.length;m0++){var mp=pidList[m0];var ml=varsByPid[mp]||[];for(var m1=0;m1<ml.length;m1++){var mv=ml[m1]||{};var mid=String(mv.variantId||\"\").trim();if(!mid)continue;if(!metaByVid[mid])metaByVid[mid]=mv}}var count={};for(var kk in selectedByKey){if(!Object.prototype.hasOwnProperty.call(selectedByKey,kk))continue;var vid2=String(selectedByKey[kk]||\"\").trim();if(!vid2)continue;count[vid2]=(count[vid2]||0)+1}var out=fixed.slice();for(var vidKey in count){if(!Object.prototype.hasOwnProperty.call(count,vidKey))continue;var m=metaByVid[vidKey]||null;out.push({variantId:String(vidKey),productId:m&&m.productId?String(m.productId):null,cartProductId:m&&m.cartProductId?String(m.cartProductId):null,cartOptions:(m&&m.cartOptions)?m.cartOptions:null,quantity:Math.max(1,Math.floor(Number(count[vidKey]||1)))})}out.sort(function(a,b){return String(a.variantId).localeCompare(String(b.variantId))});return out}",
  "function applySelectionsToContainer(container,bundleId){try{if(!container)return;var bid=String(bundleId||\"\").trim();if(!bid)return;var sel=getBundleVariantSelectionMap(bid)||{};var rows=container.querySelectorAll('[data-unit-key-row]');for(var i=0;i<rows.length;i++){var row=rows[i];var key=String(row.getAttribute('data-unit-key-row')||\"\").trim();if(!key)continue;var val=String(sel[key]||\"\").trim();var btns=row.querySelectorAll('button[data-action=\"pick-variant\"][data-variant-id]');for(var j=0;j<btns.length;j++){var b=btns[j];var vid=String(b.getAttribute('data-variant-id')||\"\").trim();var on=Boolean(val&&vid&&val===vid);if(on){b.classList.add('is-selected');b.setAttribute('aria-pressed','true')}else{b.classList.remove('is-selected');b.setAttribute('aria-pressed','false')}}}}catch(e){}}",
  "function updatePickerStatus(container,bundleId){try{if(!container)return;var bid=String(bundleId||\"\").trim();if(!bid)return;var sel=getBundleVariantSelectionMap(bid)||{};var rows=container.querySelectorAll('[data-unit-key-row]');var total=rows.length;var chosen=0;for(var i=0;i<rows.length;i++){var key=String(rows[i].getAttribute('data-unit-key-row')||\"\").trim();if(!key)continue;var v=String(sel[key]||\"\").trim();if(v)chosen++}var el=container.querySelector('[data-role=\"picker-status\"]');if(el)el.textContent=total?('تم اختيار '+fmtNum(chosen)+' من '+fmtNum(total)):''}catch(e){}}",
  "function bindPickerContainer(container,bundleId){try{if(!container)return;var bid=String(bundleId||\"\").trim();if(!bid)return;container.onclick=function(e){var t=e&&e.target;while(t&&t!==container){if(t&&t.getAttribute&&t.getAttribute('data-action')==='pick-variant')break;t=t.parentNode}if(!t||t===container)return;var key=String(t.getAttribute('data-unit-key')||\"\").trim();var val=String(t.getAttribute('data-variant-id')||\"\").trim();if(!key||!val)return;var sel=getBundleVariantSelectionMap(bid);if(!sel)return;sel[key]=val;applySelectionsToContainer(container,bid);updatePickerStatus(container,bid)};applySelectionsToContainer(container,bid);updatePickerStatus(container,bid)}catch(e){}}",
  "async function ensureVariantPickersForCard(card,bundle){try{if(!card||!bundle)return;ensurePickerStyles();var bid=String(card.getAttribute('data-bundle-id')||\"\").trim();if(!bid)return;var container=card.querySelector('.bundle-app-pickers[data-bundle-id]');if(!container)return;var sig=bundleVariantSig(bundle);var cached=variantPickerCacheByBundleId[bid];if(cached&&cached.sig===sig&&cached.html!=null){container.innerHTML=cached.html;bindPickerContainer(container,bid);return}var pending=variantPickerPendingByBundleId[bid];if(pending&&pending.sig===sig&&pending.promise)return;container.innerHTML='<div class=\"bundle-app-picker-hint\">جاري تحميل الفاريانت...</div>';var promise=(async function(){var units=bundleVariantUnits(bundle);var sel=getBundleVariantSelectionMap(bid);if(!units.length){variantPickerCacheByBundleId[bid]={sig:sig,html:\"\"};container.innerHTML='';return}pruneBundleSelections(sel,units);var uniq={};for(var i=0;i<units.length;i++){uniq[String(units[i].productId)]=true}var pids=Object.keys(uniq);var lists=await Promise.all(pids.map(function(pid){return getCachedVariants(pid)}));var varsByPid={};for(var j=0;j<pids.length;j++){var pid=pids[j];var list=Array.isArray(lists[j])?lists[j]:[];list=list.filter(function(x){return x&&x.isActive===true&&String(x.variantId||\"\").trim()});if(!list.length){list=[{variantId:('product:'+pid),productId:pid,cartProductId:pid,cartOptions:null,isActive:true,name:null,attributes:{},imageUrl:null,price:null}]}varsByPid[pid]=list}var need=[];for(var k=0;k<units.length;k++){var unit=units[k];var list2=varsByPid[unit.productId]||[];if(list2.length===1){var only=list2[0]||{};var vid=String(only.variantId||\"\").trim();if(vid)sel[unit.key]=vid}else if(list2.length>1){need.push(unit)}}if(!need.length){variantPickerCacheByBundleId[bid]={sig:sig,html:\"\"};container.innerHTML='';return}var html='<div class=\"bundle-app-pickers-title\">اختيار الفاريانت للكميات</div><div class=\"bundle-app-picker-status\" data-role=\"picker-status\"></div>';for(var n=0;n<need.length;n++){var unit2=need[n];var list3=varsByPid[unit2.productId]||[];var current=String(sel[unit2.key]||\"\").trim();var pos=String(unit2.key||\"\").indexOf(\":\");var idx=(pos>=0)?(Number(String(unit2.key).slice(pos+1))+1):(n+1);if(!Number.isFinite(idx)||idx<1)idx=n+1;html+='<div class=\"bundle-app-picker-row\" data-unit-key-row=\"'+escHtml(unit2.key)+'\"><div class=\"bundle-app-picker-label\">قطعة '+fmtNum(idx)+'</div><div class=\"bundle-app-variant-options\">';for(var o=0;o<list3.length;o++){var vv=list3[o]||{};var ov=String(vv.variantId||\"\").trim();if(!ov)continue;var on=(current&&current===ov);html+='<button type=\"button\" class=\"bundle-app-variant-btn'+(on?' is-selected':'')+'\" data-action=\"pick-variant\" data-unit-key=\"'+escHtml(unit2.key)+'\" data-variant-id=\"'+escHtml(ov)+'\" aria-pressed=\"'+(on?'true':'false')+'\">'+variantOptionInnerHtml(vv)+'</button>'}html+='</div></div>'}variantPickerCacheByBundleId[bid]={sig:sig,html:html};container.innerHTML=html;bindPickerContainer(container,bid)})();variantPickerPendingByBundleId[bid]={sig:sig,promise:promise};await promise;variantPickerPendingByBundleId[bid]=null}catch(e){}}",
  "async function resolveProductRefItems(items,bundleId){var bid=String(bundleId||\"\").trim();var arr=Array.isArray(items)?items:[];var needs=[];var fixed=[];var units=[];var uniqPid={};for(var i=0;i<arr.length;i++){var it=arr[i]||{};var v=String(it.variantId||\"\").trim();var qty=Math.max(1,Math.floor(Number(it.quantity||1)));var pid=String(it.productId||\"\").trim();if(isProductRef(v)){if(!pid)return null;needs.push({productId:pid,quantity:qty});for(var u=0;u<qty;u++){units.push({productId:pid,key:pid+\":\"+u})}uniqPid[pid]=true}else{if(!v)continue;fixed.push({variantId:v,productId:pid||null,quantity:qty})}}if(!needs.length)return fixed;var varsByPid={};var pidList=Object.keys(uniqPid);for(var p=0;p<pidList.length;p++){var pid3=pidList[p];var vr=await getCachedVariants(pid3);var list=Array.isArray(vr)?vr:[];list=list.filter(function(x){return x&&x.isActive===true&&String(x.variantId||\"\").trim()});if(!list.length){list=[{variantId:('product:'+pid3),productId:pid3,cartProductId:pid3,cartOptions:null,isActive:true,name:null,attributes:{},imageUrl:null,price:null}]}varsByPid[pid3]=list}var sel=getBundleVariantSelectionMap(bid)||{};pruneBundleSelections(sel,units);var pending=[];for(var k=0;k<units.length;k++){var unit=units[k];var vlist=varsByPid[unit.productId]||[];if(vlist.length===1){var only=vlist[0]||{};var vid=String(only.variantId||\"\").trim();if(vid)sel[unit.key]=vid}else{var chosen=String(sel[unit.key]||\"\").trim();var ok=false;if(chosen){for(var z=0;z<vlist.length;z++){if(String(vlist[z]&&vlist[z].variantId||\"\").trim()===chosen){ok=true;break}}}if(!ok)pending.push(unit)}}if(pending.length)return null;var metaByVid={};for(var m0=0;m0<pidList.length;m0++){var mp=pidList[m0];var ml=varsByPid[mp]||[];for(var m1=0;m1<ml.length;m1++){var mv=ml[m1]||{};var mid=String(mv.variantId||\"\").trim();if(!mid)continue;if(!metaByVid[mid])metaByVid[mid]=mv}}var count={};for(var kk in sel){if(!Object.prototype.hasOwnProperty.call(sel,kk))continue;var vid2=String(sel[kk]||\"\").trim();if(!vid2)continue;count[vid2]=(count[vid2]||0)+1}var out=fixed.slice();for(var vidKey in count){if(!Object.prototype.hasOwnProperty.call(count,vidKey))continue;var m=metaByVid[vidKey]||null;out.push({variantId:String(vidKey),productId:(m&&m.productId)?String(m.productId):null,cartProductId:(m&&m.cartProductId)?String(m.cartProductId):null,cartOptions:(m&&m.cartOptions)?m.cartOptions:null,quantity:Math.max(1,Math.floor(Number(count[vidKey]||1)))})}out.sort(function(a,b){return String(a.variantId).localeCompare(String(b.variantId))});return out}",
  "function findBannerMount(){try{var priceSelectors=['[data-testid=\"product-price\"]','.salla-product-price','.product-price','[class*=\"product-price\"]','[data-testid=\"product-price-value\"]','[data-price]','.price','[class*=\"price\"]'];for(var i=0;i<priceSelectors.length;i++){var el=document.querySelector(priceSelectors[i]);if(!el)continue;var host=el.closest('[data-testid=\"product-price\"],.salla-product-price,.product-price,[class*=\"product-price\"]')||el;var ins=host;try{var cur=host;for(var step=0;step<8;step++){var p=cur&&cur.parentNode;if(!p||p.nodeType!==1||typeof window.getComputedStyle!==\"function\")break;var cs=window.getComputedStyle(p);var d=cs&&cs.display;var fd=cs&&cs.flexDirection;var fw=cs&&cs.flexWrap;if(d===\"flex\"&&fd&&fd.indexOf(\"row\")!==-1){ins=p;if(fw===\"nowrap\"){cur=p;continue}}break}}catch(x0){}return{el:ins,where:\"after\"}}var btnSelectors=['[data-testid=\"add-to-cart\"]','button[name=\"add-to-cart\"]','button[type=\"submit\"]','.salla-add-to-cart-button','.add-to-cart'];for(var j=0;j<btnSelectors.length;j++){var b=document.querySelector(btnSelectors[j]);if(b)return{el:b,where:\"before\"}}return null}catch(e){return null}}",
  "function mountBanner(root){try{var m=findBannerMount();if(m&&m.el&&m.el.parentNode){root.className=\"bundle-app-container bundle-app-banner--inline\";try{root.style.display=\"block\";root.style.width=\"100%\";root.style.maxWidth=\"100%\";root.style.boxSizing=\"border-box\";root.style.gridColumn=\"1 / -1\";root.style.justifySelf=\"stretch\";root.style.alignSelf=\"stretch\";root.style.flex=\"0 0 100%\";root.style.flexBasis=\"100%\";root.style.clear=\"both\"}catch(x0){}if(m.where===\"before\"){m.el.parentNode.insertBefore(root,m.el)}else{m.el.parentNode.insertBefore(root,m.el.nextSibling)}return true}}catch(e){}try{warn(\"bundle-app: mountBanner failed; skipping fallback\") }catch(_e){}return false}",
  "function applyPerProductSelections(container,bundleId,keysByPid){try{if(!container)return;var bid=String(bundleId||\"\").trim();if(!bid)return;var sel=getBundleVariantSelectionMap(bid)||{};var rows=container.querySelectorAll('[data-product-id-row]');for(var i=0;i<rows.length;i++){var row=rows[i];var pid=String(row.getAttribute('data-product-id-row')||\"\").trim();if(!pid)continue;var keys=keysByPid[pid]||[];var current=\"\";for(var z=0;z<keys.length;z++){var pv=String(sel[keys[z]]||\"\").trim();if(pv){current=pv;break}}var btns=row.querySelectorAll('button[data-action=\"pick-variant\"][data-variant-id]');for(var j=0;j<btns.length;j++){var b=btns[j];var vid=String(b.getAttribute('data-variant-id')||\"\").trim();var on=Boolean(current&&vid&&current===vid);if(on){b.classList.add('is-selected');b.setAttribute('aria-pressed','true')}else{b.classList.remove('is-selected');b.setAttribute('aria-pressed','false')}}}}catch(e){}}",
  "function updatePerProductStatus(container,bundleId,keysByPid){try{if(!container)return;var bid=String(bundleId||\"\").trim();if(!bid)return;var sel=getBundleVariantSelectionMap(bid)||{};var rows=container.querySelectorAll('[data-product-id-row]');var total=rows.length;var chosen=0;for(var i=0;i<rows.length;i++){var pid=String(rows[i].getAttribute('data-product-id-row')||\"\").trim();if(!pid)continue;var keys=keysByPid[pid]||[];var has=false;for(var z=0;z<keys.length;z++){var v=String(sel[keys[z]]||\"\").trim();if(v){has=true;break}}if(has)chosen++}var el=container.querySelector('[data-role=\"picker-status\"]');if(el)el.textContent=total?('تم اختيار '+fmtNum(chosen)+' من '+fmtNum(total)+' منتج'):''}catch(e){}}",
  "function bindPerProductPickerContainer(container,bundleId,keysByPid){try{if(!container)return;var bid=String(bundleId||\"\").trim();if(!bid)return;container.onclick=function(e){var t=e&&e.target;while(t&&t!==container){if(t&&t.getAttribute&&t.getAttribute('data-action')==='pick-variant')break;t=t.parentNode}if(!t||t===container)return;var pid=String(t.getAttribute('data-product-id')||\"\").trim();var val=String(t.getAttribute('data-variant-id')||\"\").trim();if(!pid||!val)return;var sel=getBundleVariantSelectionMap(bid);if(!sel)return;var keys=keysByPid[pid]||[];for(var i=0;i<keys.length;i++){sel[keys[i]]=val}applyPerProductSelections(container,bid,keysByPid);updatePerProductStatus(container,bid,keysByPid)};applyPerProductSelections(container,bid,keysByPid);updatePerProductStatus(container,bid,keysByPid)}catch(e){}}",
  "async function ensureVariantPickersPerProductForCard(card,bundle){try{if(!card||!bundle)return;ensurePickerStyles();var bid=String(card.getAttribute('data-bundle-id')||\"\").trim();if(!bid)return;var container=card.querySelector('.bundle-app-pickers[data-bundle-id]');if(!container)return;var sig=bundleVariantSig(bundle);var cached=variantPickerCacheByBundleId[bid];if(cached&&cached.sig===sig&&cached.html_per_product!=null){container.innerHTML=cached.html_per_product;try{var _keys=cached.keysByPid||{}}catch(_e){var _keys={}}bindPerProductPickerContainer(container,bid,_keys);return}var units=bundleVariantUnits(bundle);var sel=getBundleVariantSelectionMap(bid);if(!units.length){variantPickerCacheByBundleId[bid]={sig:sig,html_per_product:\"\",keysByPid:{}};container.innerHTML='';return}pruneBundleSelections(sel,units);var keysByPid={};var uniq={};for(var i=0;i<units.length;i++){var u=units[i];var pid=String(u.productId||\"\");uniq[pid]=true;if(!keysByPid[pid])keysByPid[pid]=[];keysByPid[pid].push(String(u.key))}var pids=Object.keys(uniq);var lists=await Promise.all(pids.map(function(pid){return getCachedVariants(pid)}));var varsByPid={};for(var j=0;j<pids.length;j++){var pid=pids[j];var list=Array.isArray(lists[j])?lists[j]:[];list=list.filter(function(x){return x&&x.isActive===true&&String(x.variantId||\"\").trim()});if(!list.length){list=[{variantId:('product:'+pid),productId:pid,cartProductId:pid,cartOptions:null,isActive:true,name:null,attributes:{},imageUrl:null,price:null}]}varsByPid[pid]=list}var needPids=[];for(var k=0;k<pids.length;k++){var pid2=pids[k];var list2=varsByPid[pid2]||[];if(list2.length===1){var only=list2[0]||{};var vid=String(only.variantId||\"\").trim();if(vid){var keys=keysByPid[pid2]||[];for(var u0=0;u0<keys.length;u0++){sel[keys[u0]]=vid}}}else if(list2.length>1){needPids.push(pid2)}}if(!needPids.length){variantPickerCacheByBundleId[bid]={sig:sig,html_per_product:\"\",keysByPid:keysByPid};container.innerHTML='';return}var html='<div class=\"bundle-app-pickers-title\">اختيار الفاريانت لكل منتج</div><div class=\"bundle-app-picker-status\" data-role=\"picker-status\"></div>';for(var n=0;n<needPids.length;n++){var pid3=needPids[n];var list3=varsByPid[pid3]||[];var keys3=keysByPid[pid3]||[];var current=\"\";for(var z0=0;z0<keys3.length;z0++){var pv=String(sel[keys3[z0]]||\"\").trim();if(pv){current=pv;break}}html+='<div class=\"bundle-app-picker-row\" data-product-id-row=\"'+escHtml(pid3)+'\"><div class=\"bundle-app-picker-label\">المنتج '+fmtNum(n+1)+'</div><div class=\"bundle-app-variant-options\">';for(var o=0;o<list3.length;o++){var vv=list3[o]||{};var ov=String(vv.variantId||\"\").trim();if(!ov)continue;var on=(current&&current===ov);html+='<button type=\"button\" class=\"bundle-app-variant-btn'+(on?' is-selected':'')+'\" data-action=\"pick-variant\" data-product-id=\"'+escHtml(pid3)+'\" data-variant-id=\"'+escHtml(ov)+'\" aria-pressed=\"'+(on?'true':'false')+'\">'+variantOptionInnerHtml(vv)+'</button>'}html+='</div></div>'}variantPickerCacheByBundleId[bid]={sig:sig,html_per_product:html,keysByPid:keysByPid};container.innerHTML=html;bindPerProductPickerContainer(container,bid,keysByPid)}catch(e){}}",
  "try{if(typeof ensureVariantPickersPerProductForCard==='function'){ensureVariantPickersForCard=ensureVariantPickersPerProductForCard}}catch(e){}",
  "function getPageQty(){try{var selectors=['input[name=\"quantity\"][type=\"number\"]','input[name=\"qty\"][type=\"number\"]','input.qty[type=\"number\"]','select[name=\"quantity\"]','select[name=\"qty\"]'];for(var i=0;i<selectors.length;i++){var el=document.querySelector(selectors[i]);if(!el)continue;var raw=el.value;var n=Math.floor(Number(raw));if(Number.isFinite(n)&&n>0)return n}return 1}catch(e){return 1}}",
  "async function tryClearCoupon(){if(storeClosedNow())return false;try{var cart=window.salla&&window.salla.cart;if(cart&&cart.coupon&&typeof cart.coupon.remove===\"function\"){await cart.coupon.remove();return true}if(cart&&typeof cart.removeCoupon===\"function\"){await cart.removeCoupon();return true}if(cart&&typeof cart.clearCoupon===\"function\"){await cart.clearCoupon();return true}if(cart&&cart.coupon&&typeof cart.coupon.set===\"function\"){await cart.coupon.set(\"\");return true}if(cart&&typeof cart.applyCoupon===\"function\"){try{await cart.applyCoupon(\"\");return true}catch(e){markStoreClosed(e);if(storeClosedNow())return false}}}catch(e){markStoreClosed(e);warn(\"bundle-app: clear coupon failed\",e&&((e.details)||e.message||e))}return false}",
  "function renderProductBanners(bundles){ensureStyles();var id=\"bundle-app-banner\";var root=document.getElementById(id);if(!root){root=document.createElement(\"div\");root.id=id}mountBanner(root);var arr=Array.isArray(bundles)?bundles:[];if(!arr.length){clearProductBanner();return}var trigger=String(arr[0]&&arr[0].triggerProductId||\"\");lastTriggerProductId=trigger||lastTriggerProductId;if(selectedBundleId){var ok=false;for(var z0=0;z0<arr.length;z0++){if(String(arr[z0]&&arr[z0].id||\"\")===String(selectedBundleId||\"\")){ok=true;break}}if(!ok)selectedBundleId=null}var html='';for(var i=0;i<arr.length;i++){var b=arr[i]||{};var bid=String(b.id||\"\");var color=String(b.bannerColor||\"#0ea5e9\");var textColor=String(b.textColor||\"#ffffff\");var title=normalizeTitle(b.title);var subtitle=String(b.subtitle||\"\");var label=String(b.label||\"\");var labelSub=String(b.labelSub||\"\");var labelBg=String(b.labelBgColor||b.badgeColor||\"\");var labelText=String(b.labelTextColor||textColor||\"\");var ctaBg=String(b.ctaBgColor||\"\");var ctaText=String(b.ctaTextColor||\"\");var showItems=(b&&b.showItems===false)?false:true;var showPrice=(b&&b.showPrice===false)?false:true;var showTiers=(b&&b.showTiers===false)?false:true;var selectedMinQty=pickMinQty(b);var items=normalizeItems(b);var itemsText=(showItems&&items.length)?buildItemsText(items):'';var priceText=showPrice?buildPriceText(b):'';var tiersHtml=showTiers?buildTierRows(b,bid,selectedMinQty):'';var msg=String(messageByBundleId[bid]||\"\");var checked=Boolean(expandedBundleIds&&expandedBundleIds[bid]===true);var cls='bundle-app-card'+(checked?' bundle-app-card--selected':'');var btnLabel=String(b.cta||\"أضف الباقة\");if(tiersHtml){btnLabel=btnLabel+' ('+fmtNum(Math.max(getPageQty(),Math.max(minRequiredBaseQty(b),selectedMinQty)))+' قطع)'}var cardStyle='background:'+escHtml(color)+';color:'+escHtml(textColor)+';';var btnStyle='';if(ctaBg)btnStyle+='background:'+escHtml(ctaBg)+';';if(ctaText)btnStyle+='color:'+escHtml(ctaText)+';';var labelStyle='';if(labelBg)labelStyle+='background:'+escHtml(labelBg)+';';else labelStyle+='background:rgba(255,255,255,.18);';if(labelText)labelStyle+='color:'+escHtml(labelText)+';';html+='<div class=\"'+cls+'\" style=\"'+cardStyle+'\" data-bundle-id=\"'+escHtml(bid)+'\"><div class=\"bundle-app-row\"><label class=\"bundle-app-checkwrap\"><input class=\"bundle-app-check\" type=\"checkbox\" data-bundle-id=\"'+escHtml(bid)+'\" '+(checked?'checked':'')+' /><span class=\"bundle-app-checkmark\"></span></label><div class=\"bundle-app-content\"><div class=\"bundle-app-head\"><div style=\"min-width:0\"><div class=\"bundle-app-title\">'+escHtml(title)+'</div>'+(subtitle?('<div class=\"bundle-app-subtitle\">'+escHtml(subtitle)+'</div>'):'')+(labelSub?('<div class=\"bundle-app-label-sub\">'+escHtml(labelSub)+'</div>'):'')+'</div>'+(label?('<div class=\"bundle-app-label\" style=\"'+labelStyle+'\">'+escHtml(label)+'</div>'):'')+'</div>'+(itemsText?('<div class=\"bundle-app-items\">'+escHtml(itemsText)+'</div>'):'')+(priceText?('<div class=\"bundle-app-price\">'+escHtml(priceText)+'</div>'):'')+(msg?('<div class=\"bundle-app-msg\">'+escHtml(msg)+'</div>'):'')+'</div><button class=\"bundle-app-btn\" type=\"button\" data-action=\"apply-one\" data-bundle-id=\"'+escHtml(bid)+'\" '+(applying?'disabled':'')+(btnStyle?(' style=\"'+btnStyle+'\"'):'')+'>'+escHtml(btnLabel)+'</button></div>'+(tiersHtml?('<div class=\"bundle-app-tiers\">'+tiersHtml+'</div>'):'')+'<div class=\"bundle-app-pickers\" data-bundle-id=\"'+escHtml(bid)+'\" style=\"display:'+(checked?'block':'none')+'\"></div></div>'}root.innerHTML=html;var tierEls=root.querySelectorAll('.bundle-app-tier[data-tier-minqty][data-bundle-id]');for(var t=0;t<tierEls.length;t++){(function(el){el.onclick=function(){var bid=String(el.getAttribute('data-bundle-id')||\"\");var mq=Number(el.getAttribute('data-tier-minqty'));if(bid&&Number.isFinite(mq)&&mq>=1){selectedTierByBundleId[bid]=Math.floor(mq);messageByBundleId[bid]='';renderProductBanners(arr)}}})(tierEls[t])}var checks=root.querySelectorAll('input.bundle-app-check[data-bundle-id]');for(var c=0;c<checks.length;c++){(function(el){el.onchange=function(){var bid=String(el.getAttribute('data-bundle-id')||\"\");if(!bid)return;expandedBundleIds[bid]=Boolean(el.checked);if(el.checked){selectedBundleId=bid;messageByBundleId[bid]=''}else{if(String(selectedBundleId||\"\")===bid)selectedBundleId=null}renderProductBanners(arr)}})(checks[c])}var btns=root.querySelectorAll('button.bundle-app-btn[data-action=\"apply-one\"][data-bundle-id]');for(var k=0;k<btns.length;k++){(function(btn){btn.onclick=function(){var bid=String(btn.getAttribute('data-bundle-id')||\"\");if(!bid||applying)return;selectedBundleId=bid;var bundle=null;for(var i=0;i<arr.length;i++){if(String(arr[i]&&arr[i].id||\"\")===bid){bundle=arr[i];break}}if(!bundle)return;applyBundleSelection(bundle)}})(btns[k])}var cards=root.querySelectorAll('.bundle-app-card[data-bundle-id]');for(var ci=0;ci<cards.length;ci++){var c0=cards[ci];var id0=String(c0.getAttribute('data-bundle-id')||\"\");if(expandedBundleIds&&expandedBundleIds[id0]===true){var b0=null;for(var si=0;si<arr.length;si++){if(String(arr[si]&&arr[si].id||\"\")===id0){b0=arr[si];break}}if(b0){ensureVariantPickersForCard(c0,b0)}}}}",
  "",
  "",
  "",
  "",
  "function clearProductBanner(){var root=document.getElementById(\"bundle-app-banner\");if(root)root.remove()}",
  "function initOnce(){var inited=false;function start(){if(inited)return;inited=true;applyPendingCouponForCart();refreshProduct()}if(document.readyState===\"loading\"){document.addEventListener(\"DOMContentLoaded\",start)}else{start()}}",
];
