(function(){var g=null;try{g=globalThis}catch(e){g=window}if(!g)g=window;g.BundleApp=g.BundleApp||{};var merchantId="678592212";var token="eyJtZXJjaGFudElkIjoiNjc4NTkyMjEyIiwiaWF0IjoxNzY3MDE4MzU3NTA5LCJub25jZSI6ImY2M2Q0ZDE0OWM3OSJ9.b665eeb6de7a71b87a3d1c2717bc6efdca44cbeaf00eb3bba85a0a0ebce38a6c";var scriptSrc=(document.currentScript&&document.currentScript.src)||"";if(!scriptSrc){try{var ss=document.getElementsByTagName("script");for(var si=0;si<ss.length;si++){var s=ss[si];var src=(s&&s.src)||"";if(!src)continue;if(src.indexOf("/api/storefront/snippet.js")!==-1&&src.indexOf("merchantId="+encodeURIComponent(merchantId))!==-1){scriptSrc=src;break}}}catch(e){}}var debug=false;try{debug=new URL(scriptSrc).searchParams.get("debug")==="1"}catch(e){}function log(){if(!debug)return;try{console.log.apply(console,arguments)}catch(e){}}function warn(){if(!debug)return;try{console.warn.apply(console,arguments)}catch(e){}}var __bundleAppCssBase=".bundle-app-container{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}\n.bundle-app-banner--inline{position:relative;display:block;width:100%;max-width:100%;margin:12px 0;z-index:10;box-sizing:border-box;grid-column:1 / -1;justify-self:stretch;align-self:stretch;flex:0 0 100%;flex-basis:100%;min-width:0;clear:both}\n.bundle-app-banner--fixed{position:fixed;left:16px;right:16px;bottom:16px;z-index:99999}\n.bundle-app-card{border-radius:14px;padding:12px 14px;color:#fff;box-shadow:0 10px 25px rgba(0,0,0,.18)}\n.bundle-app-card+.bundle-app-card{margin-top:10px}\n.bundle-app-row{display:flex;gap:10px;align-items:flex-start;justify-content:space-between}\n.bundle-app-title{font-size:14px;font-weight:800;line-height:1.2}\n.bundle-app-sub{font-size:12px;opacity:.95;margin-top:6px;line-height:1.3}\n.bundle-app-muted{opacity:.9}\n.bundle-app-choice{display:flex;gap:10px;align-items:flex-start}\n.bundle-app-radio{margin-top:3px}\n.bundle-app-btn{border:0;border-radius:12px;padding:10px 12px;font-size:13px;font-weight:800;cursor:pointer;background:rgba(255,255,255,.18);color:#fff}\n.bundle-app-btn:disabled{opacity:.6;cursor:not-allowed}\n.bundle-app-items{margin-top:8px;font-size:12px;opacity:.95;line-height:1.35}\n.bundle-app-price{margin-top:8px;font-size:12px;opacity:.95;line-height:1.35}\n.bundle-app-msg{margin-top:8px;font-size:12px;opacity:.95;line-height:1.35}\n.bundle-app-choice{position:relative;display:flex;gap:10px;align-items:flex-start}\n.bundle-app-radio{position:absolute;opacity:0;pointer-events:none}\n.bundle-app-dot{width:18px;height:18px;border-radius:999px;border:2px solid rgba(255,255,255,.85);box-sizing:border-box;flex:0 0 18px;margin-top:4px;background:transparent}\n.bundle-app-radio:checked + .bundle-app-dot{background:rgba(255,255,255,.95);box-shadow:inset 0 0 0 4px rgba(17,24,39,.45)}\n.bundle-app-card{border-radius:16px;padding:14px 14px;box-shadow:0 14px 40px rgba(2,6,23,.18);overflow:hidden}\n.bundle-app-card--selected{outline:2px solid rgba(255,255,255,.7)}\n.bundle-app-row{gap:12px}\n.bundle-app-content{min-width:0;flex:1}\n.bundle-app-head{display:flex;align-items:flex-start;justify-content:space-between;gap:10px}\n.bundle-app-title{font-size:15px;font-weight:900;line-height:1.25;letter-spacing:.1px}\n.bundle-app-subtitle{font-size:12px;opacity:.95;margin-top:6px;line-height:1.35}\n.bundle-app-label{font-size:12px;font-weight:900;line-height:1;white-space:nowrap;border-radius:999px;padding:7px 10px}\n.bundle-app-label-sub{font-size:12px;opacity:.92;margin-top:8px;line-height:1.35}\n.bundle-app-btn{border-radius:14px;padding:11px 12px;font-size:13px;font-weight:900;color:inherit;white-space:nowrap}\n.bundle-app-choice{min-width:0;flex:1}\n.bundle-app-checkwrap{position:relative;display:flex;align-items:center;justify-content:center;flex:0 0 auto}\n.bundle-app-check{position:absolute;opacity:0;width:22px;height:22px;cursor:pointer;margin:0;inset:0}\n.bundle-app-checkmark{width:22px;height:22px;border-radius:7px;border:2px solid rgba(255,255,255,.86);background:rgba(255,255,255,.14);display:flex;align-items:center;justify-content:center;box-sizing:border-box}\n.bundle-app-check:checked + .bundle-app-checkmark{background:#fff;border-color:#fff}\n.bundle-app-check:checked + .bundle-app-checkmark:after{content:\"\";width:7px;height:12px;border:3px solid #0f172a;border-top:0;border-left:0;transform:rotate(45deg);margin-top:-1px}\n.bundle-app-tiers{margin-top:12px;display:flex;flex-direction:column;gap:8px}\n.bundle-app-tier{display:flex;justify-content:space-between;align-items:flex-start;gap:10px;background:rgba(255,255,255,.14);border-radius:14px;padding:9px 10px;font-size:12px;line-height:1.25;cursor:pointer;user-select:none;transition:background .12s ease,transform .12s ease;color:inherit}\n.bundle-app-tier:hover{background:rgba(255,255,255,.2)}\n.bundle-app-tier--selected{background:rgba(255,255,255,.26);outline:2px solid rgba(255,255,255,.65)}\n.bundle-app-tier:active{transform:scale(.99)}\n.bundle-app-tier strong{font-weight:900}\n.bundle-app-pickers{margin-top:12px;padding:12px;background:rgba(255,255,255,.14);border-radius:14px}\n.bundle-app-pickers--inline{margin-top:0}\n.bundle-app-tier-main{min-width:0;flex:1}\n.bundle-app-tier-checkwrap{margin-top:1px}\n.bundle-app-picker-hint{font-size:12px;opacity:.95;line-height:1.35}\n.bundle-app-announcement{position:sticky;top:0;z-index:100000;box-sizing:border-box;width:100%;display:flex;align-items:center;justify-content:center;padding:10px 44px;background:#0f172a;color:#fff;border-bottom:1px solid rgba(255,255,255,.12);text-align:center;border-radius:var(--bundle-app-announcement-radius,0px)}\n.bundle-app-announcement.is-not-sticky{position:relative}\n.bundle-app-announcement.is-not-selectable{user-select:none;-webkit-user-select:none}\n.bundle-app-announcement.is-skewed{transform:skewX(var(--bundle-app-announcement-skew,0deg));transform-origin:center}\n.bundle-app-announcement__layout{display:flex;align-items:center;justify-content:center;gap:12px;width:100%;min-width:0}\n.bundle-app-announcement.is-skewed .bundle-app-announcement__layout{transform:skewX(calc(-1 * var(--bundle-app-announcement-skew,0deg)))}\n.bundle-app-announcement__inner{display:flex;align-items:center;justify-content:center!important;gap:10px;flex-wrap:wrap;text-align:center!important;min-width:0}\n.bundle-app-announcement.is-marquee{overflow:hidden}\n.bundle-app-announcement__marquee{overflow:hidden;min-width:0;max-width:100%}\n.bundle-app-announcement__track{display:flex;align-items:center;width:max-content;gap:var(--bundle-app-announcement-marquee-gap,48px);will-change:transform;animation:bundle-app-announcement-marquee var(--bundle-app-announcement-marquee-duration,8s) linear infinite}\n.bundle-app-announcement.is-marquee-sweep .bundle-app-announcement__track{animation-name:bundle-app-announcement-marquee-sweep}\n.bundle-app-announcement.is-ar .bundle-app-announcement__track{animation-direction:reverse}\n.bundle-app-announcement.is-marquee-sweep.is-ar .bundle-app-announcement__track{animation-direction:normal}\n.bundle-app-announcement.is-marquee:hover .bundle-app-announcement__track{animation-play-state:paused}\n.bundle-app-announcement__segment{display:inline-flex;align-items:center;gap:10px;white-space:nowrap}\n.bundle-app-announcement__cta{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;background:var(--bundle-app-announcement-accent,#38bdf8);color:#0b1220;font-size:12px;font-weight:900;text-decoration:none;white-space:nowrap;border:1px solid rgba(255,255,255,.18);box-shadow:0 12px 28px rgba(0,0,0,.22);transform:translateY(0);transition:transform .12s ease,filter .12s ease,opacity .12s ease}\n.bundle-app-announcement__cta:hover{filter:brightness(1.06)}\n.bundle-app-announcement__cta:active{transform:translateY(1px)}\n.bundle-app-announcement__cta.is-cta-outline{background:transparent;color:inherit;border:2px solid rgba(255,255,255,.45);box-shadow:none}\n.bundle-app-announcement__cta.is-cta-pulse{animation:bundle-app-announcement-cta-pulse 1.4s ease-in-out infinite}\n.bundle-app-announcement__cta.is-cta-bounce{animation:bundle-app-announcement-cta-bounce 1.2s ease-in-out infinite}\n.bundle-app-announcement__title{font-weight:900;font-size:13px;line-height:1.2}\n.bundle-app-announcement__message{font-weight:700;font-size:13px;line-height:1.2;opacity:.96}\n.bundle-app-announcement__link{font-weight:900;font-size:13px;line-height:1.2;color:var(--bundle-app-announcement-link,#38bdf8);text-decoration:underline}\n.bundle-app-announcement__close{position:absolute;right:10px;top:50%;transform:translateY(-50%);border:0;background:transparent;color:inherit;font-size:18px;line-height:1;cursor:pointer;opacity:.9}\n.bundle-app-announcement.is-rtl .bundle-app-announcement__close{left:10px;right:auto}\n.bundle-app-announcement__close:hover{opacity:1}\n@keyframes bundle-app-announcement-marquee{0%{transform:translateX(0)}100%{transform:translateX(calc(-1 * var(--bundle-app-announcement-marquee-distance,300px)))}}\n@keyframes bundle-app-announcement-marquee-sweep{0%{transform:translateX(0)}100%{transform:translateX(var(--bundle-app-announcement-marquee-sweep-to,-300px))}}\n@keyframes bundle-app-announcement-cta-pulse{0%,100%{transform:translateY(0) scale(1)}50%{transform:translateY(0) scale(1.04)}}\n@keyframes bundle-app-announcement-cta-bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-2px)}}\n@keyframes bundle-app-announcement-enter-slide{0%{opacity:0;transform:translateY(-10px)}100%{opacity:1;transform:translateY(0)}}\n@keyframes bundle-app-announcement-enter-fade{0%{opacity:0}100%{opacity:1}}\n@keyframes bundle-app-announcement-enter-pop{0%{opacity:0;transform:scale(.98)}100%{opacity:1;transform:scale(1)}}\n.bundle-app-announcement.is-enter-slide{animation:bundle-app-announcement-enter-slide .26s ease-out both}\n.bundle-app-announcement.is-enter-fade{animation:bundle-app-announcement-enter-fade .22s ease-out both}\n.bundle-app-announcement.is-enter-pop{animation:bundle-app-announcement-enter-pop .22s ease-out both}\n@media (prefers-reduced-motion:reduce){.bundle-app-announcement__track{animation:none;transform:none}}\n.bundle-app-products{margin-top:12px;display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}\n.bundle-app-product{background:rgba(255,255,255,.14);border-radius:14px;overflow:hidden;display:flex;flex-direction:column;min-width:0}\n.bundle-app-product__media{position:relative;width:100%;aspect-ratio:1 / 1;background:rgba(0,0,0,.08);overflow:hidden}\n.bundle-app-product__img{width:100%;height:100%;object-fit:cover;display:block}\n.bundle-app-product__body{padding:10px;display:flex;flex-direction:column;gap:8px;min-width:0}\n.bundle-app-product__top{display:flex;align-items:flex-start;justify-content:space-between;gap:10px}\n.bundle-app-product__name{font-size:12px;font-weight:900;line-height:1.3;min-width:0}\n.bundle-app-product__attrs{font-size:12px;opacity:.95;line-height:1.3}\n.bundle-app-product__price{font-size:12px;font-weight:900;line-height:1.2;display:flex;gap:8px;flex-wrap:wrap;align-items:baseline}\n.bundle-app-product__price-old{text-decoration:line-through;opacity:.85;font-weight:800}\n.bundle-app-product__checkwrap{position:relative;display:flex;align-items:center;justify-content:center;flex:0 0 auto}\n.bundle-app-product__check{position:absolute;opacity:0;width:22px;height:22px;cursor:pointer;margin:0;inset:0}\n.bundle-app-product__checkmark{width:22px;height:22px;border-radius:7px;border:2px solid rgba(255,255,255,.86);background:rgba(255,255,255,.14);display:flex;align-items:center;justify-content:center;box-sizing:border-box}\n.bundle-app-product__check:checked + .bundle-app-product__checkmark{background:#fff;border-color:#fff}\n.bundle-app-product__check:checked + .bundle-app-product__checkmark:after{content:\"\";width:7px;height:12px;border:3px solid #0f172a;border-top:0;border-left:0;transform:rotate(45deg);margin-top:-1px}\n.bundle-app-bottomsheet{position:fixed;inset:0;z-index:100001;display:flex;align-items:flex-end;justify-content:center;background:rgba(0,0,0,.45);padding:10px}\n.bundle-app-bottomsheet__panel{width:min(560px,100%);max-height:85vh;background:#fff;border-radius:18px 18px 12px 12px;box-shadow:0 18px 60px rgba(0,0,0,.3);overflow:auto}\n.bundle-app-bottomsheet__head{padding:14px 14px 10px;display:flex;align-items:flex-start;justify-content:space-between;gap:10px}\n.bundle-app-bottomsheet__title{font-size:15px;font-weight:950;line-height:1.2;color:#0b1220}\n.bundle-app-bottomsheet__sub{margin-top:6px;font-size:12px;opacity:.85;line-height:1.35;color:#0b1220}\n.bundle-app-bottomsheet__close{border:0;background:transparent;font-size:22px;line-height:1;cursor:pointer;color:#0b1220;opacity:.8}\n.bundle-app-bottomsheet__content{padding:0 14px 12px}\n.bundle-app-bottomsheet__cta{display:flex;gap:10px;padding:12px 14px 14px}\n.bundle-app-bottomsheet__btn{border:0;border-radius:14px;padding:12px 12px;font-size:13px;font-weight:950;cursor:pointer}\n.bundle-app-bottomsheet__btn-primary{background:#0ea5e9;color:#0b1220;flex:1}\n.bundle-app-bottomsheet__btn-secondary{background:rgba(2,6,23,.08);color:#0b1220}\n.bundle-app-bottomsheet__btn:disabled{opacity:.55;cursor:not-allowed}\n.bundle-app-bottomsheet__msg{margin-top:10px;font-size:12px;line-height:1.35;color:#0b1220;opacity:.85}\n.bundle-app-bottomsheet__hero{border-radius:14px;overflow:hidden;background:rgba(2,6,23,.06);margin-bottom:10px}\n.bundle-app-bottomsheet__heroimg{width:100%;height:auto;display:block;object-fit:cover}\n.bundle-app-bottomsheet__hero-title{padding:10px 10px 0;font-size:13px;font-weight:950;color:#0b1220}\n.bundle-app-bottomsheet__hero-price{padding:6px 10px 10px;font-size:12px;font-weight:950;color:#0b1220;display:flex;gap:8px;flex-wrap:wrap;align-items:baseline}\n.bundle-app-bottomsheet__hero-old{text-decoration:line-through;opacity:.65;font-weight:850}\n@media (max-width:480px){.bundle-app-row{flex-direction:column;align-items:stretch}.bundle-app-btn{width:100%;white-space:normal}.bundle-app-checkwrap{align-self:flex-start}.bundle-app-products{grid-template-columns:1fr}}\n";var __bundleAppCssPickers=".bundle-app-pickers{margin-top:12px;display:none;background:rgba(255,255,255,.14);border-radius:14px;padding:10px}\n.bundle-app-card--selected .bundle-app-pickers{display:block}\n.bundle-app-pickers-title{font-weight:900;font-size:12px;margin-bottom:8px}\n.bundle-app-picker-row{display:flex;flex-direction:column;gap:8px;margin-bottom:10px}\n.bundle-app-picker-label{font-weight:900;font-size:12px}\n.bundle-app-picker-hint{font-size:12px;opacity:.95}\n.bundle-app-picker-status{font-size:12px;opacity:.95;margin-top:6px}\n.bundle-app-variant-options{display:flex;flex-wrap:wrap;gap:8px}\n.bundle-app-variant-btn{appearance:none;border:1px solid rgba(255,255,255,.55);background:rgba(255,255,255,.14);color:inherit;border-radius:999px;padding:8px 10px;font-size:12px;font-weight:900;cursor:pointer;line-height:1;display:inline-flex;align-items:center;gap:8px}\n.bundle-app-variant-btn.is-selected{background:rgba(255,255,255,.95);color:#111827;border-color:rgba(255,255,255,.95)}\n.bundle-app-variant-btn:disabled{opacity:.75;cursor:not-allowed}\n.bundle-app-variant-swatch{width:14px;height:14px;border-radius:999px;flex:0 0 14px;border:1px solid rgba(255,255,255,.75);background:rgba(255,255,255,.25)}\n.bundle-app-variant-swatch.is-image{background-size:cover;background-position:center}\n.bundle-app-variant-text{line-height:1.15}\n@media (max-width:480px){.bundle-app-variant-btn{width:100%;justify-content:flex-start}}\n";function __bundleAppInjectStyle(id,css){try{if(!css)return;if(document.getElementById(id))return;var s=document.createElement("style");s.id=id;s.textContent=String(css||"");document.head.appendChild(s)}catch(e){}}function ensurePickerStyles(){try{if(g.BundleAppUi&&typeof g.BundleAppUi.ensurePickerStyles==="function"){g.BundleAppUi.ensurePickerStyles();return}}catch(e){}__bundleAppInjectStyle("bundle-app-pickers-style",__bundleAppCssPickers)}function ensureStyles(){__bundleAppInjectStyle("bundle-app-style",__bundleAppCssBase)}try{if(typeof ensureStyles==="function")ensureStyles()}catch(e){}var g=null;try{g=globalThis}catch(e){g=window}if(!g)g=window;g.BundleApp=g.BundleApp||{};var debug=false;try{debug=new URL(scriptSrc).searchParams.get("debug")==="1"}catch(e){}function log(){if(!debug)return;try{console.log.apply(console,arguments)}catch(e){}}function warn(){if(!debug)return;try{console.warn.apply(console,arguments)}catch(e){}}function getBackendOrigin(){try{return new URL(scriptSrc).origin}catch(e){return""}}async function fetchJson(url,opts){var r=await fetch(url,opts);var t=await r.text();var j=null;try{j=t?JSON.parse(t):null}catch(e){throw new Error("Invalid JSON response")}if(!r.ok){var msg=(j&&j.message)||("HTTP "+r.status);var err=new Error(msg);err.status=r.status;err.details=j;throw err}return j}function buildUrl(path,params){var origin=getBackendOrigin();if(!origin)return null;var u=new URL(origin+path);for(var k in (params||{})){if(!Object.prototype.hasOwnProperty.call(params,k))continue;var v=params[k];if(v==null||v==="")continue;u.searchParams.set(k,String(v))}u.searchParams.set("merchantId",merchantId);u.searchParams.set("token",token);return u.toString()}async function getProductBundlesByVariantId(variantId){var v=String(variantId||"").trim();if(!v)return null;var u=buildUrl("/api/proxy/bundles/product",{variantId:v});if(!u)return null;return fetchJson(u)}async function getProductBundlesByProductId(productId){var p=String(productId||"").trim();if(!p)return null;var u=buildUrl("/api/proxy/bundles/for-product",{productId:p});if(!u)return null;return fetchJson(u)}async function requestApplyBundle(bundleId,items){var payload={bundleId:String(bundleId||""),items:Array.isArray(items)?items:[]};var u=buildUrl("/api/proxy/bundles/apply",{});if(!u)return null;return fetchJson(u,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)})}async function getProductVariantsByProductId(productId){var p=String(productId||"").trim();if(!p)return null;var u=buildUrl("/api/proxy/products/variants",{productId:p});if(!u)return null;return fetchJson(u)}function isProductRef(variantId){return String(variantId||"").trim().indexOf("product:")===0}var variantsCacheByProductId={};var variantsPendingByProductId={};async function getCachedVariants(productId){var pid=String(productId||"").trim();if(!pid)return[];if(Object.prototype.hasOwnProperty.call(variantsCacheByProductId,pid))return variantsCacheByProductId[pid]||[];var pend=variantsPendingByProductId[pid];if(pend&&pend.then)return pend;var p=(async function(){try{var res=await getProductVariantsByProductId(pid);var vars=(res&&res.variants)||[];variantsCacheByProductId[pid]=Array.isArray(vars)?vars:[];return variantsCacheByProductId[pid]}finally{try{delete variantsPendingByProductId[pid]}catch(e){variantsPendingByProductId[pid]=null}}})();variantsPendingByProductId[pid]=p;return p}function stringifyAttrs(attrs){try{if(!attrs||typeof attrs!=="object")return"";var parts=[];for(var k in attrs){if(!Object.prototype.hasOwnProperty.call(attrs,k))continue;var key=String(k||"").trim();var v=attrs[k];if(v==null)continue;var vs=String(v||"").trim();if(!vs)continue;parts.push((key?(key+": "):"")+vs)}return parts.join(" • ")}catch(e){return""}}function variantLabel(v){var id=String(v&&v.variantId||"").trim();var name=String(v&&v.name||"").trim();var attrs=stringifyAttrs(v&&v.attributes);var price=v&&v.price!=null?Number(v.price):null;var priceText=(Number.isFinite(price)&&price>=0)?fmtMoney(price):"";var base='';if(attrs&&name)base=name+" • "+attrs;else if(attrs)base=attrs;else if(name)base=name;else if(id)base=id;else base="";if(base&&priceText)return base+" • "+priceText;if(base)return base;if(priceText)return priceText;return "—"}function normHex(s){try{var x=String(s||"").trim();if(!x)return"";var m=x.match(/^#?([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/);if(!m)return"";return x.charAt(0)==='#'?x:('#'+x)}catch(e){return""}}function escCssUrl(u){try{var s=String(u||"").trim();if(!s)return"";s=s.replace(/[\n\r\t\f\\"'()<>]/g,"");return s}catch(e){return""}}function pickVariantSwatch(v){try{var img=String(v&&v.imageUrl||"").trim();if(img)return{t:"img",v:img};var attrs=v&&v.attributes&&typeof v.attributes==="object"?v.attributes:null;if(attrs){for(var k in attrs){if(!Object.prototype.hasOwnProperty.call(attrs,k))continue;var hex=normHex(attrs[k]);if(hex)return{t:"hex",v:hex}}}var hex2=normHex(v&&v.name);if(hex2)return{t:"hex",v:hex2};return null}catch(e){return null}}function variantOptionInnerHtml(v){var sw=pickVariantSwatch(v);var out='';if(sw&&sw.t==='img'){var u=escCssUrl(sw.v);if(u){out+='<span class="bundle-app-variant-swatch is-image" style="background-image:url(\''+escHtml(u)+'\')"></span>'}}else if(sw&&sw.t==='hex'&&sw.v){out+='<span class="bundle-app-variant-swatch" style="background:'+escHtml(sw.v)+'"></span>'}out+='<span class="bundle-app-variant-text">'+escHtml(variantLabel(v))+'</span>';return out}var selectedBundleId=null;var lastTriggerProductId=null;var messageByBundleId={};var selectedTierByBundleId={};var applying=false;var variantSelectionsByBundleId={};var postAddShownByBundleId={};var variantPickerCacheByBundleId={};var variantPickerPendingByBundleId={};function getBundleVariantSelectionMap(bundleId){var bid=String(bundleId||"").trim();if(!bid)return null;var m=variantSelectionsByBundleId[bid];if(!m||typeof m!=="object")m={};variantSelectionsByBundleId[bid]=m;return m}function bundleVariantSig(bundle){try{var items=normalizeItems(bundle);var parts=[];for(var i=0;i<items.length;i++){var it=items[i]||{};var v=String(it.variantId||"").trim();if(!isProductRef(v))continue;var pid=String(it.productId||"").trim();if(!pid)continue;var qty=Math.max(1,Math.floor(Number(it.quantity||1)));parts.push(pid+"x"+qty)}parts.sort();return parts.join("|")}catch(e){return""}}function bundleVariantUnits(bundle){var items=normalizeItems(bundle);var units=[];for(var i=0;i<items.length;i++){var it=items[i]||{};var v=String(it.variantId||"").trim();if(!isProductRef(v))continue;var pid=String(it.productId||"").trim();if(!pid)continue;var qty=Math.max(1,Math.floor(Number(it.quantity||1)));for(var u=0;u<qty;u++){units.push({productId:pid,key:pid+":"+u})}}return units}function pruneBundleSelections(sel,units){try{if(!sel||typeof sel!=="object")return;var keep={};for(var i=0;i<units.length;i++){keep[String(units[i]&&units[i].key||"")]=true}for(var k in sel){if(!Object.prototype.hasOwnProperty.call(sel,k))continue;if(!keep[k]){try{delete sel[k]}catch(e){sel[k]=null}}}}catch(e){}}function escHtml(input){var s=String(input==null?"":input);return s.replace(/[&<>"']/g,function(ch){return ch==="&"?"&amp;":ch==="<"?"&lt;":ch===">"?"&gt;":ch==='"'?"&quot;":"&#39;"})}function fmtNum(n){var x=Number(n);if(!Number.isFinite(x))return"—";try{return x.toLocaleString("ar-SA")}catch(e){return String(x)}}function fmtMoney(n){var x=Number(n);if(!Number.isFinite(x))return"—";var v=Math.round(x*100)/100;var s;try{s=v.toLocaleString("ar-SA",{minimumFractionDigits:v%1?2:0,maximumFractionDigits:2})}catch(e){s=String(v)}return s+" ر.س"}function normalizeTitle(raw){var title=String(raw||"");if(!title||title==="Bundle")title="باقة";try{title=title.replace(/^Bundle\s*-\s*/i,"باقة - ")}catch(e){}return title}function minRequiredBaseQty(bundle){return 1}function normalizeItems(bundle){var comps=(bundle&&bundle.components)||[];if(!Array.isArray(comps)||!comps.length){comps=(bundle&&bundle.bundleItems)||[]}var out=[];var baseMin=minRequiredBaseQty(bundle);for(var i=0;i<comps.length;i++){var c=comps[i]||{};var v=String(c.variantId||"").trim();var pid=String(c.productId||"").trim();var isBase=Boolean(c.isBase);var q=isBase?Math.max(getPageQty(),baseMin):Math.max(1,Math.floor(Number(c.quantity||1)));if(!v)continue;out.push({variantId:v,productId:pid||null,quantity:q,isBase:isBase})}out.sort(function(a,b){return String(a.variantId).localeCompare(String(b.variantId))});return out}function buildItemsText(items){var products=0;var totalQty=0;for(var i=0;i<items.length;i++){var it=items[i]||{};if(!it.variantId)continue;products++;totalQty+=Math.max(1,Math.floor(Number(it.quantity||1)))}return "عدد المنتجات: "+fmtNum(products)+" • إجمالي القطع: "+fmtNum(totalQty)}function buildPriceText(bundle){var p=bundle&&bundle.pricing&&bundle.pricing.base;if(!p)return"";var o=Number(p.originalTotal),f=Number(p.finalTotal),d=Number(p.discountAmount);if(!Number.isFinite(o)||!Number.isFinite(f))return"";var s='قبل '+fmtMoney(o)+' • بعد '+fmtMoney(f);if(Number.isFinite(d)&&d>0)s+=' • وفّرت '+fmtMoney(d);return s}function selectionKey(triggerProductId){return "bundle_app_selected_bundle:"+String(merchantId||"")+":"+String(triggerProductId||"")}function pendingKey(triggerProductId){return "bundle_app_pending_coupon:"+String(merchantId||"")+":"+String(triggerProductId||"")}function loadSelection(triggerProductId){try{var raw=localStorage.getItem(selectionKey(triggerProductId));if(!raw)return null;var j=JSON.parse(raw);return j&&typeof j==='object'?j:null}catch(e){return null}}function saveSelection(triggerProductId,data){try{localStorage.setItem(selectionKey(triggerProductId),JSON.stringify(data||{}))}catch(e){}}function clearSelection(triggerProductId){try{localStorage.removeItem(selectionKey(triggerProductId))}catch(e){}}function savePendingCoupon(triggerProductId,data){try{localStorage.setItem(pendingKey(triggerProductId),JSON.stringify(data||{}))}catch(e){}}function loadPendingCoupon(triggerProductId){try{var raw=localStorage.getItem(pendingKey(triggerProductId));if(!raw)return null;var j=JSON.parse(raw);return j&&typeof j==='object'?j:null}catch(e){return null}}function clearPendingCoupon(triggerProductId){try{localStorage.removeItem(pendingKey(triggerProductId))}catch(e){}}function isCartLikePage(){try{var p=String(window.location.pathname||"").toLowerCase();return p.indexOf('cart')!==-1||p.indexOf('checkout')!==-1}catch(e){return false}}async function tryApplyCoupon(code){var c=String(code||"").trim();if(!c)return false;if(storeClosedNow())return false;function sleep(ms){return new Promise(function(r){setTimeout(function(){r()},ms)})}for(var attempt=0;attempt<3;attempt++){try{var cart=window.salla&&window.salla.cart;var applied=false;if(cart&&typeof cart.applyCoupon==="function"){await cart.applyCoupon(c);applied=true}else if(cart&&cart.coupon&&typeof cart.coupon.apply==="function"){await cart.coupon.apply(c);applied=true}else if(cart&&cart.coupon&&typeof cart.coupon.set==="function"){await cart.coupon.set(c);applied=true}else if(cart&&typeof cart.setCoupon==="function"){await cart.setCoupon(c);applied=true}else if(cart&&typeof cart.addCoupon==="function"){await cart.addCoupon(c);applied=true}else if(window.salla&&typeof window.salla.applyCoupon==="function"){await window.salla.applyCoupon(c);applied=true}else if(window.salla&&window.salla.coupon&&typeof window.salla.coupon.apply==="function"){await window.salla.coupon.apply(c);applied=true}if(applied){try{g.BundleApp._lastCouponApplyStatus=null;g.BundleApp._lastCouponApplyMessage=""}catch(x0){}return true}}catch(e){var st=extractHttpStatus(e);var msg=extractHttpMessage(e);try{g.BundleApp._lastCouponApplyStatus=st;g.BundleApp._lastCouponApplyMessage=String(msg||"")}catch(x1){}markStoreClosed({status:st,message:msg});if(storeClosedNow())return false;warn("bundle-app: coupon apply failed",e&&((e.details)||e.message||e))}await sleep(250+attempt*250)}return false}function extractHttpStatus(e){try{var s=(e&&((e.statusCode!=null&&e.statusCode)||(e.status!=null&&e.status)||(e.response&&e.response.status)||(e.request&&e.request.status)))||null;var n=Number(s);return Number.isFinite(n)?n:null}catch(x){return null}}function extractHttpMessage(e){try{var m='';if(e&&e.details&&typeof e.details==='object'){m=String(e.details.message||e.details.error||e.details.title||'').trim();if(!m&&e.details.data&&typeof e.details.data==='object')m=String(e.details.data.message||e.details.data.error||e.details.data.title||'').trim()}if(!m&&e&&e.response&&e.response.data!=null){var d=e.response.data;if(typeof d==='string'){m=String(d||'').trim()}else if(typeof d==='object'){m=String(d.message||d.error||d.title||'').trim();if(!m&&d.data&&typeof d.data==='object')m=String(d.data.message||d.data.error||d.data.title||'').trim()}}if(!m&&e){m=String(e.message||'').trim()}return m}catch(x){return''}}function storeClosedNow(){try{var until=Number(g.BundleApp&&g.BundleApp._storeClosedUntil||0);return Number.isFinite(until)&&until>Date.now()}catch(e){return false}}function markStoreClosed(e){try{var st=extractHttpStatus(e);var msg=extractHttpMessage(e);var m=String(msg||"");var ml=m.toLowerCase();var isClosed=Boolean(m.indexOf('المتجر مغلق')!==-1||m.indexOf('المتجر مغلق حالياً')!==-1||m.indexOf('المتجر مغلق حاليا')!==-1||ml.indexOf('store is closed')!==-1||ml.indexOf('closed')!==-1&&ml.indexOf('store')!==-1);if(!isClosed&&Number(st)===410){isClosed=Boolean(m.indexOf('مغلق')!==-1||ml.indexOf('closed')!==-1)}if(isClosed){g.BundleApp._storeClosedUntil=Date.now()+60000}}catch(x){}}function humanizeCartError(e){var st=extractHttpStatus(e);var msg=extractHttpMessage(e);var m=String(msg||"");var ml=m.toLowerCase();if(m==='timeout')return 'تعذر الاتصال بسلة المتجر (مهلة)';if(m&&m.indexOf('ERR_NAME_NOT_RESOLVED')!==-1)return 'تعذر الاتصال بسلة المتجر (DNS)';if(st===410){if(m.indexOf('المتجر مغلق')!==-1||ml.indexOf('store is closed')!==-1)return 'المتجر مغلق حالياً';return 'تعذر تحديث السلة (العنصر لم يعد متاحًا)'}if(st===401||st===403)return 'لا يمكن إضافة للسلّة (صلاحيات/جلسة غير صالحة)';if(st===404)return 'لا يمكن إضافة للسلّة (المنتج غير موجود)';if(m)return m;if(st!=null)return 'HTTP '+fmtNum(st);return 'حصل خطأ أثناء الإضافة للسلّة'}async function addItemsToCart(items){var cart=window.salla&&window.salla.cart;if(!cart||typeof cart.addItem!=="function")throw new Error("Salla cart API not available");function withTimeout(p,ms){return Promise.race([p,new Promise(function(_,rej){setTimeout(function(){rej(new Error('timeout'))},Math.max(1,Number(ms||1)))})])}for(var i=0;i<items.length;i++){var it=items[i]||{};var qty=Math.max(1,Math.floor(Number(it.quantity||1)));var vid=String(it.variantId||"").trim();if(!vid)throw new Error("Missing variant selection");var isProductRef=vid&&vid.indexOf('product:')===0;var pidStr=String(it.cartProductId||it.productId||"").trim();if((!pidStr||pidStr==="")&&isProductRef){pidStr=String(vid).slice('product:'.length).trim()}if(pidStr&&pidStr.indexOf('product:')===0){pidStr=String(pidStr).slice('product:'.length).trim()}var pidNum=Number(pidStr);var opts=it&&it.cartOptions&&typeof it.cartOptions==="object"?it.cartOptions:null;if((!opts||!Object.keys(opts).length)&&typeof getCachedVariants==="function"&&pidStr){try{var c=await getCachedVariants(pidStr);for(var ci=0;ci<c.length;ci++){var cv=c[ci]||{};if(String(cv.variantId||"").trim()===vid){opts=cv.cartOptions||null;break}}}catch(e0){}}var done=false;if(!isProductRef){var skuNum=Number(vid);var skuId=(Number.isFinite(skuNum)&&skuNum>0)?skuNum:vid;try{await withTimeout(cart.addItem({id:skuId,quantity:qty}),4500);done=true}catch(e){done=false}}if(done)continue;try{if(Number.isFinite(pidNum)&&pidNum>0){if(opts&&Object.keys(opts).length){await withTimeout(cart.addItem({id:pidNum,quantity:qty,options:opts}),4500);continue}await withTimeout(cart.addItem({id:pidNum,quantity:qty}),4500);continue}}catch(e2){if(typeof cart.quickAdd==="function"&&Number.isFinite(pidNum)&&pidNum>0){try{await withTimeout(cart.quickAdd(pidNum),4500);continue}catch(e3){}}throw e2}}}async function removeItemsFromCart(items){if(storeClosedNow())return;var cart=window.salla&&window.salla.cart;if(!cart)throw new Error("Salla cart API not available");for(var i=0;i<items.length;i++){var it=items[i]||{};var v=String(it.variantId||"").trim();var pid=String(it.productId||"").trim();if(v&&v.indexOf('product:')===0){if(!pid)pid=String(v).slice('product:'.length).trim();v='' }var pidNum=Number(pid);try{if(cart&&typeof cart.removeItem==="function"){if(v){await cart.removeItem(v)}else if(pid&&Number.isFinite(pidNum)&&pidNum>0){await cart.removeItem(pidNum)}continue}if(cart&&typeof cart.deleteItem==="function"){if(v){await cart.deleteItem(v)}else if(pid&&Number.isFinite(pidNum)&&pidNum>0){await cart.deleteItem(pidNum)}continue}if(cart&&typeof cart.updateItem==="function"){if(v){await cart.updateItem({id:v,quantity:0})}else if(pid&&Number.isFinite(pidNum)&&pidNum>0){await cart.updateItem({id:pidNum,quantity:0})}continue}if(cart&&typeof cart.setItemQuantity==="function"){if(v){await cart.setItemQuantity(v,0)}else if(pid&&Number.isFinite(pidNum)&&pidNum>0){await cart.setItemQuantity(pidNum,0)}continue}}catch(e){var st=extractHttpStatus(e);var msg=extractHttpMessage(e);markStoreClosed({status:st,message:msg});if(storeClosedNow())return;if(st===410)continue;warn("bundle-app: remove item failed",e&&((e.details)||e.message||e))}}}async function applyPendingCouponForCart(){if(!isCartLikePage())return;if(storeClosedNow())return;try{var trigger=String(lastTriggerProductId||"");if(!trigger)return;var pending=loadPendingCoupon(trigger);if(!pending||!pending.code)return;var ts=Number(pending.ts||0);if(!Number.isFinite(ts)||ts<=0||Date.now()-ts>10*60*1000){clearPendingCoupon(trigger);return}var ok=await tryApplyCoupon(pending.code);if(ok){clearPendingCoupon(trigger)}}catch(e){markStoreClosed(e)}}function pctFrom(orig,final){var o=Number(orig),f=Number(final);if(!Number.isFinite(o)||!Number.isFinite(f)||o<=0)return null;var p=(1-(f/o))*100;return Math.max(0,Math.round(p))}function getDefaultMinQty(bundle){return 1}function pickMinQty(bundle){try{var bid=String(bundle&&bundle.id||"").trim();var v=Number(selectedTierByBundleId[bid]);if(Number.isFinite(v)&&v>=1)return Math.floor(v);return 1}catch(e){return 1}}function pickPricingForQty(bundle,qty){try{var base=(bundle&&bundle.pricing&&bundle.pricing.base)||null;var tiers=(bundle&&bundle.pricing&&bundle.pricing.tiers)||[];var q=Math.max(1,Math.floor(Number(qty||1)));if(Array.isArray(tiers)&&tiers.length){var best=null;for(var i=0;i<tiers.length;i++){var t=tiers[i]||{};var mq=Math.max(1,Math.floor(Number(t.minQty||1)));if(mq===q)return t;if(mq<=q&&(best==null||mq>best.minQty))best=t}if(best)return best}return base}catch(e){return (bundle&&bundle.pricing&&bundle.pricing.base)||null}}function computeQtyItems(bundle,opts){try{var comps=(bundle&&bundle.components)||[];var qSel=pickMinQty(bundle);var baseQty=Math.max(1,Math.floor(Number(getPageQty()||1)));if(Number.isFinite(qSel)&&qSel>baseQty)baseQty=qSel;var items=[];for(var i=0;i<comps.length;i++){var c=comps[i]||{};var v=String(c.variantId||"").trim();var pid=String(c.productId||"").trim();var isBase=Boolean(c.isBase);var qty=isBase?baseQty:Math.max(1,Math.floor(Number(c.quantity||1)));if(!v)continue;items.push({variantId:v,productId:pid||null,quantity:qty,isBase:isBase})}items.sort(function(a,b){return String(a.variantId).localeCompare(String(b.variantId))});var mode=String((opts&&opts.mode)||'apply');if(mode==='preview'){var bid=String(bundle&&bundle.id||"").trim();var sel=getBundleVariantSelectionMap(bid)||{};var out=[];for(var j=0;j<items.length;j++){var it=items[j]||{};var vid=String(it.variantId||"").trim();if(vid.indexOf('product:')===0){var ref=String(it.productId||"").trim();var pickedCount=0;var qty2=Math.max(1,Math.floor(Number(it.quantity||1)));for(var u=0;u<qty2;u++){var key=ref+':'+u;var pv=String(sel[key]||"").trim();if(pv)pickedCount++}for(var p=0;p<pickedCount;p++){var key2=ref+':'+p;var pv2=String(sel[key2]||"").trim();var useVid=pv2||vid;out.push({variantId:useVid,productId:ref||null,quantity:1,isBase:it.isBase})}}else{out.push(it)}}return out}return items}catch(e){return []}}function computeProductsItems(bundle,opts){try{var comps=(bundle&&bundle.components)||[];var settings=bundle&&bundle.settings||{};var req=Boolean(settings&&settings.selectionRequired===true);var defIds=Array.isArray(settings&&settings.defaultSelectedProductIds)?settings.defaultSelectedProductIds:[];var include=new Set(defIds.map(function(x){return String(x||"").trim()}).filter(Boolean));var bid=String(bundle&&bundle.id||"").trim();var sel=getBundleVariantSelectionMap(bid)||{};var items=[];for(var i=0;i<comps.length;i++){var c=comps[i]||{};var v=String(c.variantId||"").trim();var pid=String(c.productId||"").trim();var qty=Math.max(1,Math.floor(Number(c.quantity||1)));if(!v)continue;var should=include.size?include.has(pid):!req;if(!should)continue;if(v.indexOf('product:')===0){var mode=String((opts&&opts.mode)||'apply');if(mode==='preview'){var pickedCount=0;for(var u=0;u<qty;u++){var key=pid+':'+u;var pv=String(sel[key]||"").trim();if(pv)pickedCount++}for(var p=0;p<pickedCount;p++){var key2=pid+':'+p;var pv2=String(sel[key2]||"").trim();if(!pv2&&settings&&settings.variantRequired!==false)continue;items.push({variantId:pv2||v,productId:pid||null,quantity:1,isBase:false})}}else{var pickedAll=true;var parts=[];for(var u2=0;u2<qty;u2++){var key3=pid+':'+u2;var pv3=String(sel[key3]||"").trim();if(!pv3)pickedAll=false;parts.push(pv3||v)}if(req&&settings&&settings.variantRequired!==false&&!pickedAll)continue;for(var m=0;m<parts.length;m++){items.push({variantId:parts[m],productId:pid||null,quantity:1,isBase:false})}}}else{items.push({variantId:v,productId:pid||null,quantity:qty,isBase:false})}}items.sort(function(a,b){return String(a.variantId).localeCompare(String(b.variantId))});return items}catch(e){return []}}function computeNoDiscountItems(bundle,opts){try{var comps=(bundle&&bundle.components)||[];var settings=bundle&&bundle.settings||{};var req=Boolean(settings&&settings.selectionRequired===true);var defIds=Array.isArray(settings&&settings.defaultSelectedProductIds)?settings.defaultSelectedProductIds:[];var include=new Set(defIds.map(function(x){return String(x||"").trim()}).filter(Boolean));var bid=String(bundle&&bundle.id||"").trim();var sel=getBundleVariantSelectionMap(bid)||{};var items=[];for(var i=0;i<comps.length;i++){var c=comps[i]||{};var v=String(c.variantId||"").trim();var pid=String(c.productId||"").trim();var qty=Math.max(1,Math.floor(Number(c.quantity||1)));if(!v)continue;var should=include.size?include.has(pid):!req;if(!should)continue;if(v.indexOf('product:')===0){var mode=String((opts&&opts.mode)||'apply');if(mode==='preview'){var pickedCount=0;for(var u=0;u<qty;u++){var key=pid+':'+u;var pv=String(sel[key]||"").trim();if(pv)pickedCount++}for(var p=0;p<pickedCount;p++){var key2=pid+':'+p;var pv2=String(sel[key2]||"").trim();items.push({variantId:pv2||v,productId:pid||null,quantity:1,isBase:false})}}else{for(var m=0;m<qty;m++){var key3=pid+':'+m;var pv3=String(sel[key3]||"").trim();items.push({variantId:pv3||v,productId:pid||null,quantity:1,isBase:false})}}}else{items.push({variantId:v,productId:pid||null,quantity:qty,isBase:false})}}items.sort(function(a,b){return String(a.variantId).localeCompare(String(b.variantId))});return items}catch(e){return []}}function computePostAddItems(bundle,opts){try{var comps=(bundle&&bundle.components)||[];var bid=String(bundle&&bundle.id||"").trim();var sel=getBundleVariantSelectionMap(bid)||{};var items=[];for(var i=0;i<comps.length;i++){var c=comps[i]||{};var v=String(c.variantId||"").trim();var pid=String(c.productId||"").trim();var qty=Math.max(1,Math.floor(Number(c.quantity||1)));if(!v)continue;if(v.indexOf('product:')===0){var mode=String((opts&&opts.mode)||'apply');if(mode==='preview'){var pickedCount=0;for(var u=0;u<qty;u++){var key=pid+':'+u;var pv=String(sel[key]||"").trim();if(pv)pickedCount++}for(var p=0;p<pickedCount;p++){var key2=pid+':'+p;var pv2=String(sel[key2]||"").trim();items.push({variantId:pv2||v,productId:pid||null,quantity:1,isBase:false})}}else{for(var m=0;m<qty;m++){var key3=pid+':'+m;var pv3=String(sel[key3]||"").trim();items.push({variantId:pv3||v,productId:pid||null,quantity:1,isBase:false})}}}else{items.push({variantId:v,productId:pid||null,quantity:qty,isBase:false})}}items.sort(function(a,b){return String(a.variantId).localeCompare(String(b.variantId))});return items}catch(e){return []}}function computeBundleApplyItems(bundle,opts){try{var mode=String((opts&&opts.mode)||'apply');var kind=String(bundle&&bundle.kind||'').trim();if(kind==='quantity_discount')return computeQtyItems(bundle,{mode:mode});if(kind==='products_discount')return computeProductsItems(bundle,{mode:mode});if(kind==='products_no_discount')return computeNoDiscountItems(bundle,{mode:mode});if(kind==='post_add_upsell')return computePostAddItems(bundle,{mode:mode});return computeQtyItems(bundle,{mode:mode})}catch(e){return normalizeItems(bundle)}}function buildTierRows(bundle,bundleId,selectedMinQty,isBundleSelected){try{var tiers=(bundle&&bundle.offer&&bundle.offer.tiers)||[];var pricingTiers=(bundle&&bundle.pricing&&bundle.pricing.tiers)||[];var rows=[];if(Array.isArray(tiers)&&tiers.length){for(var i=0;i<tiers.length;i++){var mq=Math.max(1,Math.floor(Number(tiers[i]&&tiers[i].minQty||1)));var pr=null;for(var j=0;j<pricingTiers.length;j++){var pt=pricingTiers[j]||{};if(Math.floor(Number(pt.minQty||0))===mq){pr=pt;break}}rows.push({minQty:mq,pricing:pr})}}else{rows.push({minQty:1,pricing:pickPricingForQty(bundle,1)})}rows.sort(function(a,b){return a.minQty-b.minQty});var out='';for(var k=0;k<rows.length;k++){var r=rows[k];var prc=r.pricing||{};var o=Number(prc.originalTotal),f=Number(prc.finalTotal),d=Number(prc.discountAmount);var left='عند '+fmtNum(r.minQty)+' قطع';var right='';if(Number.isFinite(o)&&Number.isFinite(f)){right='قبل '+fmtMoney(o)+' • بعد '+fmtMoney(f);if(Number.isFinite(d)&&d>0){right+=' • وفّرت '+fmtMoney(d);var pct=pctFrom(o,f);if(pct!=null)right+=' ('+fmtNum(pct)+'%)'}}var active=Boolean(isBundleSelected&&Number(selectedMinQty)===Number(r.minQty));var cls='bundle-app-tier'+(active?' bundle-app-tier--selected':'');out+='<label class="'+cls+'" data-bundle-id="'+escHtml(bundleId)+'" data-tier-minqty="'+escHtml(r.minQty)+'"><div class="bundle-app-tier-main"><div><strong>'+escHtml(left)+'</strong></div>'+(right?('<div class="bundle-app-muted">'+escHtml(right)+'</div>'):'')+'</div><span class="bundle-app-checkwrap bundle-app-tier-checkwrap"><input class="bundle-app-tier-check" type="checkbox" data-bundle-id="'+escHtml(bundleId)+'" data-tier-minqty="'+escHtml(r.minQty)+'" '+(active?'checked':'')+' /><span class="bundle-app-checkmark"></span></span></label>'+(active?('<div class="bundle-app-pickers bundle-app-pickers--inline" data-bundle-id="'+escHtml(bundleId)+'"></div>'):'')}return out}catch(e){return""}}function normalizeItems(bundle){var comps=(bundle&&bundle.components)||[];if(!Array.isArray(comps)||!comps.length){comps=(bundle&&bundle.bundleItems)||[]}var out=[];var selected=pickMinQty(bundle);var baseQty=Math.max(1,Math.floor(Number(getPageQty()||1)));if(Number.isFinite(selected)&&selected>baseQty)baseQty=selected;for(var i=0;i<comps.length;i++){var c=comps[i]||{};var v=String(c.variantId||"").trim();var pid=String(c.productId||"").trim();var isBase=Boolean(c.isBase);var q=isBase?baseQty:Math.max(1,Math.floor(Number(c.quantity||1)));if(!v)continue;out.push({variantId:v,productId:pid||null,quantity:q,isBase:isBase})}out.sort(function(a,b){return String(a.variantId).localeCompare(String(b.variantId))});return out}function buildPriceText(bundle){try{var selected=pickMinQty(bundle);var baseQty=Math.max(1,Math.floor(Number(getPageQty()||1)));if(Number.isFinite(selected)&&selected>baseQty)baseQty=selected;var p=pickPricingForQty(bundle,baseQty);if(!p)return"";var o=Number(p.originalTotal),f=Number(p.finalTotal),d=Number(p.discountAmount);if(!Number.isFinite(o)||!Number.isFinite(f))return"";var s='قبل '+fmtMoney(o)+' • بعد '+fmtMoney(f);if(Number.isFinite(d)&&d>0)s+=' • وفّرت '+fmtMoney(d);return s}catch(e){return""}}async function applyBundleSelection(bundle){var bid=String(bundle&&bundle.id||"");var trigger=String(bundle&&bundle.triggerProductId||"");var kind=String(bundle&&bundle.kind||"").trim();if(!bid)return;if(!trigger&&(kind!=="products_no_discount"&&kind!=="post_add_upsell"))return;if(storeClosedNow()){messageByBundleId[bid]='لم يتم إضافة الباقة (المتجر مغلق حالياً)';applying=false;try{renderProductBanners(lastBundles||[])}catch(e0){}return}if(kind==="post_add_upsell"&&postAddShownByBundleId[bid]){messageByBundleId[bid]='تم عرض الإضافة بالفعل';try{renderProductBanners(lastBundles||[])}catch(e00){}return}selectedBundleId=bid;applying=true;try{messageByBundleId[bid]='جاري إضافة الباقة...';renderProductBanners(lastBundles||[])}catch(e){}try{var rawItems=(typeof computeBundleApplyItems==="function")?computeBundleApplyItems(bundle):normalizeItems(bundle);var items=await resolveProductRefItems(rawItems,bid);if(!items||!items.length){messageByBundleId[bid]=(kind==="products_discount"||kind==="products_no_discount"||kind==="post_add_upsell")?'اختار المنتجات قبل الإضافة':'لازم تختار الفاريانت قبل إضافة الباقة';applying=false;try{renderProductBanners(lastBundles||[])}catch(e000){}return}if(kind==="products_no_discount"||kind==="post_add_upsell"){try{await addItemsToCart(items);messageByBundleId[bid]='تمت إضافة المنتجات للسلة';if(kind==="post_add_upsell"){postAddShownByBundleId[bid]=true}}catch(addErr){markStoreClosed(addErr);var hm=humanizeCartError(addErr);messageByBundleId[bid]=hm?('لم يتم الإضافة ('+hm+')'):'لم يتم الإضافة'}applying=false;try{renderProductBanners(lastBundles||[])}catch(e01){}return}var prev=loadSelection(trigger);await tryClearCoupon();if(storeClosedNow()){messageByBundleId[bid]='لم يتم إضافة الباقة (المتجر مغلق حالياً)';applying=false;try{renderProductBanners(lastBundles||[])}catch(e02){}return}if(prev&&prev.bundleId&&String(prev.bundleId)!==bid&&Array.isArray(prev.items)&&prev.items.length){await removeItemsFromCart(prev.items)}if(storeClosedNow()){messageByBundleId[bid]='لم يتم إضافة الباقة (المتجر مغلق حالياً)';applying=false;try{renderProductBanners(lastBundles||[])}catch(e03){}return}try{await addItemsToCart(items)}catch(addErr2){markStoreClosed(addErr2);var hm3=humanizeCartError(addErr2);messageByBundleId[bid]=hm3?('لم يتم إضافة الباقة ('+hm3+')'):'لم يتم إضافة الباقة';applying=false;try{renderProductBanners(lastBundles||[])}catch(e09){}return}messageByBundleId[bid]='جاري تجهيز الخصم...';try{renderProductBanners(lastBundles||[])}catch(e2){}var res=await requestApplyBundle(bid,items.map(function(it){return{variantId:it.variantId,quantity:it.quantity}}));var hasDiscount=Boolean(res&&res.hasDiscount&&res.couponCode);var issueFailed=Boolean(res&&res.couponIssueFailed);if(hasDiscount){saveSelection(trigger,{bundleId:bid,triggerProductId:trigger,items:items,ts:Date.now()});savePendingCoupon(trigger,{code:String(res.couponCode),ts:Date.now()});var ok=await tryApplyCoupon(String(res.couponCode));if(ok){clearPendingCoupon(trigger);messageByBundleId[bid]='تم تطبيق الخصم على السلة'}else{var st=null;var msg="";try{st=g.BundleApp&&g.BundleApp._lastCouponApplyStatus}catch(x0){}try{msg=g.BundleApp&&g.BundleApp._lastCouponApplyMessage}catch(x1){}var stN=Number(st);var showErr=Number.isFinite(stN)&&(stN===410||stN===401||stN===403||stN===404);if(!showErr){var m0=String(msg||"");showErr=(m0==='timeout'||m0.indexOf('ERR_NAME_NOT_RESOLVED')!==-1||m0.indexOf('لم يعد متاحا')!==-1||m0.toLowerCase().indexOf('no longer available')!==-1)}var hm2=humanizeCartError({status:st,message:msg});if(showErr&&hm2){messageByBundleId[bid]='تمت إضافة الباقة لكن تعذر تطبيق الخصم ('+hm2+')'}else{messageByBundleId[bid]='تم تجهيز الكوبون، افتح السلة وسيتم تطبيقه تلقائيًا'}}}else if(issueFailed){messageByBundleId[bid]='تمت إضافة الباقة لكن تعذر إنشاء كوبون الخصم. حاول مرة أخرى.';clearPendingCoupon(trigger)}else{messageByBundleId[bid]='تمت إضافة الباقة. لا يوجد خصم لهذه الباقة.';clearPendingCoupon(trigger)}selectedBundleId=bid}catch(e4){warn("bundle-app: apply bundle failed",e4&&((e4.details)||e4.message||e4));var em=String((e4&&e4.message)||"").trim();if(em&&em.length>160)em=em.slice(0,160);messageByBundleId[bid]='حصل خطأ أثناء إضافة الباقة أو تطبيق الخصم'+(em?(' ('+em+')'):'')}applying=false;try{renderProductBanners(lastBundles||[])}catch(e5){} }var lastBundles=null;async function refreshProduct(){var state=null;try{state=(g.BundleApp&&g.BundleApp.__refreshState)?g.BundleApp.__refreshState:(g.BundleApp.__refreshState={busy:false,queued:false,lastKey:"",lastSig:""});if(state.busy){state.queued=true;return}state.busy=true;var variantId=findVariantId();var productId=findProductId();var key=variantId?('v:'+String(variantId)):productId?('p:'+String(productId)):"";log("bundle-app: ids",{variantId:variantId,productId:productId});var res=null;if(variantId){res=await getProductBundlesByVariantId(variantId)}else if(productId){res=await getProductBundlesByProductId(productId)}else{clearProductBanner();state.lastKey="";state.lastSig="";return}var bundles=(res&&res.bundles)||[];if(!bundles.length){clearProductBanner();state.lastKey=key;state.lastSig="";return}var sig='';for(var i=0;i<bundles.length;i++){var b=bundles[i]||{};sig+=String(b.id||i)+'|'+bundleVariantSig(b)+'|'+String(((b.pricing&&b.pricing.base&&b.pricing.base.finalTotal)!=null)?(b.pricing.base.finalTotal):'')+';'}if(!applying&&key===state.lastKey&&sig===state.lastSig)return;state.lastKey=key;state.lastSig=sig;lastBundles=bundles;renderProductBanners(bundles)}catch(e){warn("bundle-app: refresh failed",e&&((e.details)||e.message||e));clearProductBanner()}finally{if(state){state.busy=false;if(state.queued){state.queued=false;setTimeout(function(){refreshProduct()},0)}}}}g.BundleApp.getProductBundlesByVariantId=getProductBundlesByVariantId;g.BundleApp.getProductBundlesByProductId=getProductBundlesByProductId;g.BundleApp.refreshProduct=refreshProduct;g.BundleApp.applyBundleSelection=applyBundleSelection;function renderProductBanners(bundles){ensureStyles();var id="bundle-app-banner";var root=document.getElementById(id);if(!root){root=document.createElement("div");root.id=id}mountBanner(root);var arr=Array.isArray(bundles)?bundles:[];if(!arr.length){clearProductBanner();return}var trigger=String(arr[0]&&arr[0].triggerProductId||"");lastTriggerProductId=trigger||lastTriggerProductId;if(selectedBundleId){var ok=false;for(var z0=0;z0<arr.length;z0++){if(String(arr[z0]&&arr[z0].id||"")===String(selectedBundleId||"")){ok=true;break}}if(!ok)selectedBundleId=null}var html='';for(var i=0;i<arr.length;i++){var b=arr[i]||{};var bid=String(b.id||"");var color=String(b.bannerColor||"#0ea5e9");var textColor=String(b.textColor||"#ffffff");var title=normalizeTitle(b.title);var subtitle=String(b.subtitle||"");var label=String(b.label||"");var labelSub=String(b.labelSub||"");var labelBg=String(b.labelBgColor||b.badgeColor||"");var labelText=String(b.labelTextColor||textColor||"");var ctaBg=String(b.ctaBgColor||"");var ctaText=String(b.ctaTextColor||"");var showItems=(b&&b.showItems===false)?false:true;var showPrice=(b&&b.showPrice===false)?false:true;var showTiers=(b&&b.showTiers===false)?false:true;var checked=bid===String(selectedBundleId||"");var selectedMinQty=pickMinQty(b);var items=(typeof computeBundleApplyItems==="function")?computeBundleApplyItems(b,{mode:'preview'}):normalizeItems(b);var itemsText=(showItems&&items.length)?buildItemsText(items):'';var priceText='';if(showPrice){if(String(b.kind||"")==='products_discount'){priceText=items&&items.length?'السعر حسب اختيارك':''}else{priceText=buildPriceText(b)}}var tiersHtml=showTiers?buildTierRows(b,bid,selectedMinQty,checked):'';var msg=String(messageByBundleId[bid]||"");var cls='bundle-app-card'+(checked?' bundle-app-card--selected':'');var btnLabel=String(b.cta||"أضف الباقة");if(tiersHtml){btnLabel=btnLabel+' ('+fmtNum(Math.max(getPageQty(),Math.max(minRequiredBaseQty(b),selectedMinQty)))+' قطع)'}var cardStyle='background:'+escHtml(color)+';color:'+escHtml(textColor)+';';var btnStyle='';if(ctaBg)btnStyle+='background:'+escHtml(ctaBg)+';';if(ctaText)btnStyle+='color:'+escHtml(ctaText)+';';var labelStyle='';if(labelBg)labelStyle+='background:'+escHtml(labelBg)+';';else labelStyle+='background:rgba(255,255,255,.18);';if(labelText)labelStyle+='color:'+escHtml(labelText)+';';html+='<div class="'+cls+'" style="'+cardStyle+'" data-bundle-id="'+escHtml(bid)+'"><div class="bundle-app-row"><div class="bundle-app-content"><div class="bundle-app-head"><div style="min-width:0"><div class="bundle-app-title">'+escHtml(title)+'</div>'+(subtitle?('<div class="bundle-app-subtitle">'+escHtml(subtitle)+'</div>'):'')+(labelSub?('<div class="bundle-app-label-sub">'+escHtml(labelSub)+'</div>'):'')+'</div>'+(label?('<div class="bundle-app-label" style="'+labelStyle+'">'+escHtml(label)+'</div>'):'')+'</div>'+(itemsText?('<div class="bundle-app-items">'+escHtml(itemsText)+'</div>'):'')+(priceText?('<div class="bundle-app-price">'+escHtml(priceText)+'</div>'):'')+(msg?('<div class="bundle-app-msg">'+escHtml(msg)+'</div>'):'')+'</div><button class="bundle-app-btn" type="button" data-action="apply-one" data-bundle-id="'+escHtml(bid)+'" '+(applying?'disabled':'')+(btnStyle?(' style="'+btnStyle+'"'):'')+'>'+escHtml(btnLabel)+'</button></div>'+(tiersHtml?('<div class="bundle-app-tiers">'+tiersHtml+'</div>'):'')+'</div>'}root.innerHTML=html;var tierChecks=root.querySelectorAll('input.bundle-app-tier-check[data-bundle-id][data-tier-minqty]');for(var tc=0;tc<tierChecks.length;tc++){(function(el){el.onchange=function(){var bid=String(el.getAttribute('data-bundle-id')||"");var mq=Number(el.getAttribute('data-tier-minqty'));if(!bid||!Number.isFinite(mq)||mq<1)return;var next=Math.floor(mq);if(el.checked){selectedBundleId=bid;selectedTierByBundleId[bid]=next;messageByBundleId[bid]=''}else{var cur=Number(selectedTierByBundleId[bid]);if(String(selectedBundleId||"")===bid&&Number.isFinite(cur)&&Math.floor(cur)===next){selectedBundleId=null}}renderProductBanners(arr)}})(tierChecks[tc])}var btns=root.querySelectorAll('button.bundle-app-btn[data-action="apply-one"][data-bundle-id]');for(var k=0;k<btns.length;k++){(function(btn){btn.onclick=function(){var bid=String(btn.getAttribute('data-bundle-id')||"");if(!bid||applying)return;selectedBundleId=bid;var bundle=null;for(var i=0;i<arr.length;i++){if(String(arr[i]&&arr[i].id||"")===bid){bundle=arr[i];break}}if(!bundle)return;applyBundleSelection(bundle)}})(btns[k])}if(selectedBundleId){var selCard=null;var cards=root.querySelectorAll('.bundle-app-card[data-bundle-id]');for(var ci=0;ci<cards.length;ci++){var c0=cards[ci];if(String(c0.getAttribute('data-bundle-id')||"")===String(selectedBundleId||"")){selCard=c0;break}}var selBundle=null;for(var s0=0;s0<arr.length;s0++){if(String(arr[s0]&&arr[s0].id||"")===String(selectedBundleId||"")){selBundle=arr[s0];break}}if(selCard&&selBundle){ensureVariantPickersForCard(selCard,selBundle)}}}initOnce();var scriptSrc=(document.currentScript&&document.currentScript.src)||"";if(!scriptSrc){try{var ss=document.getElementsByTagName("script");for(var i=0;i<ss.length;i++){var s=ss[i];var src=(s&&s.src)||"";if(!src)continue;if(src.indexOf("/api/storefront/snippet.js")!==-1&&src.indexOf("merchantId="+encodeURIComponent(merchantId))!==-1){scriptSrc=src;break}}}catch(e){}}function findVariantId(){try{var url=new URL(window.location.href);var fromUrl=url.searchParams.get("variant_id")||url.searchParams.get("variantId")||url.searchParams.get("variant")||"";if(fromUrl)return String(fromUrl).trim();var el=document.querySelector('[name="variant_id"],[name="variantId"],[data-variant-id],input[name="variant_id"],select[name="variant_id"]');if(el){var v=el.getAttribute("data-variant-id")||el.value||"";v=String(v).trim();if(v)return v}var any=document.querySelector("[data-variant-id]");if(any){var a=String(any.getAttribute("data-variant-id")||"").trim();if(a)return a}return""}catch(e){return""}}function findProductId(){try{var path=String(window.location.pathname||"");var m=path.match(/\/p(\d+)(?:[/?#]|$)/);if(m&&m[1])return String(m[1]);var el=document.querySelector("[data-product-id],input[name=\"product_id\"],input[name=\"productId\"]");if(el){var v=el.getAttribute("data-product-id")||el.value||"";v=String(v).trim();if(v)return v}return""}catch(e){return""}}function openPickerModal(titleHtml,bodyHtml){var resolver=null;var wait=new Promise(function(r){resolver=r});var overlay=document.createElement("div");overlay.id="bundle-app-modal";overlay.style.position="fixed";overlay.style.inset="0";overlay.style.background="rgba(0,0,0,.45)";overlay.style.zIndex="100000";overlay.style.display="flex";overlay.style.alignItems="center";overlay.style.justifyContent="center";overlay.style.padding="16px";var card=document.createElement("div");card.style.width="min(520px,100%)";card.style.maxHeight="80vh";card.style.overflow="auto";card.style.background="#fff";card.style.borderRadius="14px";card.style.boxShadow="0 12px 40px rgba(0,0,0,.25)";card.style.padding="12px";card.innerHTML='<div style="display:flex;align-items:center;justify-content:space-between;gap:10px"><div style="font-weight:900;font-size:14px">'+titleHtml+'</div><button type="button" data-action="close" style="border:0;background:transparent;font-size:18px;line-height:1;cursor:pointer">×</button></div><div style="margin-top:10px">'+bodyHtml+'</div>';overlay.appendChild(card);function close(val){try{overlay.remove()}catch(e){}if(resolver){var r=resolver;resolver=null;r(val)}}overlay.addEventListener("click",function(e){if(e.target===overlay)close(null)});var closeBtn=card.querySelector('button[data-action="close"]');if(closeBtn)closeBtn.onclick=function(){close(null)};document.body.appendChild(overlay);return {overlay:overlay,card:card,close:close,wait:wait}}async function resolveProductRefItems(items,bundleId){var bid=String(bundleId||"").trim();var pre=(bid&&variantSelectionsByBundleId[bid]&&typeof variantSelectionsByBundleId[bid]==="object")?variantSelectionsByBundleId[bid]:null;var arr=Array.isArray(items)?items:[];var needs=[];var fixed=[];for(var i=0;i<arr.length;i++){var it=arr[i]||{};var v=String(it.variantId||"").trim();var qty=Math.max(1,Math.floor(Number(it.quantity||1)));var pid=String(it.productId||"").trim();if(isProductRef(v)){if(!pid)return null;needs.push({productId:pid,quantity:qty})}else{if(!v)continue;fixed.push({variantId:v,productId:pid||null,quantity:qty})}}if(!needs.length)return fixed;var units=[];var uniqPid={};for(var j=0;j<needs.length;j++){var n=needs[j];var pid2=String(n.productId);uniqPid[pid2]=true;for(var u=0;u<Number(n.quantity||0);u++){units.push({productId:pid2,key:pid2+":"+u})}}var pidList=Object.keys(uniqPid);var varsByPid={};for(var p=0;p<pidList.length;p++){var pid3=pidList[p];var vars=await getCachedVariants(pid3);varsByPid[pid3]=Array.isArray(vars)?vars:[];if(!varsByPid[pid3].length){varsByPid[pid3]=[{variantId:('product:'+pid3),productId:pid3,cartProductId:pid3,cartOptions:null,isActive:true,name:null,attributes:{},imageUrl:null,price:null}]}}var selectedByKey={};var pending=[];for(var k=0;k<units.length;k++){var unit=units[k];var vlist=(varsByPid[unit.productId]||[]).filter(function(x){return x&&x.isActive===true&&String(x.variantId||"").trim()});var preVal=pre?String(pre[unit.key]||"").trim():"";if(preVal){var ok=false;for(var z=0;z<vlist.length;z++){if(String(vlist[z]&&vlist[z].variantId||"").trim()===preVal){ok=true;break}}if(ok){selectedByKey[unit.key]=preVal;continue}}if(vlist.length===1){selectedByKey[unit.key]=String(vlist[0].variantId||"").trim()}else{pending.push(unit)}}if(pending.length){var body='';for(var x=0;x<pending.length;x++){var un=pending[x];var opts=(varsByPid[un.productId]||[]).filter(function(y){return y&&y.isActive===true&&String(y.variantId||"").trim()});if(!opts.length)continue;body+='<div style="margin-bottom:16px"><div style="margin-bottom:6px;font-weight:600">'+escHtml('اختر فاريانت للمنتج')+'</div><div style="display:flex;flex-wrap:wrap;gap:6px">';for(var y=0;y<opts.length;y++){var o=opts[y];var img=o.imageUrl?'<img src="'+escHtml(o.imageUrl)+'" style="width:32px;height:32px;border-radius:4px;margin-left:6px">':'';body+='<button type="button" data-action="pick-variant" data-unit-key="'+escHtml(un.key)+'" data-variant-id="'+escHtml(String(o.variantId||"").trim())+'" style="display:flex;align-items:center;padding:6px 10px;border:1px solid #e5e7eb;border-radius:6px;background:#fff;cursor:pointer;font-size:13px">'+img+'<span>'+escHtml(variantLabel(o))+'</span></button>'}body+='</div></div>'}var modal=await openPickerModal('اختيار الفاريانتات',body);if(!modal)return null;var picked={};await modal.wait;var btns=modal.card.querySelectorAll('button[data-action="pick-variant"]');for(var b=0;b<btns.length;b++){var btn=btns[b];var k=String(btn.getAttribute('data-unit-key')||"").trim();var v=String(btn.getAttribute('data-variant-id')||"").trim();if(k&&v&&btn.classList.contains('is-selected'))picked[k]=v}for(var key in picked){if(!Object.prototype.hasOwnProperty.call(picked,key))continue;selectedByKey[key]=picked[key]}}var out=fixed.slice();for(var key2 in selectedByKey){if(!Object.prototype.hasOwnProperty.call(selectedByKey,key2))continue;var vid=String(selectedByKey[key2]||"").trim();if(!vid)continue;var meta=null;for(var pidKey in varsByPid){if(!Object.prototype.hasOwnProperty.call(varsByPid,pidKey))continue;var list=varsByPid[pidKey]||[];for(var li=0;li<list.length;li++){var item=list[li];if(item&&String(item.variantId||"").trim()===vid){meta=item;break}}if(meta)break}if(!meta)continue;out.push({variantId:vid,productId:meta.productId,cartProductId:meta.cartProductId,cartOptions:meta.cartOptions,quantity:1})}return out}function applySelectionsToContainer(container,bundleId){try{if(!container)return;var bid=String(bundleId||"").trim();if(!bid)return;var rows=container.querySelectorAll('[data-unit-key-row]');for(var i=0;i<rows.length;i++){var row=rows[i];var key=String(row.getAttribute('data-unit-key-row')||"").trim();if(!key)continue;var btns=row.querySelectorAll('button[data-action="pick-variant"][data-variant-id]');for(var j=0;j<btns.length;j++){var b=btns[j];var vid=String(b.getAttribute('data-variant-id')||"").trim();var on=Boolean(val&&vid&&val===vid);if(on){b.classList.add('is-selected');b.setAttribute('aria-pressed','true')}else{b.classList.remove('is-selected');b.setAttribute('aria-pressed','false')}}}}catch(e){}}function updatePickerStatus(container,bundleId){try{if(!container)return;var bid=String(bundleId||"").trim();if(!bid)return;var rows=container.querySelectorAll('[data-unit-key-row]');var total=rows.length;var chosen=0;for(var i=0;i<rows.length;i++){var key=String(rows[i].getAttribute('data-unit-key-row')||"").trim();if(!key)continue;var v=String(sel[key]||"").trim();if(v)chosen++}var el=container.querySelector('[data-role="picker-status"]');if(el)el.textContent=total?('تم اختيار '+fmtNum(chosen)+' من '+fmtNum(total)):''}catch(e){}}function bindPickerContainer(container,bundleId){try{if(!container)return;var bid=String(bundleId||"").trim();if(!bid)return;container.onclick=function(e){var t=e&&e.target;while(t&&t!==container){if(t&&t.getAttribute&&t.getAttribute('data-action')==='pick-variant')break;t=t.parentNode}if(!t||t===container)return;var key=String(t.getAttribute('data-unit-key')||"").trim();var val=String(t.getAttribute('data-variant-id')||"").trim();if(!key||!val)return;var sel=getBundleVariantSelectionMap(bid);if(!sel)return;sel[key]=val;applySelectionsToContainer(container,bid);updatePickerStatus(container,bid)};applySelectionsToContainer(container,bid);updatePickerStatus(container,bid)}catch(e){}}async function ensureVariantPickersForCard(card,bundle){try{if(!card||!bundle)return;ensurePickerStyles();var bid=String(card.getAttribute('data-bundle-id')||"").trim();if(!bid)return;var container=card.querySelector('.bundle-app-pickers[data-bundle-id]');if(!container)return;var sig=bundleVariantSig(bundle);var cached=variantPickerCacheByBundleId[bid];if(cached&&cached.sig===sig&&cached.html!=null){container.innerHTML=cached.html;bindPickerContainer(container,bid);return}var pending=variantPickerPendingByBundleId[bid];if(pending&&pending.sig===sig&&pending.promise)return;container.innerHTML='<div class="bundle-app-picker-hint">جاري تحميل الفاريانت...</div>';var promise=(async function(){var units=bundleVariantUnits(bundle);var sel=getBundleVariantSelectionMap(bid);if(!units.length){variantPickerCacheByBundleId[bid]={sig:sig,html:""};container.innerHTML='';return}pruneBundleSelections(sel,units);var uniq={};for(var i=0;i<units.length;i++){uniq[String(units[i].productId)]=true}var pids=Object.keys(uniq);var lists=await Promise.all(pids.map(function(pid){return getCachedVariants(pid)}));var varsByPid={};for(var j=0;j<pids.length;j++){var pid=pids[j];var list=Array.isArray(lists[j])?lists[j]:[];list=list.filter(function(x){return x&&x.isActive===true&&String(x.variantId||"").trim()});if(!list.length){list=[{variantId:('product:'+pid),productId:pid,cartProductId:pid,cartOptions:null,isActive:true,name:null,attributes:{},imageUrl:null,price:null}]}varsByPid[pid]=list}var need=[];for(var k=0;k<units.length;k++){var unit=units[k];var list2=varsByPid[unit.productId]||[];if(list2.length===1){var only=list2[0]||{};var vid=String(only.variantId||"").trim();if(vid)sel[unit.key]=vid}else if(list2.length>1){need.push(unit)}}if(!need.length){variantPickerCacheByBundleId[bid]={sig:sig,html:""};container.innerHTML='';return}var html='<div class="bundle-app-pickers-title">اختيار الفاريانت للكميات</div><div class="bundle-app-picker-status" data-role="picker-status">جاري التحميل...</div>';for(var m=0;m<need.length;m++){var un=need[m];var opts=(varsByPid[un.productId]||[]).filter(function(y){return y&&y.isActive===true&&String(y.variantId||"").trim()});if(!opts.length)continue;html+='<div style="margin-bottom:16px"><div style="margin-bottom:6px;font-weight:600">'+escHtml('اختر فاريانت')+'</div><div style="display:flex;flex-wrap:wrap;gap:6px" data-unit-key-row="'+escHtml(un.key)+'">';for(var n=0;n<opts.length;n++){var o=opts[n];var img=o.imageUrl?'<img src="'+escHtml(o.imageUrl)+'" style="width:32px;height:32px;border-radius:4px;margin-left:6px">':'';var on=String(sel[un.key]||"").trim()===String(o.variantId||"").trim();html+='<button type="button" data-action="pick-variant" data-unit-key="'+escHtml(un.key)+'" data-variant-id="'+escHtml(String(o.variantId||"").trim())+'" class="'+(on?'is-selected':'')+'" style="display:flex;align-items:center;padding:6px 10px;border:1px solid #e5e7eb;border-radius:6px;background:#fff;cursor:pointer;font-size:13px">'+img+'<span>'+escHtml(variantLabel(o))+'</span></button>'}html+='</div></div>'}variantPickerCacheByBundleId[bid]={sig:sig,html:html};container.innerHTML=html;bindPickerContainer(container,bid)})();variantPickerPendingByBundleId[bid]={sig:sig,promise:promise};try{await promise}catch(e){}delete variantPickerPendingByBundleId[bid]}else{await pending.promise}}catch(e){}}function renderProductBanners(bundles){ensureStyles();ensureTraditionalStyles();var id="bundle-app-banner";var root=document.getElementById(id);if(!root){root=document.createElement("div");root.id=id}mountBanner(root);var arr=Array.isArray(bundles)?bundles:[];if(!arr.length){clearProductBanner();return}var trigger=String(arr[0]&&arr[0].triggerProductId||"");lastTriggerProductId=trigger||lastTriggerProductId;if(selectedBundleId){var ok=false;for(var z0=0;z0<arr.length;z0++){if(String(arr[z0]&&arr[z0].id||"")===String(selectedBundleId||"")){ok=true;break}}if(!ok)selectedBundleId=null}var html='';for(var i=0;i<arr.length;i++){var b=arr[i]||{};var bid=String(b.id||"");var color=String(b.bannerColor||"#0ea5e9");var textColor=String(b.textColor||"#ffffff");var title=normalizeTitle(b.title);var subtitle=String(b.subtitle||"");var label=String(b.label||"");var labelSub=String(b.labelSub||"");var labelBg=String(b.labelBgColor||b.badgeColor||"");var labelText=String(b.labelTextColor||textColor||"");var ctaBg=String(b.ctaBgColor||"");var ctaText=String(b.ctaTextColor||"");var showItems=(b&&b.showItems===false)?false:true;var showPrice=(b&&b.showPrice===false)?false:true;var showTiers=(b&&b.showTiers===false)?false:true;var selectedMinQty=pickMinQty(b);var items=normalizeItems(b);var itemsText=(showItems&&items.length)?buildItemsText(items):'';var priceText=showPrice?buildPriceText(b):'';var tiersHtml=showTiers?buildTierRows(b,bid,selectedMinQty):'';var msg=String(messageByBundleId[bid]||"");var checked=bid===String(selectedBundleId||"");var cls='bundle-app-card'+(checked?' bundle-app-card--selected':'');var btnLabel=String(b.cta||"أضف الباقة");if(tiersHtml){btnLabel=btnLabel+' ('+fmtNum(Math.max(getPageQty(),Math.max(minRequiredBaseQty(b),selectedMinQty)))+' قطع)'}var cardStyle='background:'+escHtml(color)+';color:'+escHtml(textColor)+';';var btnStyle='';if(ctaBg)btnStyle+='background:'+escHtml(ctaBg)+';';if(ctaText)btnStyle+='color:'+escHtml(ctaText)+';';var labelStyle='';if(labelBg)labelStyle+='background:'+escHtml(labelBg)+';';else labelStyle+='background:rgba(255,255,255,.18);';if(labelText)labelStyle+='color:'+escHtml(labelText)+';';html+='<div class="'+cls+'" style="'+cardStyle+'" data-bundle-id="'+escHtml(bid)+'"><div class="bundle-app-traditional"><div class="bundle-app-header"><div class="bundle-app-title-section"><div class="bundle-app-title">'+escHtml(title)+'</div>'+(subtitle?('<div class="bundle-app-subtitle">'+escHtml(subtitle)+'</div>'):'')+(labelSub?('<div class="bundle-app-label-sub">'+escHtml(labelSub)+'</div>'):'')+'</div>'+(label?('<div class="bundle-app-label" style="'+labelStyle+'">'+escHtml(label)+'</div>'):'')+'</div>'+(itemsText?('<div class="bundle-app-items-summary">'+escHtml(itemsText)+'</div>'):'')+'<div class="bundle-app-products-section">';if(items&&items.length){for(var j=0;j<items.length;j++){var item=items[j]||{};var itemChecked=checked;html+='<div class="bundle-app-product-item" data-item-index="'+j+'"><div class="bundle-app-product-header"><label class="bundle-app-product-checkwrap"><input class="bundle-app-product-check" type="checkbox" data-bundle-id="'+escHtml(bid)+'" data-item-index="'+j+'" '+(itemChecked?'checked':'')+' /><span class="bundle-app-checkmark"></span></label><div class="bundle-app-product-info"><div class="bundle-app-product-name">منتج '+(j+1)+'</div><div class="bundle-app-product-qty">الكمية: '+fmtNum(item.quantity||1)+'</div></div></div><div class="bundle-app-product-variants" data-bundle-id="'+escHtml(bid)+'" data-item-index="'+j+'"></div></div>'}}html+='</div>'+(priceText?('<div class="bundle-app-price">'+escHtml(priceText)+'</div>'):'')+(tiersHtml?('<div class="bundle-app-tiers">'+tiersHtml+'</div>'):'')+(msg?('<div class="bundle-app-msg">'+escHtml(msg)+'</div>'):'')+'<div class="bundle-app-footer"><button class="bundle-app-btn" type="button" data-action="apply-one" data-bundle-id="'+escHtml(bid)+'" '+(applying?'disabled':'')+(btnStyle?(' style="'+btnStyle+'"'):'')+'>'+escHtml(btnLabel)+'</button></div></div></div>'}root.innerHTML=html;var tierEls=root.querySelectorAll('.bundle-app-tier[data-tier-minqty][data-bundle-id]');for(var t=0;t<tierEls.length;t++){(function(el){el.onclick=function(){var bid=String(el.getAttribute('data-bundle-id')||"");var mq=Number(el.getAttribute('data-tier-minqty'));if(bid&&Number.isFinite(mq)&&mq>=1){selectedTierByBundleId[bid]=Math.floor(mq);messageByBundleId[bid]='';renderProductBanners(arr)}}})(tierEls[t])}var productChecks=root.querySelectorAll('input.bundle-app-product-check[data-bundle-id][data-item-index]');for(var c=0;c<productChecks.length;c++){(function(el){el.onchange=function(){var bid=String(el.getAttribute('data-bundle-id')||"");var itemIndex=String(el.getAttribute('data-item-index')||"");if(!bid||itemIndex==="")return;if(el.checked){selectedBundleId=bid;messageByBundleId[bid]='';var otherChecks=root.querySelectorAll('input.bundle-app-product-check[data-bundle-id]:not([data-bundle-id="'+bid+'"])');for(var o=0;o<otherChecks.length;o++){otherChecks[o].checked=false}var sameBundleChecks=root.querySelectorAll('input.bundle-app-product-check[data-bundle-id="'+bid+'"]');for(var s=0;s<sameBundleChecks.length;s++){sameBundleChecks[s].checked=true}}else{var bundleChecks=root.querySelectorAll('input.bundle-app-product-check[data-bundle-id="'+bid+'"]');var anyChecked=false;for(var b=0;b<bundleChecks.length;b++){if(bundleChecks[b].checked){anyChecked=true;break}}if(!anyChecked&&String(selectedBundleId||"")===bid){selectedBundleId=null}}renderProductBanners(arr)}})(productChecks[c])}var btns=root.querySelectorAll('button.bundle-app-btn[data-action="apply-one"][data-bundle-id]');for(var k=0;k<btns.length;k++){(function(btn){btn.onclick=function(){var bid=String(btn.getAttribute('data-bundle-id')||"");if(!bid||applying)return;var bundleChecks=root.querySelectorAll('input.bundle-app-product-check[data-bundle-id="'+bid+'"]');var anyChecked=false;for(var b=0;b<bundleChecks.length;b++){if(bundleChecks[b].checked){anyChecked=true;break}}if(!anyChecked){messageByBundleId[bid]='يرجى اختيار منتج واحد على الأقل من الباقة';renderProductBanners(arr);return}selectedBundleId=bid;var bundle=null;for(var i=0;i<arr.length;i++){if(String(arr[i]&&arr[i].id||"")===bid){bundle=arr[i];break}}if(!bundle)return;applyBundleSelection(bundle)}})(btns[k])}if(selectedBundleId){var selCard=null;var cards=root.querySelectorAll('.bundle-app-card[data-bundle-id]');for(var ci=0;ci<cards.length;ci++){var c0=cards[ci];if(String(c0.getAttribute('data-bundle-id')||"")===String(selectedBundleId||"")){selCard=c0;break}}var selBundle=null;for(var s0=0;s0<arr.length;s0++){if(String(arr[s0]&&arr[s0].id||"")===String(selectedBundleId||"")){selBundle=arr[s0];break}}if(selCard&&selBundle){ensureVariantPickersForTraditionalCard(selCard,selBundle)}}}function ensureVariantPickersForTraditionalCard(card,bundle){try{if(!card||!bundle)return;ensurePickerStyles();var bid=String(card.getAttribute('data-bundle-id')||"").trim();if(!bid)return;var variantContainers=card.querySelectorAll('.bundle-app-product-variants[data-bundle-id][data-item-index]');var units=bundleVariantUnits(bundle);var sel=getBundleVariantSelectionMap(bid);if(!units.length){for(var v=0;v<variantContainers.length;v++){variantContainers[v].innerHTML=''}return}pruneBundleSelections(sel,units);var unitsByItem={};for(var i=0;i<units.length;i++){var unit=units[i];var itemIndex=Math.floor(i);if(!unitsByItem[itemIndex])unitsByItem[itemIndex]=[];unitsByItem[itemIndex].push(unit)}for(var j=0;j<variantContainers.length;j++){var container=variantContainers[j];var itemIndex=String(container.getAttribute('data-item-index')||"");var itemUnits=unitsByItem[itemIndex]||[];if(!itemUnits.length){container.innerHTML='';continue}var itemHtml='<div class="bundle-app-pickers-title">اختيار الفاريانت</div>';for(var k=0;k<itemUnits.length;k++){var unit=itemUnits[k];var productId=unit.productId;var unitKey=unit.key;(function(cont,pid,key){getCachedVariants(pid).then(function(variants){if(!variants||!variants.length){cont.innerHTML='';return}var selectedVariantId=sel[key]||'';var variantHtml='<div class="bundle-app-variant-row" data-unit-key-row="'+escHtml(key)+'"><div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:8px">';for(var v=0;v<variants.length;v++){var variant=variants[v];if(!variant||!variant.isActive)continue;var variantId=String(variant.variantId||"").trim();var isSelected=selectedVariantId===variantId;variantHtml+='<button type="button" data-action="pick-variant" data-unit-key="'+escHtml(key)+'" data-variant-id="'+escHtml(variantId)+'" class="bundle-app-variant-btn'+(isSelected?' is-selected':'')+'" aria-pressed="'+(isSelected?'true':'false')+'" style="display:flex;align-items:center;padding:6px 10px;border:1px solid rgba(255,255,255,0.3);border-radius:6px;background:rgba(255,255,255,0.1);cursor:pointer;font-size:13px;color:inherit;transition:all 0.2s ease">';if(variant.imageUrl){variantHtml+='<img src="'+escHtml(variant.imageUrl)+'" alt="" style="width:32px;height:32px;border-radius:4px;margin-left:8px;">'}variantHtml+='<span>'+escHtml(variantLabel(variant))+'</span></button>'}variantHtml+='</div></div>';cont.innerHTML=itemHtml+variantHtml;bindPickerContainer(cont,bid)})})(container,productId,unitKey)}}}catch(e){console.error('Error in ensureVariantPickersForTraditionalCard:',e)}}function clearProductBanner(){var root=document.getElementById("bundle-app-banner");if(root)root.remove()}function initOnce(){var inited=false;function start(){if(inited)return;inited=true;applyPendingCouponForCart();refreshProduct()}if(document.readyState==="loading"){document.addEventListener("DOMContentLoaded",start)}else{start()}}})();var __bundleAppCssBase=".bundle-app-container{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}\n.bundle-app-banner--inline{position:relative;display:block;width:100%;max-width:100%;margin:12px 0;z-index:10;box-sizing:border-box;grid-column:1 / -1;justify-self:stretch;align-self:stretch;flex:0 0 100%;flex-basis:100%;min-width:0;clear:both}\n.bundle-app-banner--fixed{position:fixed;left:16px;right:16px;bottom:16px;z-index:99999}\n.bundle-app-card{border-radius:14px;padding:12px 14px;color:#fff;box-shadow:0 10px 25px rgba(0,0,0,.18)}\n.bundle-app-card+.bundle-app-card{margin-top:10px}\n.bundle-app-row{display:flex;gap:10px;align-items:flex-start;justify-content:space-between}\n.bundle-app-title{font-size:14px;font-weight:800;line-height:1.2}\n.bundle-app-sub{font-size:12px;opacity:.95;margin-top:6px;line-height:1.3}\n.bundle-app-muted{opacity:.9}\n.bundle-app-choice{display:flex;gap:10px;align-items:flex-start}\n.bundle-app-radio{margin-top:3px}\n.bundle-app-btn{border:0;border-radius:12px;padding:10px 12px;font-size:13px;font-weight:800;cursor:pointer;background:rgba(255,255,255,.18);color:#fff}\n.bundle-app-btn:disabled{opacity:.6;cursor:not-allowed}\n.bundle-app-items{margin-top:8px;font-size:12px;opacity:.95;line-height:1.35}\n.bundle-app-price{margin-top:8px;font-size:12px;opacity:.95;line-height:1.35}\n.bundle-app-msg{margin-top:8px;font-size:12px;opacity:.95;line-height:1.35}\n.bundle-app-choice{position:relative;display:flex;gap:10px;align-items:flex-start}\n.bundle-app-radio{position:absolute;opacity:0;pointer-events:none}\n.bundle-app-dot{width:18px;height:18px;border-radius:999px;border:2px solid rgba(255,255,255,.85);box-sizing:border-box;flex:0 0 18px;margin-top:4px;background:transparent}\n.bundle-app-radio:checked + .bundle-app-dot{background:rgba(255,255,255,.95);box-shadow:inset 0 0 0 4px rgba(17,24,39,.45)}\n.bundle-app-card{border-radius:16px;padding:14px 14px;box-shadow:0 14px 40px rgba(2,6,23,.18);overflow:hidden}\n.bundle-app-card--selected{outline:2px solid rgba(255,255,255,.7)}\n.bundle-app-row{gap:12px}\n.bundle-app-content{min-width:0;flex:1}\n.bundle-app-head{display:flex;align-items:flex-start;justify-content:space-between;gap:10px}\n.bundle-app-title{font-size:15px;font-weight:900;line-height:1.25;letter-spacing:.1px}\n.bundle-app-subtitle{font-size:12px;opacity:.95;margin-top:6px;line-height:1.35}\n.bundle-app-label{font-size:12px;font-weight:900;line-height:1;white-space:nowrap;border-radius:999px;padding:7px 10px}\n.bundle-app-label-sub{font-size:12px;opacity:.92;margin-top:8px;line-height:1.35}\n.bundle-app-btn{border-radius:14px;padding:11px 12px;font-size:13px;font-weight:900;color:inherit;white-space:nowrap}\n.bundle-app-choice{min-width:0;flex:1}\n.bundle-app-checkwrap{position:relative;display:flex;align-items:center;justify-content:center;flex:0 0 auto}\n.bundle-app-check{position:absolute;opacity:0;width:22px;height:22px;cursor:pointer;margin:0;inset:0}\n.bundle-app-checkmark{width:22px;height:22px;border-radius:7px;border:2px solid rgba(255,255,255,.86);background:rgba(255,255,255,.14);display:flex;align-items:center;justify-content:center;box-sizing:border-box}\n.bundle-app-check:checked + .bundle-app-checkmark{background:#fff;border-color:#fff}\n.bundle-app-check:checked + .bundle-app-checkmark:after{content:\"\";width:7px;height:12px;border:3px solid #0f172a;border-top:0;border-left:0;transform:rotate(45deg);margin-top:-1px}\n.bundle-app-tiers{margin-top:12px;display:flex;flex-direction:column;gap:8px}\n.bundle-app-tier{display:flex;justify-content:space-between;align-items:flex-start;gap:10px;background:rgba(255,255,255,.14);border-radius:14px;padding:9px 10px;font-size:12px;line-height:1.25;cursor:pointer;user-select:none;transition:background .12s ease,transform .12s ease;color:inherit}\n.bundle-app-tier:hover{background:rgba(255,255,255,.2)}\n.bundle-app-tier--selected{background:rgba(255,255,255,.26);outline:2px solid rgba(255,255,255,.65)}\n.bundle-app-tier:active{transform:scale(.99)}\n.bundle-app-tier strong{font-weight:900}\n.bundle-app-pickers{margin-top:12px;padding:12px;background:rgba(255,255,255,.14);border-radius:14px}\n.bundle-app-pickers--inline{margin-top:0}\n.bundle-app-tier-main{min-width:0;flex:1}\n.bundle-app-tier-checkwrap{margin-top:1px}\n.bundle-app-picker-hint{font-size:12px;opacity:.95;line-height:1.35}\n.bundle-app-announcement{position:sticky;top:0;z-index:100000;box-sizing:border-box;width:100%;display:flex;align-items:center;justify-content:center;padding:10px 44px;background:#0f172a;color:#fff;border-bottom:1px solid rgba(255,255,255,.12);text-align:center;border-radius:var(--bundle-app-announcement-radius,0px)}\n.bundle-app-announcement.is-not-sticky{position:relative}\n.bundle-app-announcement.is-not-selectable{user-select:none;-webkit-user-select:none}\n.bundle-app-announcement.is-skewed{transform:skewX(var(--bundle-app-announcement-skew,0deg));transform-origin:center}\n.bundle-app-announcement__layout{display:flex;align-items:center;justify-content:center;gap:12px;width:100%;min-width:0}\n.bundle-app-announcement.is-skewed .bundle-app-announcement__layout{transform:skewX(calc(-1 * var(--bundle-app-announcement-skew,0deg)))}\n.bundle-app-announcement__inner{display:flex;align-items:center;justify-content:center!important;gap:10px;flex-wrap:wrap;text-align:center!important;min-width:0}\n.bundle-app-announcement.is-marquee{overflow:hidden}\n.bundle-app-announcement__marquee{overflow:hidden;min-width:0;max-width:100%}\n.bundle-app-announcement__track{display:flex;align-items:center;width:max-content;gap:var(--bundle-app-announcement-marquee-gap,48px);will-change:transform;animation:bundle-app-announcement-marquee var(--bundle-app-announcement-marquee-duration,8s) linear infinite}\n.bundle-app-announcement.is-marquee-sweep .bundle-app-announcement__track{animation-name:bundle-app-announcement-marquee-sweep}\n.bundle-app-announcement.is-ar .bundle-app-announcement__track{animation-direction:reverse}\n.bundle-app-announcement.is-marquee-sweep.is-ar .bundle-app-announcement__track{animation-direction:normal}\n.bundle-app-announcement.is-marquee:hover .bundle-app-announcement__track{animation-play-state:paused}\n.bundle-app-announcement__segment{display:inline-flex;align-items:center;gap:10px;white-space:nowrap}\n.bundle-app-announcement__cta{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;background:var(--bundle-app-announcement-accent,#38bdf8);color:#0b1220;font-size:12px;font-weight:900;text-decoration:none;white-space:nowrap;border:1px solid rgba(255,255,255,.18);box-shadow:0 12px 28px rgba(0,0,0,.22);transform:translateY(0);transition:transform .12s ease,filter .12s ease,opacity .12s ease}\n.bundle-app-announcement__cta:hover{filter:brightness(1.06)}\n.bundle-app-announcement__cta:active{transform:translateY(1px)}\n.bundle-app-announcement__cta.is-cta-outline{background:transparent;color:inherit;border:2px solid rgba(255,255,255,.45);box-shadow:none}\n.bundle-app-announcement__cta.is-cta-pulse{animation:bundle-app-announcement-cta-pulse 1.4s ease-in-out infinite}\n.bundle-app-announcement__cta.is-cta-bounce{animation:bundle-app-announcement-cta-bounce 1.2s ease-in-out infinite}\n.bundle-app-announcement__title{font-weight:900;font-size:13px;line-height:1.2}\n.bundle-app-announcement__message{font-weight:700;font-size:13px;line-height:1.2;opacity:.96}\n.bundle-app-announcement__link{font-weight:900;font-size:13px;line-height:1.2;color:var(--bundle-app-announcement-link,#38bdf8);text-decoration:underline}\n.bundle-app-announcement__close{position:absolute;right:10px;top:50%;transform:translateY(-50%);border:0;background:transparent;color:inherit;font-size:18px;line-height:1;cursor:pointer;opacity:.9}\n.bundle-app-announcement.is-rtl .bundle-app-announcement__close{left:10px;right:auto}\n.bundle-app-announcement__close:hover{opacity:1}\n@keyframes bundle-app-announcement-marquee{0%{transform:translateX(0)}100%{transform:translateX(calc(-1 * var(--bundle-app-announcement-marquee-distance,300px)))}}\n@keyframes bundle-app-announcement-marquee-sweep{0%{transform:translateX(0)}100%{transform:translateX(var(--bundle-app-announcement-marquee-sweep-to,-300px))}}\n@keyframes bundle-app-announcement-cta-pulse{0%,100%{transform:translateY(0) scale(1)}50%{transform:translateY(0) scale(1.04)}}\n@keyframes bundle-app-announcement-cta-bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-2px)}}\n@keyframes bundle-app-announcement-enter-slide{0%{opacity:0;transform:translateY(-10px)}100%{opacity:1;transform:translateY(0)}}\n@keyframes bundle-app-announcement-enter-fade{0%{opacity:0}100%{opacity:1}}\n@keyframes bundle-app-announcement-enter-pop{0%{opacity:0;transform:scale(.98)}100%{opacity:1;transform:scale(1)}}\n.bundle-app-announcement.is-enter-slide{animation:bundle-app-announcement-enter-slide .26s ease-out both}\n.bundle-app-announcement.is-enter-fade{animation:bundle-app-announcement-enter-fade .22s ease-out both}\n.bundle-app-announcement.is-enter-pop{animation:bundle-app-announcement-enter-pop .22s ease-out both}\n@media (prefers-reduced-motion:reduce){.bundle-app-announcement__track{animation:none;transform:none}}\n.bundle-app-products{margin-top:12px;display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}\n.bundle-app-product{background:rgba(255,255,255,.14);border-radius:14px;overflow:hidden;display:flex;flex-direction:column;min-width:0}\n.bundle-app-product__media{position:relative;width:100%;aspect-ratio:1 / 1;background:rgba(0,0,0,.08);overflow:hidden}\n.bundle-app-product__img{width:100%;height:100%;object-fit:cover;display:block}\n.bundle-app-product__body{padding:10px;display:flex;flex-direction:column;gap:8px;min-width:0}\n.bundle-app-product__top{display:flex;align-items:flex-start;justify-content:space-between;gap:10px}\n.bundle-app-product__name{font-size:12px;font-weight:900;line-height:1.3;min-width:0}\n.bundle-app-product__attrs{font-size:12px;opacity:.95;line-height:1.3}\n.bundle-app-product__price{font-size:12px;font-weight:900;line-height:1.2;display:flex;gap:8px;flex-wrap:wrap;align-items:baseline}\n.bundle-app-product__price-old{text-decoration:line-through;opacity:.85;font-weight:800}\n.bundle-app-product__checkwrap{position:relative;display:flex;align-items:center;justify-content:center;flex:0 0 auto}\n.bundle-app-product__check{position:absolute;opacity:0;width:22px;height:22px;cursor:pointer;margin:0;inset:0}\n.bundle-app-product__checkmark{width:22px;height:22px;border-radius:7px;border:2px solid rgba(255,255,255,.86);background:rgba(255,255,255,.14);display:flex;align-items:center;justify-content:center;box-sizing:border-box}\n.bundle-app-product__check:checked + .bundle-app-product__checkmark{background:#fff;border-color:#fff}\n.bundle-app-product__check:checked + .bundle-app-product__checkmark:after{content:\"\";width:7px;height:12px;border:3px solid #0f172a;border-top:0;border-left:0;transform:rotate(45deg);margin-top:-1px}\n.bundle-app-bottomsheet{position:fixed;inset:0;z-index:100001;display:flex;align-items:flex-end;justify-content:center;background:rgba(0,0,0,.45);padding:10px}\n.bundle-app-bottomsheet__panel{width:min(560px,100%);max-height:85vh;background:#fff;border-radius:18px 18px 12px 12px;box-shadow:0 18px 60px rgba(0,0,0,.3);overflow:auto}\n.bundle-app-bottomsheet__head{padding:14px 14px 10px;display:flex;align-items:flex-start;justify-content:space-between;gap:10px}\n.bundle-app-bottomsheet__title{font-size:15px;font-weight:950;line-height:1.2;color:#0b1220}\n.bundle-app-bottomsheet__sub{margin-top:6px;font-size:12px;opacity:.85;line-height:1.35;color:#0b1220}\n.bundle-app-bottomsheet__close{border:0;background:transparent;font-size:22px;line-height:1;cursor:pointer;color:#0b1220;opacity:.8}\n.bundle-app-bottomsheet__content{padding:0 14px 12px}\n.bundle-app-bottomsheet__cta{display:flex;gap:10px;padding:12px 14px 14px}\n.bundle-app-bottomsheet__btn{border:0;border-radius:14px;padding:12px 12px;font-size:13px;font-weight:950;cursor:pointer}\n.bundle-app-bottomsheet__btn-primary{background:#0ea5e9;color:#0b1220;flex:1}\n.bundle-app-bottomsheet__btn-secondary{background:rgba(2,6,23,.08);color:#0b1220}\n.bundle-app-bottomsheet__btn:disabled{opacity:.55;cursor:not-allowed}\n.bundle-app-bottomsheet__msg{margin-top:10px;font-size:12px;line-height:1.35;color:#0b1220;opacity:.85}\n.bundle-app-bottomsheet__hero{border-radius:14px;overflow:hidden;background:rgba(2,6,23,.06);margin-bottom:10px}\n.bundle-app-bottomsheet__heroimg{width:100%;height:auto;display:block;object-fit:cover}\n.bundle-app-bottomsheet__hero-title{padding:10px 10px 0;font-size:13px;font-weight:950;color:#0b1220}\n.bundle-app-bottomsheet__hero-price{padding:6px 10px 10px;font-size:12px;font-weight:950;color:#0b1220;display:flex;gap:8px;flex-wrap:wrap;align-items:baseline}\n.bundle-app-bottomsheet__hero-old{text-decoration:line-through;opacity:.65;font-weight:850}\n@media (max-width:480px){.bundle-app-row{flex-direction:column;align-items:stretch}.bundle-app-btn{width:100%;white-space:normal}.bundle-app-checkwrap{align-self:flex-start}.bundle-app-products{grid-template-columns:1fr}}\n";var __bundleAppCssPickers=".bundle-app-pickers{margin-top:12px;display:none;background:rgba(255,255,255,.14);border-radius:14px;padding:10px}\n.bundle-app-card--selected .bundle-app-pickers{display:block}\n.bundle-app-pickers-title{font-weight:900;font-size:12px;margin-bottom:8px}\n.bundle-app-picker-row{display:flex;flex-direction:column;gap:8px;margin-bottom:10px}\n.bundle-app-picker-label{font-weight:900;font-size:12px}\n.bundle-app-picker-hint{font-size:12px;opacity:.95}\n.bundle-app-picker-status{font-size:12px;opacity:.95;margin-top:6px}\n.bundle-app-variant-options{display:flex;flex-wrap:wrap;gap:8px}\n.bundle-app-variant-btn{appearance:none;border:1px solid rgba(255,255,255,.55);background:rgba(255,255,255,.14);color:inherit;border-radius:999px;padding:8px 10px;font-size:12px;font-weight:900;cursor:pointer;line-height:1;display:inline-flex;align-items:center;gap:8px}\n.bundle-app-variant-btn.is-selected{background:rgba(255,255,255,.95);color:#111827;border-color:rgba(255,255,255,.95)}\n.bundle-app-variant-btn:disabled{opacity:.75;cursor:not-allowed}\n.bundle-app-variant-swatch{width:14px;height:14px;border-radius:999px;flex:0 0 14px;border:1px solid rgba(255,255,255,.75);background:rgba(255,255,255,.25)}\n.bundle-app-variant-swatch.is-image{background-size:cover;background-position:center}\n.bundle-app-variant-text{line-height:1.15}\n@media (max-width:480px){.bundle-app-variant-btn{width:100%;justify-content:flex-start}}\n";function __bundleAppInjectStyle(id,css){try{if(!css)return;if(document.getElementById(id))return;var s=document.createElement("style");s.id=id;s.textContent=String(css||"");document.head.appendChild(s)}catch(e){}}function ensurePickerStyles(){try{if(g.BundleAppUi&&typeof g.BundleAppUi.ensurePickerStyles==="function"){g.BundleAppUi.ensurePickerStyles();return}}catch(e){}__bundleAppInjectStyle("bundle-app-pickers-style",__bundleAppCssPickers)}function ensureStyles(){__bundleAppInjectStyle("bundle-app-style",__bundleAppCssBase)}(function(){var g=null;try{g=globalThis}catch(e){g=window}if(!g)g=window;g.BundleApp=g.BundleApp||{};var merchantId="678592212";var token="eyJtZXJjaGFudElkIjoiNjc4NTkyMjEyIiwiaWF0IjoxNzY3MDE4MzU3NTA5LCJub25jZSI6ImY2M2Q0ZDE0OWM3OSJ9.b665eeb6de7a71b87a3d1c2717bc6efdca44cbeaf00eb3bba85a0a0ebce38a6c";var scriptSrc=(document.currentScript&&document.currentScript.src)||"";if(!scriptSrc){try{var ss=document.getElementsByTagName("script");for(var si=0;si<ss.length;si++){var s=ss[si];var src=(s&&s.src)||"";if(!src)continue;if(src.indexOf("/api/storefront/snippet.js")!==-1&&src.indexOf("merchantId="+encodeURIComponent(merchantId))!==-1){scriptSrc=src;break}}}catch(e){}}try{if(typeof ensureStyles==="function")ensureStyles()}catch(e){}var debug=false;try{debug=new URL(scriptSrc).searchParams.get("debug")==="1"}catch(e){}function warn(){if(!debug)return;try{console.warn.apply(console,arguments)}catch(e){}}function getBackendOrigin(){try{return new URL(scriptSrc).origin}catch(e){return""}}function buildUrl(path,params){var origin=getBackendOrigin();if(!origin)return null;var u=new URL(origin+path);for(var k in (params||{})){if(!Object.prototype.hasOwnProperty.call(params,k))continue;var v=params[k];if(v==null||v==="")continue;u.searchParams.set(k,String(v))}u.searchParams.set("merchantId",merchantId);u.searchParams.set("token",token);return u.toString()}async function fetchJson(url){var r=await fetch(url);var t=await r.text();var j=null;try{j=t?JSON.parse(t):null}catch(e){throw new Error("Invalid JSON response")}if(!r.ok){var msg=(j&&j.message)||("HTTP "+r.status);var err=new Error(msg);err.status=r.status;err.details=j;throw err}return j}function escHtml(input){var s=String(input==null?"":input);return s.replace(/[&<>"']/g,function(ch){return ch==="&"?"&amp;":ch==="<"?"&lt;":ch===">"?"&gt;":ch==='"'?"&quot;":"&#39;"})}function isCartLikePage(){try{var p=String(window.location.pathname||"").toLowerCase();return p.indexOf('cart')!==-1||p.indexOf('checkout')!==-1}catch(e){return false}}function dismissKey(bannerId){return "bundle_app_announcement_dismissed:"+String(merchantId||"")+":"+String(bannerId||"")}function isDismissed(banner){try{if(!banner||!banner.id)return false;var raw=localStorage.getItem(dismissKey(banner.id));if(!raw)return false;var j=null;try{j=JSON.parse(raw)}catch(e){j=null}if(j&&typeof j==='object'){var until=Number(j.until||0);if(Number.isFinite(until)&&until>Date.now())return true;var forever=Boolean(j.forever);if(forever)return true}return raw==="1"}catch(e){return false}}function setDismissed(banner){try{if(!banner||!banner.id)return;var ttl=Number(banner.dismissTtlHours);if(!Number.isFinite(ttl)||ttl<0)ttl=72;var rec=null;if(ttl===0){rec={forever:true}}else{rec={until:Date.now()+ttl*60*60*1000}}localStorage.setItem(dismissKey(banner.id),JSON.stringify(rec))}catch(e){}}function removeBanner(){try{var el=document.getElementById('bundle-app-announcement');if(el)el.remove()}catch(e){}}function pageLang(){try{var el=document&&document.documentElement;var b=document&&document.body;var l=(el&&el.getAttribute&&el.getAttribute('lang'))||(b&&b.getAttribute&&b.getAttribute('lang'))||'';return String(l||'').toLowerCase()}catch(e){return ''}}function isArabic(){try{var l=pageLang();if(l&&l.indexOf('ar')===0)return true;var nl=String((navigator&&navigator.language)||'').toLowerCase();return nl&&nl.indexOf('ar')===0}catch(e){return false}}function isRtl(){try{var d=(document&&document.documentElement&&document.documentElement.dir)||'';if(d&&String(d).toLowerCase()==='rtl')return true;var bd=(document&&document.body&&document.body.dir)||'';if(bd&&String(bd).toLowerCase()==='rtl')return true;var cs=window.getComputedStyle?window.getComputedStyle(document.body||document.documentElement):null;var dir=cs&&cs.direction?String(cs.direction).toLowerCase():'';if(dir==='rtl')return true;return isArabic()}catch(e){return false}}function clampNum(n,min,max,def){var x=Number(n);if(!Number.isFinite(x))return def;return Math.max(min,Math.min(max,x))}function safeHref(href){try{var s=String(href||'').trim();if(!s)return null;if(s.indexOf('/')===0)return s;var u=new URL(s,window.location.origin);if(u.protocol==='http:'||u.protocol==='https:')return u.toString();return null}catch(e){return null}}function segmentHtml(b){var title=b&&b.title?String(b.title):'';var msg=b&&b.message?String(b.message):'';var linkUrl=b&&b.linkUrl?String(b.linkUrl):'';var linkText=b&&b.linkText?String(b.linkText):'';var out='';if(title)out+='<strong class="bundle-app-announcement__title">'+escHtml(title)+'</strong>';if(msg)out+='<span class="bundle-app-announcement__message">'+escHtml(msg)+'</span>';if(linkUrl&&linkText)out+='<a class="bundle-app-announcement__link" href="'+escHtml(linkUrl)+'" rel="noopener noreferrer" target="_blank">'+escHtml(linkText)+'</a>';return out}function setupMarquee(el,banner){try{if(!(banner&&banner.motionEnabled===true))return;var marquee=el.querySelector('.bundle-app-announcement__marquee');var track=el.querySelector('.bundle-app-announcement__track');if(!marquee||!track||!track.children||!track.children.length)return;var seg=track.children[0];var segRect=seg.getBoundingClientRect();var contRect=marquee.getBoundingClientRect();if(!segRect||!contRect)return;var segW=Number(segRect.width||0);var contW=Number(contRect.width||0);if(!(segW>0&&contW>0))return;var cs=window.getComputedStyle?window.getComputedStyle(track):null;var gapRaw=cs&&(cs.columnGap||cs.gap)?String(cs.columnGap||cs.gap):'';var gap=parseFloat(gapRaw||'0');if(!Number.isFinite(gap))gap=0;var dur=clampNum(banner&&banner.motionDurationSec,1,20,8);el.style.setProperty('--bundle-app-announcement-marquee-duration',String(dur)+'s');var sweep=segW<contW;if(sweep){try{if(el&&el.classList)el.classList.add('is-marquee-sweep')}catch(e2){}try{while(track.children&&track.children.length>1){track.removeChild(track.lastChild)}}catch(e3){}var dist=contW+segW+gap;var sign=-1;try{if(el&&el.classList&&el.classList.contains('is-ar'))sign=1}catch(e4){}el.style.setProperty('--bundle-app-announcement-marquee-sweep-to',String(dist*sign)+'px');return}try{if(el&&el.classList)el.classList.remove('is-marquee-sweep')}catch(e5){}var minWidth=contW+segW+gap;while(track.scrollWidth<minWidth){var clone=seg.cloneNode(true);try{clone.setAttribute('aria-hidden','true')}catch(e0){}track.appendChild(clone)}var dist2=segW+gap;el.style.setProperty('--bundle-app-announcement-marquee-distance',String(dist2)+'px')}catch(e){}}function mountBannerEl(banner){var el=document.getElementById('bundle-app-announcement');if(!el){el=document.createElement('div');el.id='bundle-app-announcement'}var rtl=isRtl();var ar=isArabic();var marquee=Boolean(banner&&banner.motionEnabled===true);var radius=clampNum(banner&&banner.shapeRadiusPx,0,40,0);var skew=clampNum(banner&&banner.shapeSkewDeg,-12,12,0);var enter=String((banner&&banner.enterAnimation)||'none');var ctaEnabled=Boolean(banner&&banner.ctaEnabled===true);var ctaText=banner&&banner.ctaText!=null?String(banner.ctaText):'';var ctaHref=safeHref(banner&&banner.ctaHref);var ctaVariant=String((banner&&banner.ctaVariant)||'solid');var ctaAnim=String((banner&&banner.ctaAnimation)||'none');var cls='bundle-app-announcement'+(banner&&banner.sticky===false?' is-not-sticky':'')+(rtl?' is-rtl':'')+(ar?' is-ar':'')+(banner&&banner.selectable===false?' is-not-selectable':'')+(marquee?' is-marquee':'')+(Math.abs(skew)>0.01?' is-skewed':'')+(enter&&enter!=='none'?' is-enter-'+enter:'');el.className=cls;var bg=banner&&banner.backgroundColor?String(banner.backgroundColor):'';var tc=banner&&banner.textColor?String(banner.textColor):'';var lc=banner&&banner.linkColor?String(banner.linkColor):'';var ac=banner&&banner.accentColor?String(banner.accentColor):'';var ff=banner&&banner.fontFamily!=null?String(banner.fontFamily):'';el.style.background=bg||'';el.style.color=tc||'';el.style.setProperty('--bundle-app-announcement-link',lc||'');el.style.setProperty('--bundle-app-announcement-accent',ac||'');el.style.setProperty('--bundle-app-announcement-radius',String(radius)+'px');el.style.setProperty('--bundle-app-announcement-skew',String(skew)+'deg');if(ff&&ff.trim()){el.style.fontFamily=ff.trim()}else{try{el.style.removeProperty('font-family')}catch(e1){}}var seg=segmentHtml(banner);var html='<div class="bundle-app-announcement__layout">';if(marquee){html+='<div class="bundle-app-announcement__marquee"><div class="bundle-app-announcement__track">';html+='<div class="bundle-app-announcement__segment">'+seg+'</div>';html+='<div class="bundle-app-announcement__segment" aria-hidden="true">'+seg+'</div>';html+='</div></div>'}else{html+='<div class="bundle-app-announcement__inner">'+seg+'</div>'}if(ctaEnabled&&ctaHref&&ctaText&&ctaText.trim()){var ccls='bundle-app-announcement__cta'+(ctaVariant==='outline'?' is-cta-outline':'')+(ctaAnim&&ctaAnim!=='none'?' is-cta-'+ctaAnim:'');html+='<a class="'+ccls+'" href="'+escHtml(ctaHref)+'" rel="noopener noreferrer">'+escHtml(ctaText)+'</a>'}html+='</div>';if(banner&&banner.dismissible!==false){html+='<button class="bundle-app-announcement__close" type="button" aria-label="إغلاق">×</button>'}el.innerHTML=html;el.onclick=function(e){try{var t=e&&e.target;if(!t)return;if(t.classList&&t.classList.contains('bundle-app-announcement__close')){setDismissed(banner);removeBanner()}}catch(x){}};return el}async function loadAndRender(){try{var page=isCartLikePage()?'cart':'all';var u=buildUrl('/api/proxy/announcement-banner',{page:page});if(!u)return;var res=await fetchJson(u);var banner=res&&res.banner?res.banner:null;if(!banner||String(banner.status||'')!=='active'){removeBanner();return}if(String(banner.showOn||'all')==='cart'&&!isCartLikePage()){removeBanner();return}if(isDismissed(banner)){removeBanner();return}var el=mountBannerEl(banner);if(document.body){if(!el.parentNode){document.body.insertBefore(el,document.body.firstChild)}else if(el.parentNode!==document.body){try{el.parentNode.removeChild(el)}catch(e0){}document.body.insertBefore(el,document.body.firstChild)}if(banner&&banner.motionEnabled===true){try{requestAnimationFrame(function(){setupMarquee(el,banner)})}catch(e1){setTimeout(function(){setupMarquee(el,banner)},0)}}}}catch(e){warn('announcement-banner: failed',e&&((e.details)||e.message||e))}}function initOnce(){var inited=false;function start(){if(inited)return;inited=true;loadAndRender()}if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',start)}else{start()}}initOnce();})();